"use strict";(self.webpackChunkseata_website=self.webpackChunkseata_website||[]).push([[93247],{16181:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>s,toc:()=>l});var r=t(74848),a=t(28453);const o={title:"Integrating Seata Distributed Transaction with SpringBoot+Dubbo+MybatisPlus",keywords:["Seata","dubbo","mybatis","distributed transaction"],description:"This article explains how to build the integration of Seata with SpringBoot+Dubbo+MybatisPlus using the direct connection approach.",author:"FUNKYE",date:"2019/11/29"},i="SpringBoot+Dubbo+MybatisPlus integration Seata distributed transactions",s={permalink:"/blog/springboot-dubbo-mybatisplus-seata",editUrl:"https://github.com/apache/incubator-seata-website/blob/docusaurus/i18n/en/docusaurus-plugin-content-blog/springboot-dubbo-mybatisplus-seata.md",source:"@site/i18n/en/docusaurus-plugin-content-blog/springboot-dubbo-mybatisplus-seata.md",title:"Integrating Seata Distributed Transaction with SpringBoot+Dubbo+MybatisPlus",description:"This article explains how to build the integration of Seata with SpringBoot+Dubbo+MybatisPlus using the direct connection approach.",date:"2019-11-29T00:00:00.000Z",formattedDate:"November 29, 2019",tags:[],readingTime:20.835,hasTruncateMarker:!1,authors:[{name:"FUNKYE"}],frontMatter:{title:"Integrating Seata Distributed Transaction with SpringBoot+Dubbo+MybatisPlus",keywords:["Seata","dubbo","mybatis","distributed transaction"],description:"This article explains how to build the integration of Seata with SpringBoot+Dubbo+MybatisPlus using the direct connection approach.",author:"FUNKYE",date:"2019/11/29"},unlisted:!1,prevItem:{title:"Resolving the Issue of Losing Mybatis-Plus Features in Seata AT Mode Integration through Source Code",permalink:"/blog/seata-mybatisplus-analysis"},nextItem:{title:"Does Seata Client Need to Start RM and TM Simultaneously?",permalink:"/blog/seata-at-mode-start-rm-tm"}},c={authorsImageUrls:[void 0]},l=[{value:"Build the library and table",id:"build-the-library-and-table",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://gitee.com/itCjb/springboot-dubbo-mybatisplus-seata",children:"Project address"})}),"\n",(0,r.jsx)(n.p,{children:"This article was written by FUNKYE (Chen Jianbin), Hangzhou, an Internet company main program."}),"\n",(0,r.jsx)(n.h1,{id:"preface",children:"Preface"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Transaction"}),": Transaction is a reliable independent unit of work composed of a set of operations, the transaction has the characteristics of ACID, namely atomicity, consistency, isolation and persistence.\n",(0,r.jsx)(n.strong,{children:"Distributed Transaction"}),": When an operation involves multiple services, multiple databases to collaborate on the completion (such as sub-tables and libraries, business split), multiple services, the local Transaction has been unable to cope with this situation , in order to ensure data consistency, you need to use distributed transactions.\n",(0,r.jsx)(n.strong,{children:"Seata"})," : is an open source distributed transaction solution , is committed to providing high performance and ease of use in the microservices architecture of distributed transaction services .\n",(0,r.jsx)(n.strong,{children:"Purpose of this article"})," : Nowadays, microservices are becoming more and more popular , and the market can be described as a number of distributed transaction solutions , uneven , more popular to MQ on behalf of the guarantee is the ultimate consistency of the message solution ( consumption confirmation , message lookback , message compensation mechanism , etc.) , and TX-LCN LCN mode to coordinate local transactions to ensure that the transaction unified commit or rollback (has stopped updating , incompatible with Dubbo2.7). MQ's distributed transactions are too complex, TX-LCN break more, this time the need for an efficient and reliable and easy to get started with the distributed transaction solution, Seata stands out, this article is to introduce how to quickly build a Demo project to integrate Seata, together!"]}),"\n",(0,r.jsx)(n.h1,{id:"preparation",children:"Preparation"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"First of all, install mysql, eclipse and other commonly used tools, which does not expand."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["visit the seata download centre ",(0,r.jsx)(n.a,{href:"/download/seata-server",children:"address"})," we use version 0.9.0"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Download and unzip seata-server."}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"build-the-library-and-table",children:"Build the library and table"}),"\n",(0,r.jsx)(n.p,{children:"1.first we link mysql to create a database named seata, and then run the table building sql, this in the seata-server conf folder db_store.sql is what I need to use the sql."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-mysql",children:"/*\nNavicat MySQL Data Transfer\nSource Server : mysql\nSource Server Version : 50721\nSource Host : localhost:3306\nSource Database : seata\nTarget Server Type : MYSQL\nTarget Server Version : 50721\nFile Encoding : 65001\nDate: 2019-11-23 22:03:18\n*/\n\nSET FOREIGN_KEY_CHECKS=0;\n\n-- ----------------------------\n\n-- Table structure for branch_table\n\n-- ----------------------------\n\nDROP TABLE IF EXISTS `branch_table`;\nCREATE TABLE `branch_table` (\n `branch_id` bigint(20) NOT NULL, `xid` varchar\n `xid` varchar(128) NOT NULL, `transaction_id` bigint(20)\n `transaction_id` bigint(20) DEFAULT NULL, `resource_group_id\n `resource_group_id` varchar(32) DEFAULT NULL, `resource_id` varchar(32)\n `resource_id` varchar(256) DEFAULT NULL, `lock_key` varchar(256)\n `lock_key` varchar(128) DEFAULT NULL,\n `branch_type` varchar(8) DEFAULT NULL, `status` tinyint(8)\n `status` tinyint(4) DEFAULT NULL,\n `client_id` varchar(64) DEFAULT NULL, `application_data` tinyint(4)\n `application_data` varchar(2000) DEFAULT NULL, `gmt_create` tinyint(4) DEFAULT NULL, `gmt_create\n `gmt_create` datetime DEFAULT NULL,\n `gmt_modified` datetime DEFAULT NULL, `gmt_modified` datetime\n PRIMARY KEY (`branch_id`),\n KEY `idx_xid` (`xid`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- ----------------------------\n\n-- Records of branch_table\n\n-- ----------------------------\n\n-- ----------------------------\n\n-- Table structure for global_table\n\n-- ----------------------------\n\nDROP TABLE IF EXISTS `global_table`;\nCREATE TABLE `global_table` (\n `xid` varchar(128) NOT NULL, `transaction_id` varchar(128)\n `transaction_id` bigint(20) DEFAULT NULL, `status` tinyint(20)\n `status` tinyint(4) NOT NULL, `application_id` varchar(4)\n `application_id` varchar(32) DEFAULT NULL, `transaction_service` bigint(20)\n `transaction_service_group` varchar(32) DEFAULT NULL,\n `transaction_name` varchar(128) DEFAULT NULL, `timeout` int(11.0)\n `timeout` int(11) DEFAULT NULL, `begin_time` big\n `begin_time` bigint(20) DEFAULT NULL, `application_data` int(11)\n `application_data` varchar(2000) DEFAULT NULL, `gmt_create` bigint(20)\n `gmt_create` datetime DEFAULT NULL, `gmt_modify` datetime\n `gmt_modified` datetime DEFAULT NULL, `gmt_modified` datetime\n PRIMARY KEY (`xid`),\n KEY `idx_gmt_modified_status` (`gmt_modified`, `status`), KEY `idx_tmt_status\n KEY `idx_transaction_id` (`transaction_id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- ----------------------------\n\n-- Records of global_table\n\n-- ----------------------------\n\n-- ----------------------------\n\n-- Table structure for lock_table\n\n-- ----------------------------\n\nDROP TABLE IF EXISTS `lock_table`;\nCREATE TABLE `lock_table` (\n `row_key` varchar(128) NOT NULL, `xid` varchar(128)\n `xid` varchar(96) DEFAULT NULL,\n `transaction_id` mediumtext, `branch_id` mediumtext, `transaction_id` mediumtext\n `branch_id` mediumtext,\n `resource_id` varchar(256) DEFAULT NULL, `table_name` varchar(256)\n `table_name` varchar(32) DEFAULT NULL,\n `pk` varchar(36) DEFAULT NULL, `gmt_create\n `gmt_create` datetime DEFAULT NULL,\n `gmt_modified` datetime DEFAULT NULL, `gmt_modified` datetime\n PRIMARY KEY (`row_key`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n-- ----------------------------\n\n-- Records of lock_table\n\n-- ----------------------------\n\n-- ----------------------------\n\n-- Table structure for undo_log\n\n-- ----------------------------\n\nDROP TABLE IF EXISTS `undo_log`;\nCREATE TABLE `undo_log` (\n `id` bigint(20) NOT NULL AUTO_INCREMENT, `branch_id` bigint(20)\n `branch_id` bigint(20) NOT NULL, `xid` varchar\n `xid` varchar(100) NOT NULL,\n `context` varchar(128) NOT NULL, `rollback_info` bigint(20)\n `rollback_info` longblob NOT NULL, `log_status` int\n `log_status` int(11) NOT NULL, `log_created` datasheet\n `log_created` datetime NOT NULL, `log_modified` longblob NOT NULL, `log_status` int(11)\n `log_modified` datetime NOT NULL,\n `ext` varchar(100) DEFAULT NULL,\n PRIMARY KEY (`id`),\n UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n\n-- ----------------------------\n\n-- Records of undo_log\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsx)(n.li,{children:"After running the database needed for the above seata, we build the library we need to write the demo, create a database named test, and then execute the following sql code."}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-mysql",children:"/*\nNavicat MySQL Data Transfer\nSource Server : mysql\nSource Server Version : 50721\nSource Host : localhost:3306\nSource Database : test\nTarget Server Type : MYSQL\nTarget Server Version : 50721\nFile Encoding : 65001\nDate: 2019-11-23 22:03:24\n*/\n\nSET FOREIGN_KEY_CHECKS=0;\n\n-- ----------------------------\n\n-- Table structure for test\n\n-- ----------------------------\n\nDROP TABLE IF EXISTS `test`.\nCREATE TABLE `test` (\n `id` int(11) NOT NULL AUTO_INCREMENT, `one` varchar(255) DEFATE TABLE (\n `one` varchar(255) DEFAULT NULL,\n `two` varchar(255) DEFAULT NULL, `createTime` datetime, `createTime` datetime, `createTime` datetime\n `createTime` datetime DEFAULT NULL, `two` varchar(255) DEFAULT NULL, `createTime` datetime\n PRIMARY KEY (`id`)\n) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8mb4;\n\n-- ----------------------------\n\n-- Records of test\n\n-- ----------------------------\n\nINSERT INTO `test` VALUES ('1', '1', '2', '2019-11-23 16:07:34');\n\n-- ----------------------------\n\n-- Table structure for undo_log\n\n-- ----------------------------\n\nDROP TABLE IF EXISTS `undo_log`;.\nCREATE TABLE `undo_log` (\n `id` bigint(20) NOT NULL AUTO_INCREMENT, `branch_id` bigint(20)\n `branch_id` bigint(20) NOT NULL, `xid` varchar\n `xid` varchar(100) NOT NULL,\n `context` varchar(128) NOT NULL, `rollback_info` bigint(20)\n `rollback_info` longblob NOT NULL, `log_status` int\n `log_status` int(11) NOT NULL, `log_created` datasheet\n `log_created` datetime NOT NULL, `log_modified` longblob NOT NULL, `log_status` int(11)\n `log_modified` datetime NOT NULL,\n `ext` varchar(100) DEFAULT NULL,\n PRIMARY KEY (`id`),\n UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)\n) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8;\n\n-- ----------------------------\n\n-- Records of undo_log\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"3",children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["we find the file inside the seata-server/conf folder and edit it:",(0,r.jsx)(n.img,{alt:"20191129132933",src:t(78482).A+"",width:"860",height:"302"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["again find the db configuration method block, change the method as follows:",(0,r.jsx)(n.img,{src:t(14681).A+"",width:"794",height:"397"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Well, you can go to the bin directory./seata-server.bat run to see the"}),"\n",(0,r.jsx)(n.h1,{id:"create-a-project",children:"Create a project"}),"\n",(0,r.jsx)(n.p,{children:"first of all, we use eclipse, of course, you can also use idea and other tools, please run in detail according to the following steps"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["create a new maven project, and delete the extra folder:",(0,r.jsx)(n.img,{alt:"20191129133354",src:t(94534).A+"",width:"645",height:"553"}),(0,r.jsx)("img",{src:"/img/blog/20191129133441.png",alt:"20191129133441",style:{zoom:"150%"}})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Open the project's pom.xml and add the following dependency."}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"<properties\n<webVersion>3.1</webVersion\n<project.build.sourceEncoding>UTF-8</project.build.sourceEncoding\n<project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding\n<maven.compiler.source>1.8</maven.compiler.source\n<maven.compiler.target>1.8</maven.compiler.target\n<HikariCP.version>3.2.0</HikariCP.version\n<mybatis-plus-boot-starter.version>3.2.0</mybatis-plus-boot-starter.version>\n</properties\n<parent>\n<groupId>org.springframework.boot</groupId>\n<artifactId>spring-boot-starter-parent</artifactId>\n<version>2.1.8.RELEASE</version>.\n</parent\n<dependencies\n<dependency>\n<groupId>org.apache.curator</groupId>\n<artifactId>curator-framework</artifactId\n<version>4.2.0</version>\n</dependency\n<dependency>\n<groupId>org.apache.curator</groupId>\n<artifactId>curator-recipes</artifactId>\n<version>4.2.0</version>.\n</dependency\n<dependency>\n<groupId>org.apache.dubbo</groupId>\n<artifactId>dubbo-spring-boot-starter</artifactId>\n<version>2.7.4.1</version>\n</dependency\n<dependency>\n<groupId>org.apache.commons</groupId>\n<artifactId>commons-lang3</artifactId>\n</dependency\n<dependency>\n<groupId>com.alibaba</groupId\n<artifactId>fastjson</artifactId>\n<version>1.2.60</version>\n</dependency\n<! -- <dependency> <groupId>javax</groupId> <artifactId>javaee-api</artifactId>\n<version>7.0</version> <scope>provided</scope> </dependency> --\x3e\n<dependency>\n<groupId>io.springfox</groupId>\n<artifactId>springfox-swagger2</artifactId>\n<version>2.9.2</version>.\n</dependency\n<dependency>\n<groupId>io.springfox</groupId>\n<artifactId>springfox-swagger-ui</artifactId>\n<version>2.9.2</version>.\n</dependency\n\n       <! -- mybatis-plus begin --\x3e\n       <dependency>\n          <groupId>com.baomidou</groupId>\n          <artifactId>mybatis-plus-boot-starter</artifactId>\n          <version>${mybatis-plus-boot-starter.version}</version>\n       </dependency\n       <! -- mybatis-plus end --\x3e\n       <! -- https://mvnrepository.com/artifact/org.projectlombok/lombok --\x3e\n       <dependency>\n          <groupId>org.projectlombok</groupId>\n          <artifactId>lombok</artifactId>\n          <scope>provided</scope>\n       </dependency\n       <dependency>\n          <groupId>io.seata</groupId>\n          <artifactId>seata-all</artifactId>\n          <version>0.9.0.1</version>\n       </dependency\n       <! -- Zookeeper --\x3e\n       <dependency>\n          <groupId>org.apache.zookeeper</groupId>\n          <artifactId>zookeeper</artifactId>\n          <version>3.4.9</version>\n          <exclusions\n             <exclusion\n                <groupId>org.slf4j</groupId>\n                <artifactId>slf4j-log4j12</artifactId>\n             </exclusion\n          </exclusions\n       </dependency\n       <! -- <dependency> <groupId>com.baomidou</groupId> <artifactId>dynamic-datasource-spring-boot-starter</ artifactId>\n          <version>2.5.4</version> </dependency> --\x3e\n\n       <! -- <dependency> <groupId>com.baomidou</groupId> <artifactId>mybatis-plus-generator</artifactId>\n          <version>3.1.0</version> </dependency> --\x3e\n       <! -- https://mvnrepository.com/artifact/org.freemarker/freemarker --\x3e\n       <dependency>\n          <groupId>org.freemarker</groupId>\n          <artifactId>freemarker</artifactId>\n       </dependency\n       <! -- https://mvnrepository.com/artifact/com.alibaba/druid-spring-boot-starter --\x3e\n       <dependency>\n          <groupId>com.alibaba</groupId>\n          <artifactId>druid-spring-boot-starter</artifactId>\n          <version>1.1.20</version>\n       </dependency\n       <! -- Add this to recognise the log4j2.yml file --\x3e\n       <dependency>\n          <groupId>com.fasterxml.jackson.dataformat</groupId>\n          <artifactId>jackson-dataformat-yaml</artifactId>\n       </dependency\n       <dependency> <! -- Introducing the log4j2 dependency --\x3e\n          <groupId>org.springframework.boot</groupId>\n          <artifactId>spring-boot-starter-log4j2</artifactId>\n       </dependency\n       <! -- https://mvnrepository.com/artifact/mysql/mysql-connector-java --\x3e\n       <dependency>\n          <groupId>mysql</groupId>\n          <artifactId>mysql-connector-java</artifactId>\n       </dependency\n       <dependency>\n          <groupId>org.springframework.boot</groupId>\n          <artifactId>spring-boot-starter-web</artifactId\n          <exclusions\n             <exclusion>\n                <groupId>org.springframework.boot</groupId\n                <artifactId>spring-boot-starter-logging</artifactId>\n             </exclusion\n             <exclusion\n                <groupId>org.slf4j</groupId\n                <artifactId>slf4j-log4j12</artifactId>\n             </exclusion\n          </exclusions\n       </dependency\n       <dependency>\n          <groupId>org.springframework.boot</groupId>\n          <artifactId>spring-boot-starter-aop</artifactId>\n       </dependency\n       <dependency>\n          <groupId>org.springframework.boot</groupId>\n          <artifactId>spring-boot-starter-test</artifactId\n          <scope>test</scope\n       </dependency\n       <! -- <dependency> <groupId>org.scala-lang</groupId> <artifactId>scala-library</artifactId>\n          <version>2.11.0</version> </dependency> --\x3e\n       <dependency>\n          <groupId>org.springframework.boot</groupId>\n          <artifactId>spring-boot-configuration-processor</artifactId>\n          <optional>true</optional\n       </dependency\n    </dependencies\n\n<optional>true</optional> </dependencies>\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"3",children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["and then switch the parent project for pom mode, or pom file, switch to overview , do as shown in the operation:",(0,r.jsx)(n.img,{alt:"20191129134127",src:t(67099).A+"",width:"678",height:"511"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["create our demo sub-project, test-service:",(0,r.jsx)(n.img,{alt:"20191129135935",src:t(69757).A+"",width:"638",height:"550"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"The directory is as follows."}),"\n",(0,r.jsx)("img",{src:"/img/blog/20191129140048.png",alt:"20191129140048",style:{zoom:"200%"}}),"\n",(0,r.jsx)(n.p,{children:"Create EmbeddedZooKeeper.java file, along with ProviderApplication.java, with the following code."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'package org.test;\n\nimport java.io.File;\nimport java.lang.reflect.Method;\nimport java.util.Properties;\nimport java.util.UUID;\n\nimport org.apache.zookeeper.server.ServerConfig;\nimport org.apache.zookeeper.server.ZooKeeperServerMain;\nimport org.apache.zookeeper.server.quorum.QuorumPeerConfig;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.context.SmartLifecycle;\nimport org.springframework.util.ErrorHandler;\nimport org.springframework.util.SocketUtils;\n\n/**\n * from:\n * https://github.com/spring-projects/spring-xd/blob/v1.3.1.RELEASE/spring-xd-dirt/src/main/java/org/springframework/xd/dirt/zookeeper/ZooKeeperUtils.java\n *\n * Helper class to start an embedded instance of standalone (non clustered) ZooKeeper.\n *\n * NOTE: at least an external standalone server (if not an ensemble) are recommended, even for\n * {@link org.springframework.xd.dirt.server.singlenode.SingleNodeApplication}\n *\n * @author Patrick Peralta\n * @author Mark Fisher\n * @author David Turanski\n */\npublic class EmbeddedZooKeeper implements SmartLifecycle {\n\n  /**\n   * Logger.\n   */\n  private static final Logger logger = LoggerFactory.getLogger(EmbeddedZooKeeper.class);\n\n  /**\n   * ZooKeeper client port. This will be determined dynamically upon startup.\n   */\n  private final int clientPort;\n\n  /**\n   * Whether to auto-start. Default is true.\n   */\n  private boolean autoStartup = true;\n\n  /**\n   * Lifecycle phase. Default is 0.\n   */\n  private int phase = 0;\n\n  /**\n   * Thread for running the ZooKeeper server.\n   */\n  private volatile Thread zkServerThread;\n\n  /**\n   * ZooKeeper server.\n   */\n  private volatile ZooKeeperServerMain zkServer;\n\n  /**\n   * {@link ErrorHandler} to be invoked if an Exception is thrown from the ZooKeeper server thread.\n   */\n  private ErrorHandler errorHandler;\n\n  private boolean daemon = true;\n\n  /**\n   * Construct an EmbeddedZooKeeper with a random port.\n   */\n  public EmbeddedZooKeeper() {\n    clientPort = SocketUtils.findAvailableTcpPort();\n  }\n\n  /**\n   * Construct an EmbeddedZooKeeper with the provided port.\n   *\n   * @param clientPort\n   *            port for ZooKeeper server to bind to\n   */\n  public EmbeddedZooKeeper(int clientPort, boolean daemon) {\n    this.clientPort = clientPort;\n    this.daemon = daemon;\n  }\n\n  /**\n   * Returns the port that clients should use to connect to this embedded server.\n   *\n   * @return dynamically determined client port\n   */\n  public int getClientPort() {\n    return this.clientPort;\n  }\n\n  /**\n   * Specify whether to start automatically. Default is true.\n   *\n   * @param autoStartup\n   *            whether to start automatically\n   */\n  public void setAutoStartup(boolean autoStartup) {\n    this.autoStartup = autoStartup;\n  }\n\n  /**\n   * {@inheritDoc}\n   */\n  public boolean isAutoStartup() {\n    return this.autoStartup;\n  }\n\n  /**\n   * Specify the lifecycle phase for the embedded server.\n   *\n   * @param phase\n   *            the lifecycle phase\n   */\n  public void setPhase(int phase) {\n    this.phase = phase;\n  }\n\n  /**\n   * {@inheritDoc}\n   */\n  public int getPhase() {\n    return this.phase;\n  }\n\n  /**\n   * {@inheritDoc}\n   */\n  public boolean isRunning() {\n    return (zkServerThread != null);\n  }\n\n  /**\n   * Start the ZooKeeper server in a background thread.\n   * <p>\n   * Register an error handler via {@link #setErrorHandler} in order to handle any exceptions thrown during startup or\n   * execution.\n   */\n  public synchronized void start() {\n    if (zkServerThread == null) {\n      zkServerThread = new Thread(new ServerRunnable(), "ZooKeeper Server Starter");\n      zkServerThread.setDaemon(daemon);\n      zkServerThread.start();\n    }\n  }\n\n  /**\n   * Shutdown the ZooKeeper server.\n   */\n  public synchronized void stop() {\n    if (zkServerThread != null) {\n      // The shutdown method is protected...thus this hack to invoke it.\n      // This will log an exception on shutdown; see\n      // https://issues.apache.org/jira/browse/ZOOKEEPER-1873 for details.\n      try {\n        Method shutdown = ZooKeeperServerMain.class.getDeclaredMethod("shutdown");\n        shutdown.setAccessible(true);\n        shutdown.invoke(zkServer);\n      }\n\n      catch (Exception e) {\n        throw new RuntimeException(e);\n      }\n\n      // It is expected that the thread will exit after\n      // the server is shutdown; this will block until\n      // the shutdown is complete.\n      try {\n        zkServerThread.join(5000);\n        zkServerThread = null;\n      } catch (InterruptedException e) {\n        Thread.currentThread().interrupt();\n        logger.warn("Interrupted while waiting for embedded ZooKeeper to exit");\n        // abandoning zk thread\n        zkServerThread = null;\n      }\n    }\n  }\n\n  /**\n   * Stop the server if running and invoke the callback when complete.\n   */\n  public void stop(Runnable callback) {\n    stop();\n    callback.run();\n  }\n\n  /**\n   * Provide an {@link ErrorHandler} to be invoked if an Exception is thrown from the ZooKeeper server thread. If none\n   * is provided, only error-level logging will occur.\n   *\n   * @param errorHandler\n   *            the {@link ErrorHandler} to be invoked\n   */\n  public void setErrorHandler(ErrorHandler errorHandler) {\n    this.errorHandler = errorHandler;\n  }\n\n  /**\n   * Runnable implementation that starts the ZooKeeper server.\n   */\n  private class ServerRunnable implements Runnable {\n\n    public void run() {\n      try {\n        Properties properties = new Properties();\n        File file = new File(System.getProperty("java.io.tmpdir") + File.separator + UUID.randomUUID());\n        file.deleteOnExit();\n        properties.setProperty("dataDir", file.getAbsolutePath());\n        properties.setProperty("clientPort", String.valueOf(clientPort));\n\n        QuorumPeerConfig quorumPeerConfig = new QuorumPeerConfig();\n        quorumPeerConfig.parseProperties(properties);\n\n        zkServer = new ZooKeeperServerMain();\n        ServerConfig configuration = new ServerConfig();\n        configuration.readFrom(quorumPeerConfig);\n\n        zkServer.runFromConfig(configuration);\n      } catch (Exception e) {\n        if (errorHandler != null) {\n          errorHandler.handleError(e);\n        } else {\n          logger.error("Exception running embedded ZooKeeper", e);\n        }\n      }\n    }\n  }\n\n}\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'package org.test;\n\nimport org.apache.dubbo.config.spring.context.annotation.DubboComponentScan; import org.apache.dubbo.config.spring.context.annotation.\nimport org.springframework.boot.SpringApplication; import org.springframework.boot.\nimport org.springframework.boot.autoconfigure.SpringBootApplication; import org.springframework.boot.autoconfigure.\nimport org.springframework.context.annotation.ComponentScan; import org.springframework.context.annotation.\nimport org.springframework.transaction.annotation.EnableTransactionManagement; import org.springframework.transaction.annotation.\n\n/**\n* @author cjbc.annotation.EnableTransactionManagement; /**\n* @author cjb\n* @date 2019/10/24\n*/\n@EnableTransactionManagement.\n@ComponentScan(basePackages = {"org.test.config", "org.test.service.impl"})\n@DubboComponentScan(basePackages = "org.test.service.impl")\n@SpringBootApplication\npublic class ProviderApplication {\n\n   public static void main(String[] args) {\n       new EmbeddedZooKeeper(2181, false).start();\n       SpringApplication app = new SpringApplication(ProviderApplication.class);\n       app.run(args);\n   }\n\n}\n\n'})}),"\n",(0,r.jsx)(n.p,{children:"create entity package org.test.entity and the creation of entity class Test used to lombok, details of Baidu, eclipse installed lombok plug-in"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'package org.test.entity;\n\nimport java.io.Serializable;\nimport java.time.LocalDateTime;\n\nimport com.baomidou.mybatisplus.annotation.IdType;\nimport com.baomidou.mybatisplus.annotation.TableField;\nimport com.baomidou.mybatisplus.annotation.TableId;\n\nimport io.swagger.annotations.ApiModel;\nimport io.swagger.annotations.ApiModelProperty;\nimport lombok.Data;\nimport lombok.EqualsAndHashCode;\nimport lombok.experimental.Accessors;\n\n/**\n* <p>\n* Functions\n* </p\n*\n* @author Funkye\n* @since 2019-04-23\n  */\n@Data\n@EqualsAndHashCode(callSuper = false)\n@Accessors(chain = true)\n@ApiModel(value = "test\u5bf9\u8c61", description = "\u529f\u80fd")\npublic class Test implements Serializable {\n\n  private static final long serialVersionUID = 1L;\n\n  @ApiModelProperty(value = "\u4e3b\u952e")\n  @TableId(value = "id", type = IdType.AUTO)\n  private Integer id;\n\n  @ApiModelProperty(value = "one")\n  @TableField("one")\n  private String one;\n\n  @ApiModelProperty(value = "two")\n  @TableField("two")\n  private String two;\n\n  @ApiModelProperty(value = "createTime")\n  @TableField("createTime")\n  private LocalDateTime createTime;\n\n}\n\n'})}),"\n",(0,r.jsx)(n.p,{children:"Create service, service.impl, mapper and other packages, in turn create ITestservice, and the implementation class, mapper."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"package org.test.service;\n\nimport org.test.entity.Test;\n\nimport com.baomidou.mybatisplus.extension.service.IService;\n\n/**\n* <p>\n* Function Service class\n* </p\n*\n* @author Funkye\n* @since 2019-04-10\n  */\n  public interface ITestService extends IService<Test> {\n\n}\n\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'import org.apache.dubbo.config.annotation.Service;\nimport org.test.entity.Test;\nimport org.test.mapper.TestMapper;\nimport org.test.service.ITestService;\n\nimport com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;\n\n@Service(version = "1.0.0",interfaceClass =ITestService.class )\npublic class TestServiceImpl extends ServiceImpl<TestMapper, Test> implements ITestService {\n\n}\n\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:" package org.test.mapper;\n\n import org.test.entity.Test;\n\n import com.baomidou.mybatisplus.core.mapper.BaseMapper;\n\n /**\n * <p>\n * Functional Mapper interface\n * </p>\n *\n * @author Funkye\n * @since 2019-04-10\n */\n public interface TestMapper extends BaseMapper<Test> {\n\n }\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"Create org.test.config package, create SeataAutoConfig.java, configuration information are here, the main role for the proxy data, connect to the transaction service grouping"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'package org.test.config;\n\nimport javax.sql.DataSource;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.beans.factory.annotation.Qualifier;\nimport org.springframework.boot.autoconfigure.jdbc.DataSourceProperties;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.context.annotation.Primary;\n\nimport com.alibaba.druid.pool.DruidDataSource;\n\nimport io.seata.rm.datasource.DataSourceProxy;\nimport io.seata.spring.annotation.GlobalTransactionScanner;\n\n@Configuration\npublic class SeataAutoConfig {\n  @Autowired(required = true)\n  private DataSourceProperties dataSourceProperties;\n  private final static Logger logger = LoggerFactory.getLogger(SeataAutoConfig.class);\n\n  @Bean(name = "druidDataSource")\n  public DataSource druidDataSource() {\n    DruidDataSource druidDataSource = new DruidDataSource();\n    logger.info("dataSourceProperties.getUrl():{}", dataSourceProperties.getUrl());\n    druidDataSource.setUrl(dataSourceProperties.getUrl());\n    druidDataSource.setUsername(dataSourceProperties.getUsername());\n    druidDataSource.setPassword(dataSourceProperties.getPassword());\n    druidDataSource.setDriverClassName(dataSourceProperties.getDriverClassName());\n    druidDataSource.setInitialSize(0);\n    druidDataSource.setMaxActive(180);\n    druidDataSource.setMaxWait(60000);\n    druidDataSource.setMinIdle(0);\n    druidDataSource.setValidationQuery("Select 1 from DUAL");\n    druidDataSource.setTestOnBorrow(false);\n    druidDataSource.setTestOnReturn(false);\n    druidDataSource.setTestWhileIdle(true);\n    druidDataSource.setTimeBetweenEvictionRunsMillis(60000);\n    druidDataSource.setMinEvictableIdleTimeMillis(25200000);\n    druidDataSource.setRemoveAbandoned(true);\n    druidDataSource.setRemoveAbandonedTimeout(1800);\n    druidDataSource.setLogAbandoned(true);\n    logger.info("load dataSource........");\n    return druidDataSource;\n  }\n\n    /**\n     * init datasource proxy\n     * @Param: druidDataSource datasource bean instance\n     * @Param: druidDataSource datasource bean instance\n     * @Return: DataSourceProxy datasource proxy\n     */\n    @Bean(name = "dataSource")\n    @Primary // In the same DataSource, first use the labelled DataSource\n    public DataSourceProxy dataSourceProxy(@Qualifier(value = "druidDataSource") DruidDataSource druidDataSource) {\n       logger.info("Proxy dataSource ........") ;\n       return new DataSourceProxy(druidDataSource);\n    }\n\n    /**\n     * init global transaction scanner\n     * @Return: GlobalTransactionScanner\n     * @Return: GlobalTransactionScanner\n     */\n    @Bean\n    public GlobalTransactionScanner globalTransactionScanner() {\n       logger.info("Configuring seata........") ;\n       return new GlobalTransactionScanner("test-service", "test-group");\n    }\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"Then create the configuration file MybatisPlusConfig, which is required for mybatisplus."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'package org.test.config;\n\nimport java.util.ArrayList;\nimport java.util.List;\n\nimport org.mybatis.spring.mapper.MapperScannerConfigurer;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\n\nimport com.baomidou.mybatisplus.core.parser.ISqlParser;\nimport com.baomidou.mybatisplus.extension.parsers.BlockAttackSqlParser;\nimport com.baomidou.mybatisplus.extension.plugins.PaginationInterceptor;\n\n@Configuration\n// @MapperScan("com.baomidou.springboot.mapper*") // This annotation is equivalent to @Bean below.\n// MapperScannerConfigurer, 2 configurations of a copy can be\npublic class MybatisPlusConfig {\n\n   /**\n    * mybatis-plus paging plugin <br\n    * Documentation: http://mp.baomidou.com<br>\n    */\n   @Bean\n   public PaginationInterceptor paginationInterceptor() {\n       PaginationInterceptor paginationInterceptor = new PaginationInterceptor();\n       List<ISqlParser> sqlParserList = new ArrayList<ISqlParser>();\n       // Attack the SQL blocking parser and join the parse chain.\n       sqlParserList.add(new BlockAttackSqlParser());\n       paginationInterceptor.setSqlParserList(sqlParserList);\n       return paginationInterceptor;\n   }\n\n   /**\n    * Equivalent to the top: {@code @MapperScan("com.baomidou.springboot.mapper*")} Here it can be extended, e.g., using a configuration file to configure the path to scan the Mapper\n    */\n\n   @Bean\n   public MapperScannerConfigurer mapperScannerConfigurer() {\n       MapperScannerConfigurer scannerConfigurer = new MapperScannerConfigurer();\n       scannerConfigurer.setBasePackage("org.test.mapper");\n       return scannerConfigurer;\n   }\n\n}\n\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Create the ",(0,r.jsx)(n.strong,{children:"resources directory, create the mapper folder, application.yml and other files"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"server:\n  port: 38888\nspring:\n  application:\n    name: test-service\n  datasource:\n    type: com.alibaba.druid.pool.DruidDataSource\n    url: jdbc:mysql://127.0.0.1:3306/test?useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC\n    driver-class-name: com.mysql.cj.jdbc.Driver\n    username: root\n    password: 123456\ndubbo:\n  protocol:\n    loadbalance: leastactive\n    threadpool: cached\n  scan:\n    base-packages: org\u3002test.service\n  application:\n    qos-enable: false\n    name: testserver\n  registry:\n    id: my-registry\n    address:  zookeeper://127.0.0.1:2181?client=curator\nmybatis-plus:\n  mapper-locations: classpath:/mapper/*Mapper.xml\n  typeAliasesPackage: org.test.entity\n  global-config:\n    db-config:\n      field-strategy: not-empty\n      id-type: auto\n      db-type: mysql\n  configuration:\n    map-underscore-to-camel-case: true\n    cache-enabled: true\n    auto-mapping-unknown-column-behavior: none\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"create file.conf, here the service within the vgroup_mapping. your transaction grouping, for example, on the ** face SeataAutoConfig configured within the test-group, then here should also be changed to test-group **, and then the following ip port are seata running ip and port on the line!"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'transport {\n  type = "TCP"\n  server = "NIO"\n  heartbeat = true\n  thread-factory {\n  boss-thread-prefix = "NettyBoss"\n  worker-thread-prefix = "NettyServerNIOWorker"\n  server-executor-thread-prefix = "NettyServerBizHandler"\n  share-boss-worker = false\n  client-selector-thread-prefix = "NettyClientSelector"\n  client-selector-thread-size = 1\n  client-worker-thread-prefix = "NettyClientWorkerThread"\n  boss-thread-size = 1\n  worker-thread-size = 8\n}\n  shutdown {\n  wait = 3\n}\n  serialization = "seata"\n  compressor = "none"\n}\n  service {\n  vgroup_mapping.test-group = "default"\n  default.grouplist = "127.0.0.1:8091"\n  enableDegrade = false\n  disable = false\n  max.commit.retry.timeout = "-1"\n  max.rollback.retry.timeout = "-1"\n}\n\n  client {\n  async.commit.buffer.limit = 10000\n  lock {\n  retry.internal = 10\n  retry.times = 30\n}\n  report.retry.count = 5\n  tm.commit.retry.count = 1\n  tm.rollback.retry.count = 1\n  undo.log.table = "undo_log"\n}\n\n  recovery {\n  committing-retry-period = 1000\n  asyn-committing-retry-period = 1000\n  rollbacking-retry-period = 1000\n  timeout-retry-period = 1000\n}\n\n  transaction {\n  undo.data.validation = true\n  undo.log.serialization = "jackson"\n  undo.log.save.days = 7\n  undo.log.delete.period = 86400000\n  undo.log.table = "undo_log"\n}\n\n  metrics {\n  enabled = false\n  registry-type = "compact"\n  exporter-list = "prometheus"\n  exporter-prometheus-port = 9898\n}\n\n  support {\n  spring {\n  datasource.autoproxy = false\n}\n}\n\n'})}),"\n",(0,r.jsx)(n.p,{children:"Create registry.conf to specify ip ports for file, zk and so on."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'registry {\n  type = "file"\n  file {\n    name = "file.conf"\n  }\n}\nconfig {\n  type = "file"\n  file {\n    name = "file.conf"\n  }\n  zk {\n    serverAddr = "127.0.0.1:2181"\n    session.timeout = 6000\n    connect.timeout = 2000\n  }\n}\n\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Great success, you can directly run it, this time to observe the seata-server",(0,r.jsx)(n.img,{alt:"20191129142115",src:t(46113).A+"",width:"695",height:"492"})]}),"\n",(0,r.jsx)(n.p,{children:"Next, we create test-client project, here will not repeat, with the above test-service the same way to create"}),"\n",(0,r.jsx)(n.p,{children:"Next, we copy the test-service service and entities within the past, of course, you are too much trouble, you can get a separate sub-project to put a general service and entities, some tools and so on, I'm here in order to quickly build this demo, the choice of copy and paste the way."}),"\n",(0,r.jsxs)(n.p,{children:["Directory structure:",(0,r.jsx)(n.img,{src:t(59296).A+"",width:"483",height:"275"})]}),"\n",(0,r.jsx)(n.p,{children:"Then we create ClientApplication."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'package org.test;\n\nimport java.util.TimeZone;\nimport java.util.concurrent.Executor;\n\nimport org.apache.dubbo.config.spring.context.annotation.EnableDubbo;\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\nimport org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.ComponentScan;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.scheduling.annotation.EnableAsync;\nimport org.springframework.scheduling.annotation.EnableScheduling;\nimport org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;\n\nimport com.baomidou.mybatisplus.autoconfigure.MybatisPlusAutoConfiguration;\n\n@SpringBootApplication(exclude = {DataSourceAutoConfiguration.class, MybatisPlusAutoConfiguration.class})\n@EnableScheduling\n@EnableAsync\n@Configuration\n@EnableDubbo(scanBasePackages = {"org.test.service"})\n@ComponentScan(basePackages = {"org.test.service", "org.test.controller", "org.test.config"})\npublic class ClientApplication {\n    public static void main(String[] args) {\n        TimeZone.setDefault(TimeZone.getTimeZone("Asia/Shanghai"));\n        SpringApplication app = new SpringApplication(ClientApplication.class);\n        app.run(args);\n    }\n\n    @Bean(name = "threadPoolTaskExecutor")\n    public Executor threadPoolTaskExecutor() {\n        return new ThreadPoolTaskExecutor();\n    }\n}\n\n'})}),"\n",(0,r.jsx)(n.p,{children:"Then go to the config package and create SwaggerConfig :"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'package org.test.config;\n\nimport java.util.ArrayList;\nimport java.util.List;\n\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\n\nimport springfox.documentation.builders.ApiInfoBuilder;\nimport springfox.documentation.builders.PathSelectors;\nimport springfox.documentation.builders.RequestHandlerSelectors;\nimport springfox.documentation.service.ApiInfo;\nimport springfox.documentation.service.Contact;\nimport springfox.documentation.service.Parameter;\nimport springfox.documentation.spi.DocumentationType;\nimport springfox.documentation.spring.web.plugins.Docket;\nimport springfox.documentation.swagger2.annotations.EnableSwagger2;\n\n@Configuration\npublic class SwaggerConfig {\n   // swagger2 configuration file, here you can configure the swagger2 some basic content, such as scanning packages and so on\n   @Bean\n   public Docket createRestApi() {\n       List<Parameter> pars = new ArrayList<Parameter>(); return new Docket(DocumentationText)\n       return new Docket(DocumentationType.SWAGGER_2).apiInfo(apiInfo()).select()\n           // Path to the current package\n           .apis(RequestHandlerSelectors.basePackage("org.test.controller")).paths(PathSelectors.any()).build()\n           .globalOperationParameters(pars);\n   }\n\n   // Build the api document\'s details function, noting which annotation is referenced here\n   private ApiInfo apiInfo() {\n       return new ApiInfoBuilder()\n           // The title of the page\n           .title("Project Interface")\n           // Creator\n           .contact(new Contact("FUNKYE", "", ""))\n           // Version number\n           .version("1.0")\n           // Description\n           .description("API description").build();\n   }\n}\n\n'})}),"\n",(0,r.jsx)(n.p,{children:"and then create SpringMvcConfigure, and then put inside the configuration of seata, I'm lazy in order to directly integrated in the mvc configuration of the class, you can standardise the point can be created in addition to the configuration of a seata class, you can find the following is still a group name, I have two projects are assigned to a group to go, it seems that another take a also It's okay."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'package org.test.config;\n\nimport java.nio.charset.Charset;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Map;\n\nimport org.apache.dubbo.config.annotation.Reference;\nimport org.springframework.boot.web.servlet.FilterRegistrationBean;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.core.Ordered;\nimport org.springframework.http.MediaType;\nimport org.springframework.http.converter.HttpMessageConverter;\nimport org.springframework.http.converter.StringHttpMessageConverter;\nimport org.springframework.web.cors.CorsConfiguration;\nimport org.springframework.web.cors.UrlBasedCorsConfigurationSource;\nimport org.springframework.web.filter.CorsFilter;\nimport org.springframework.web.servlet.HandlerInterceptor;\nimport org.springframework.web.servlet.config.annotation.InterceptorRegistry;\nimport org.springframework.web.servlet.config.annotation.WebMvcConfigurer;\nimport org.springframework.web.servlet.view.InternalResourceViewResolver;\n\nimport com.alibaba.fastjson.serializer.SerializerFeature;\nimport com.alibaba.fastjson.support.config.FastJsonConfig;\nimport com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter;\nimport com.google.common.collect.Maps;\n\nimport io.seata.spring.annotation.GlobalTransactionScanner;\n\n@Configuration\npublic class SpringMvcConfigure implements WebMvcConfigurer {\n\n   @Bean\n   public FilterRegistrationBean corsFilter() {\n       UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();\n       CorsConfiguration config = new CorsConfiguration();\n       config.setAllowCredentials(true);\n       config.addAllowedOrigin("*");\n       config.addAllowedHeader(CorsConfiguration.ALL); config.addAllowedHeader(CorsConfiguration.ALL);\n       config.addAllowedMethod(CorsConfiguration.ALL); config.addAllowedMethod(CorsConfiguration.ALL);\n       source.registerCorsConfiguration("/**", config);\n       FilterRegistrationBean filterRegistrationBean = new FilterRegistrationBean(new CorsFilter(source));\n       filterRegistrationBean.setOrder(Ordered.HIGHEST_PRECEDENCE);\n       filterRegistrationBean.setOrder(1);\n       filterRegistrationBean.setEnabled(true);\n       filterRegistrationBean.addUrlPatterns("/**");\n       Map<String, String> initParameters = Maps.newHashMap();\n       initParameters.put("excludes", "/favicon.ico,/img/*,/js/*,/css/*");\n       initParameters.put("isIncludeRichText", "true");\n       filterRegistrationBean.setInitParameters(initParameters); return filterRegistrationBean.\n       return filterRegistrationBean; }\n   }\n\n   @Bean\n   public InternalResourceViewResolver viewResolver() {\n       InternalResourceViewResolver viewResolver = new InternalResourceViewResolver(); viewResolver.setPrefix("/WEB-INF")\n       viewResolver.setPrefix("/WEB-INF/jsp/");\n       viewResolver.setSuffix(".jsp");\n       // viewResolver.setViewClass(JstlView.class); // This property does not usually need to be configured manually.\n       // This property does not usually need to be configured manually, as higher versions of Spring will automatically detect it.\n       return viewResolver; // viewResolver.setViewClass(JstlView.class)\n   }\n\n\n\n   /**\n    * Replacing frame json with fastjson\n    */\n   @Override\n   public void configureMessageConverters(List<HttpMessageConverter<? >> converters) {\n     FastJsonHttpMessageConverter fastConverter = new FastJsonHttpMessageConverter();\n     FastJsonConfig fastJsonConfig = new FastJsonConfig();\n     fastJsonConfig.setSerializerFeatures(SerializerFeature.PrettyFormat, SerializerFeature.WriteMapNullValue,\n       SerializerFeature.WriteNullStringAsEmpty, SerializerFeature.DisableCircularReferenceDetect);\n       // Handle garbled Chinese characters\n       List<MediaType> fastMediaTypes = new ArrayList<>();\n       fastMediaTypes.add(MediaType.APPLICATION_JSON_UTF8);\n       fastConverter.setSupportedMediaTypes(fastMediaTypes);\n       fastConverter.setFastJsonConfig(fastJsonConfig);\n       // Handle strings, avoiding quotes when returning strings directly.\n       StringHttpMessageConverter smc = new StringHttpMessageConverter(Charset.forName("UTF-8"));\n       converters.add(smc);\n       converters.add(fastConverter);\n   }\n\n   @Bean\n   public GlobalTransactionScanner globalTransactionScanner() {\n       return new GlobalTransactionScanner("test-client", "test-group"); }\n   }\n\n}\n\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Create the c",(0,r.jsx)(n.strong,{children:"ontroller package, and then create the TestController"})," under the package."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'package org.test.controller;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.context.annotation.Lazy;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RestController;\nimport org.test.service.DemoService;\n\nimport io.swagger.annotations.Api;\nimport io.swagger.annotations.ApiOperation;\n\n/**\n* <p>\n* Documentation table Front-end controller\n* </p\n*\n* @author funkye\n* @since 2019-03-20\n*/\n@RestController\n@RequestMapping("/test")\n@Api(tags = "test interface")\npublic class TestController {\n\n   private final static Logger logger = LoggerFactory.getLogger(TestController.class);\n   @Autowired\n   @Lazy\n   DemoService demoService;\n\n   @GetMapping(value = "testSeataOne")\n   @ApiOperation(value = "Test the manual rollback distributed transaction interface")\n   public Object testSeataOne() {\n       return demoService.One();\n   }\n\n   @GetMapping(value = "testSeataTwo")\n   @ApiOperation(value = "Test Exception Rollback Distributed Transaction Interface")\n   public Object testSeataTwo() {\n       return demoService.Two();\n   }\n\n}\n\n'})}),"\n",(0,r.jsx)(n.p,{children:"Then go to service and create the demoService you need to depend on."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'package org.test.service;\n\nimport java.time.LocalDateTime;\n\nimport org.apache.dubbo.config.annotation.Reference;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.stereotype.Service;\nimport org.test.controller.TestController;\nimport org.test.entity.Test;\n\nimport io.seata.core.context.RootContext;\nimport io.seata.core.exception.TransactionException;\nimport io.seata.spring.annotation.GlobalTransactional;\nimport io.seata.tm.api.GlobalTransactionContext;\n\n@Service\npublic class DemoService {\n @Reference(version = "1.0.0", timeout = 60000)\n private ITestService testService;\n private final static Logger logger = LoggerFactory.getLogger(DemoService.class);\n\n /**\n  * manual rollback example\n  *\n  * @return\n  */\n @GlobalTransactional\n public Object One() {\n   logger.info("seata distribute transaction Id:{}", RootContext.getXID());\n   Test t = new Test();\n   t.setOne("1");\n   t.setTwo("2");\n   t.setCreateTime(LocalDateTime.now());\n   testService.save(t);\n   try {\n     int i = 1 / 0;\n     return true;\n   } catch (Exception e) {\n     // TODO: handle exception\n     try {\n       logger.info("load transaction id for rollback");\n       GlobalTransactionContext.reload(RootContext.getXID()).rollback();\n     } catch (TransactionException e1) {\n       // TODO Auto-generated catch block\n       e1.printStackTrace();\n     }\n   }\n   return false;\n }\n\n /**\n  * throw exception and rollback\n  *\n  * @return\n  */\n @GlobalTransactional\n public Object Two() {\n   logger.info("seata\u5206\u5e03\u5f0f\u4e8b\u52a1Id:{}", RootContext.getXID());\n   logger.info("seata distribute transaction Id:{}", RootContext.getXID());\n   Test t = new Test();\n   t.setOne("1");\n   t.setTwo("2");\n   t.setCreateTime(LocalDateTime.now());\n   testService.save(t);\n   try {\n     int i = 1 / 0;\n     return true;\n   } catch (Exception e) {\n     // TODO: handle exception\n     throw new RuntimeException();\n   }\n }\n}\n\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Create the resources folder as usual, starting with the common ",(0,r.jsx)(n.strong,{children:"application.yml"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"spring:\n  application:\n     name: test\n  datasource:\n     driver-class-name: com.mysql.cj.jdbc.Driver\n     url: jdbc:mysql://127.0.0.1:3306/test?userSSL=true&useUnicode=true&characterEncoding=UTF8&serverTimezone=Asia/Shanghai\n     username: root\n     password: 123456\n  mvc:\n    servlet:\n      load-on-startup: 1\n  http:\n    encoding:\n            force: true\n            charset: utf-8\n            enabled: true\n    multipart:\n      max-file-size: 10MB\n      max-request-size: 10MB\ndubbo:\n  registry:\n    id: my-registry\n    address:  zookeeper://127.0.0.1:2181?client=curator\n#    address:  zookeeper://127.0.0.1:2181?client=curator\n  application:\n    name: dubbo-demo-client\n    qos-enable: false\nserver:\n  port: 28888\n  max-http-header-size: 8192\n  address: 0.0.0.0\n  tomcat:\n    max-http-post-size: 104857600\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"Copy the service configuration file and registry file, if your client group name is changed in the configuration class, then the group name in the file file needs to be changed as well."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:t(40676).A+"",width:"298",height:"452"})}),"\n",(0,r.jsx)(n.p,{children:"The complete directory structure as above, this time you can start test-service, then start test-client, to swagger test it!"}),"\n",(0,r.jsxs)(n.ol,{start:"4",children:["\n",(0,r.jsxs)(n.li,{children:["Visit 127.0.0.1:28888/swagger-ui.html to do the final finish ",(0,r.jsx)(n.img,{src:t(60660).A+"",width:"947",height:"426"})]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"20191129143124",src:t(26790).A+"",width:"549",height:"67"})}),"\n",(0,r.jsx)(n.p,{children:"Here's the data I've saved a record, let's see if we'll successfully rollback:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"20191129143252",src:t(87918).A+"",width:"943",height:"588"})}),"\n",(0,r.jsx)(n.p,{children:"Refresh the database, found that there is still only one data:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"20191129143124",src:t(26790).A+"",width:"549",height:"67"})}),"\n",(0,r.jsx)(n.p,{children:"And then check the log."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"20191129143407",src:t(18802).A+"",width:"987",height:"89"})}),"\n",(0,r.jsx)(n.p,{children:"It shows that it has been rolled back, let's look at the log from seata-server again:"}),"\n",(0,r.jsx)("img",{src:"/img/blog/20191129143419.png",style:{zoom:"200%"}}),"\n",(0,r.jsx)(n.p,{children:"Display rollback success, transaction id is also consistent, this is our distributed transaction on the run through, through the interruption point way, you can view the undo_log, you will find that before the transaction is committed, will be deposited into a transaction information data, if the rollback is successful, the information will be deleted."}),"\n",(0,r.jsx)(n.h1,{id:"summary",children:"Summary"}),"\n",(0,r.jsx)(n.p,{children:"seata's integration is still relatively simple and easy to start, a little more attentive you must write better than me!"}),"\n",(0,r.jsx)(n.p,{children:"Welcome to read more seata, dubbo and other source code, can solve the business encountered a lot of pit oh!"})]})}function p(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},78482:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/20191129132933-e2cced49e010d6f7c493644ca7f1aba8.png"},14681:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/20191129133111-f1055c7f1e760b48cd7a5a0acc77a648.png"},94534:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/20191129133354-fa95fd2cfe751b4cbdd6cb20b3e7ec37.png"},67099:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/20191129134127-06a15c80fc75daa7c3b466dd8ee84659.png"},69757:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/20191129135935-50a3608af215bcef2c69fb5aa5d03144.png"},46113:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/20191129142115-3d08387e87a3a80200ecffadca799917.png"},59296:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/20191129142349-ae02ff4b6762d6733cca6b1e672ce738.png"},40676:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/20191129142851-be44001f4b861b83fd022d0b2c979158.png"},60660:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/20191129143041-5cba24d3bf073b4af87cac29666ced76.png"},26790:(e,n,t)=>{t.d(n,{A:()=>r});const r="data:image/png;base64,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"},87918:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/20191129143252-2f06cbc92fdf2fc68db30ebf51fcd5d3.png"},18802:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/20191129143407-7a7f98cf84b5d992c536e7e75e95e296.png"},28453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>s});var r=t(96540);const a={},o=r.createContext(a);function i(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);