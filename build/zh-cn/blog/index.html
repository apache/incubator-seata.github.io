<!doctype html>
<html lang="zh-CN" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">Blog | Apache Seata</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://seata.apache.org/zh-cn/img/seata_logo.png"><meta data-rh="true" name="twitter:image" content="https://seata.apache.org/zh-cn/img/seata_logo.png"><meta data-rh="true" property="og:url" content="https://seata.apache.org/zh-cn/blog"><meta data-rh="true" property="og:locale" content="zh_CN"><meta data-rh="true" property="og:locale:alternate" content="en_US"><meta data-rh="true" name="docusaurus_locale" content="zh-cn"><meta data-rh="true" name="docsearch:language" content="zh-cn"><meta data-rh="true" name="keywords" content="Seata,Seata官网,Seata official site,分布式事务,distributed transactions"><meta data-rh="true" property="og:title" content="Blog | Apache Seata"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/zh-cn/img/seata_logo_small.jpeg"><link data-rh="true" rel="canonical" href="https://seata.apache.org/zh-cn/blog"><link data-rh="true" rel="alternate" href="https://seata.apache.org/blog" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://seata.apache.org/zh-cn/blog" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://seata.apache.org/blog" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://ICHFIJRDZF-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/zh-cn/blog/rss.xml" title="Apache Seata RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-cn/blog/atom.xml" title="Apache Seata Atom Feed">


<link rel="search" type="application/opensearchdescription+xml" title="Apache Seata" href="/zh-cn/opensearch.xml">


<meta name="aes-config" content="pid=xux-opensource&amp;user_type=101&amp;uid=&amp;username=&amp;dim10=seata"><link rel="stylesheet" href="/zh-cn/assets/css/styles.9644caf2.css">
<script src="/zh-cn/assets/js/runtime~main.93abc21b.js" defer="defer"></script>
<script src="/zh-cn/assets/js/main.15461460.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-cn/"><div class="navbar__logo"><img src="/zh-cn/img/seata_logo.png" alt="Seata Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/zh-cn/img/seata_logo.png" alt="Seata Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh-cn/">首页</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="/overview/what-is-seata" href="/zh-cn/docs/overview/what-is-seata">v2.2</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh-cn/docs/next/overview/what-is-seata">预览版</a></li><li><a class="dropdown__link" href="/zh-cn/docs/overview/what-is-seata">v2.2</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v2.1/overview/what-is-seata">v2.1</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v2.0/overview/what-is-seata">v2.0</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.8/overview/what-is-seata">v1.8</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.7/overview/what-is-seata">v1.7</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.6/overview/what-is-seata">v1.6</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.5/overview/what-is-seata">v1.5</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.4/overview/what-is-seata">v1.4</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.3/overview/what-is-seata">v1.3</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.2/overview/what-is-seata">v1.2</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.1/overview/what-is-seata">v1.1</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.0/overview/what-is-seata">v1.0</a></li></ul></div><a class="navbar__item navbar__link" href="/zh-cn/docs/developers/contributor-guide/new-contributor-guide_dev">开发者</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh-cn/blog">博客</a><a class="navbar__item navbar__link" href="/zh-cn/users">用户</a><a class="navbar__item navbar__link" href="/zh-cn/community">社区</a><a class="navbar__item navbar__link" href="/zh-cn/unversioned/download/seata-server">下载</a><a class="navbar__item navbar__link" href="/zh-cn/solution">解决方案</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">设计器</a><ul class="dropdown__menu"><li><a href="/zh-cn/saga-designer" class="dropdown__link" target="_blank">Saga 设计器</a></li><li><a href="/zh-cn/saga-designer-legacy" class="dropdown__link" target="_blank">Saga 设计器（旧版）</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/security" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_DSK9"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中</a><ul class="dropdown__menu"><li><a href="/blog" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-US">En</a></li><li><a href="/zh-cn/blog" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-CN">中</a></li></ul></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">所有文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-namingserver">Seata Namingserver</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-raft-config-center">Seata Raft模式配置中心</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-rpc-multi-protocol01">Seata的RPC通信源码分析01：传输篇</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-rpc-multi-protocol02">Seata的RPC通信源码分析02：协议篇（多版本协议）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/how-to-write-unit-tests">如何在seata中编写测试用例</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/explore-seata-journey">探索 Seata 项目开源开发之旅</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-raft-detailed-explanation">Seata-Raft 存储模式详解及入门</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-connect-data-and-application">Seata：连接数据与应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-observable-practice">Seata的可观测实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-go-1.2.0">生产环境可用的 seata-go 1.2.0 来了！！！</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/iscas2023">6大课题现已开放挑选 | 欢迎报名 Seata 开源之夏</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-1.6.0">Seata 1.6.0 重磅发布，大幅提升性能</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-1.5.2">Seata 1.5.2 重磅发布，支持xid负载均衡</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-tcc-fence">阿里 Seata 新版本终于解决了 TCC 模式的幂等、悬挂和空回滚问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-tcc">深度剖析 Seata TCC 模式（一）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-lock">详解 Seata AT 模式事务隔离级别与全局锁设计</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-snowflake-explain">关于新版雪花算法的答疑</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-UUID-generator">Seata基于改良版雪花算法的分布式UUID生成器分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-feature-undo-log-compress">Seata新特性支持 -- undo_log压缩</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-dsproxy-deadlock">ConcurrentHashMap导致的Seata死锁问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-client-start-analysis-02">Seata应用侧启动过程剖析——注册中心与配置中心模块</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-client-start-analysis-01">Seata应用侧启动过程剖析——RM &amp; TM如何与TC建立连接</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/integrate-seata-tcc-mode-with-spring-cloud">Spring Cloud集成Seata分布式事务-TCC模式</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-config-manager">Seata配置管理原理解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-golang-communication-mode">seata-golang 通信模型详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-datasource-proxy">Seata数据源代理解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-sourcecode-client-bootstrap">分布式事务Seata源码-Client端启动流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-demo-in-mac">Mac下的Seata Demo环境搭建（AT模式）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-rpc-refactor">Seata RPC 模块的重构之路</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-sourcecode-server-bootstrap">分布式事务Seata源码-Server端启动流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-xa-introduce">分布式事务如何实现？深入解读 Seata 的 XA 模式</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-quick-start">Seata 极简入门</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-ha-practice">Seata 高可用部署实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-config-modular">Seata config 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-dubbo-transmit-xid">源码分析Seata-XID传递 Dubbo篇</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-tcc-modular">Seata tcc 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-community-meetup-hangzhou-ready">Seata Community Meetup·杭州站</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-core-modular">Seata core 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-spring-boot-aop-aspectj">通过AOP动态创建/关闭Seata分布式事务</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-dynamic-config-and-dynamic-disable">Seata 动态配置订阅与降级实现原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-config-center">Seata 配置中心实现原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-nacos-docker">Docker部署Seata与Nacos整合</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-nacos-analysis">Seata分布式事务启用Nacos做配置中心</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-meetup-hangzhou">Seata Community Meetup·杭州站</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-mybatisplus-analysis">透过源码解决SeataAT模式整合Mybatis-Plus失去MP特性的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/springboot-dubbo-mybatisplus-seata">SpringBoot+Dubbo+MybatisPlus整合seata分布式事务</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-mode-start-rm-tm">Seata 客户端需要同时启动 RM 和 TM 吗？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-mode-start">Seata AT 模式启动源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/design-more-flexable-application-by-saga">基于 Seata Saga 设计更有弹性的金融应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-tcc-saga">分布式事务 Seata 及其三种模式详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-mode-design">分布式事务中间件 Seata 的设计原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-go-server">Seata分布式Go Server正式开源-TaaS设计简介</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/how-to-support-spring-cloud">Fescar 与 Spring Cloud 集成源码深度剖析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/integrate-seata-with-spring-cloud">Seata（Fescar）分布式事务 整合 Spring Cloud</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-java-client">分布式事务之Seata-Client原理及流程详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-java-server">深度剖析一站式分布式事务方案Seata-Server</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/tcc-mode-applicable-scenario-analysis">TCC适用模型与适用场景分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/tcc-mode-design-principle">TCC 理论及设计实现指南介绍</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/quick-start-use-seata-and-dubbo-services">如何使用Seata保证Dubbo微服务间的一致性</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-simple">Fescar分布式事务原理解析探秘</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/manual-transaction-mode">MT 模式</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="在本文中，我将分享seata的注册中心namingserver的设计思路以及使用方式"><meta itemprop="keywords" content="seata,分布式事务,注册中心,namingserver"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-namingserver">Seata Namingserver</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-09-25T00:00:00.000Z" itemprop="datePublished">2024年9月25日</time> · <!-- -->阅读需 11 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">蒋俊敏</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>seata目前支持多种注册中心的实现，为了提供整个链路的闭环功能，seata设计推出了原生的注册中心namingserver</p>
<h1>2. 领域模型</h1>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-命名空间与事务分组">2.1 命名空间与事务分组<a href="#21-命名空间与事务分组" class="hash-link" aria-label="2.1 命名空间与事务分组的直接链接" title="2.1 命名空间与事务分组的直接链接">​</a></h3>
<ul>
<li>Namespace：在NamingServer模型中，命名空间（Namespace）用于实现命名空间的环境隔离。它允许在不同的环境（如开发、测试、生产）中隔离各自的服务实例。</li>
<li>Cluster与Unit：Cluster（集群）负责事务分组的处理，Unit则在每个集群内部做负载均衡。事务分组（vgroup）在命名空间和集群的配合下，通过元数据定位到具体的TC节点。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-事务处理流程与namingserver的交互">2.2 事务处理流程与namingserver的交互<a href="#22-事务处理流程与namingserver的交互" class="hash-link" aria-label="2.2 事务处理流程与namingserver的交互的直接链接" title="2.2 事务处理流程与namingserver的交互的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" alt="img" src="/zh-cn/assets/images/namingserver1-de2c2db49682249fc3a98118dcfd69f1.png" width="781" height="733" class="img_ev3q">
事务处理流程与namingserver的交互的流程如下：</p>
<p>1.在client侧配置好Namingserver的地址和相关配置</p>
<p>2.client启动后TM向namingserver发起服务发现的请求</p>
<p>3.namingserver根据TM传来的vGroup参数和内存中的事务分组映射关系返回相关的集群列表，namingserver返回的集群列表元数据如下</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;clusterList&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;clusterName&quot;: &quot;cluster2&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;clusterType&quot;: &quot;default&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          	&quot;groupList&quot;:[group1,group2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;unitData&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;unitName&quot;: &quot;115482ee-cf27-45d6-b17e-31b9e2d7892f&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;namingInstanceList&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;ip&quot;: &quot;172.31.31.191&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;port&quot;: 8092,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;nettyPort&quot;: 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;grpcPort&quot;: 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;weight&quot;: 1.0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;healthy&quot;: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;timeStamp&quot;: 1695042063334,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;role&quot;: member,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;metadata&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                &quot;weight&quot;: 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                &quot;cluster-type&quot;: &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;unitName&quot;: &quot;097e6ab7-d2d2-47e4-a578-fae1a4f4c517&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;namingInstanceList&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;ip&quot;: &quot;172.31.31.191&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;port&quot;: 8091,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;nettyPort&quot;: 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;grpcPort&quot;: 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;weight&quot;: 1.0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;healthy&quot;: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;timeStamp&quot;: 1695042076481,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;role&quot;: member,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;metadata&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                &quot;weight&quot;: 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                &quot;cluster-type&quot;: &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;term&quot;: 1695042076578</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>4.客户端通过负载均衡策略找出合适的TC节点开启事务</p>
<p>5.TM将事务分组和TC节点传递给RM</p>
<p>6.RM向TC节点发起分支注册的请求</p>
<p>7.TC节点完成二阶段下发</p>
<h1>3.设计思路</h1>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-ap还是cp">3.1 AP还是CP？<a href="#31-ap还是cp" class="hash-link" aria-label="3.1 AP还是CP？的直接链接" title="3.1 AP还是CP？的直接链接">​</a></h3>
<p>CAP协议又称CAP定理，指的是在一个分布式系统中，Consistency（一致性）、 Availability（可用性）、Partition tolerance（分区容错性），三者不可得兼。 分布式系统的CAP理论：理论首先把分布式系统中的三个特性进行了如下归纳：</p>
<p>● 一致性（C）：在分布式系统中的所有数据备份，在同一时刻是否同样的值。（等同于所有节点访问同一份最新的数据副本）</p>
<p>● 可用性（A）：在集群中一部分节点故障后，集群整体是否还能响应客户端的读写请求。（对数据更新具备高可用性）</p>
<p>● 分区容错性（P）：以实际效果而言，分区相当于对通信的时限要求。系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况，必须就当前操作在C和A之间做出选择。</p>
<p>对于namingserver而言，我们更倾向于使用AP模型，即注重可用性和分区容错性，牺牲一定的一致性。NamingServer作为服务注册中心，主要职责是提供高效的服务发现与注册服务，而对短时间内的数据一致性要求可以适当放松。在分布式环境中，可能会出现多个节点短暂的注册数据不一致现象。例如，当多个NamingServer节点发生了网络分区时，某些节点获取的注册信息可能有延迟。
对于NamingServer来说，这种短暂的不一致性我们认为是可以容忍的。由于服务注册与发现的强一致性要求并不高，即使在某个时刻有部分节点的注册数据滞后或不一致，也不会立刻影响到整个系统的正常服务。通过心跳机制、周期性同步等方式，最终一致性可以逐渐得到保证。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-quorum-nwr机制在namingserver中的应用">3.2 Quorum NWR机制在NamingServer中的应用<a href="#32-quorum-nwr机制在namingserver中的应用" class="hash-link" aria-label="3.2 Quorum NWR机制在NamingServer中的应用的直接链接" title="3.2 Quorum NWR机制在NamingServer中的应用的直接链接">​</a></h3>
<p>Quorum NWR（仲裁读写）是一种在分布式系统中用于确保数据一致性的机制。该机制通过设置副本的总数（N）、写操作需要成功的副本数（W）、读操作需要访问的副本数（R）来协调数据的一致性。在NamingServer的设计中，采用了多写+补偿机制来保证多个NamingServer节点之间的信息一致性，而客户端则与某一个NamingServer节点交互以获取注册信息。</p>
<ol>
<li>写入操作（W-写仲裁）：
当有集群节点变化时，server端会将请求发送到NamingServer集群中的多个节点。
根据NWR机制，系统确保至少有W个副本成功写入注册信息。 通过多写机制，即使某些节点暂时不可用或存在网络延迟，仍能确保写操作的高可用性。一旦W个节点写入成功，客户端将收到成功响应。
补偿机制：对于没有立即成功写入的副本，系统会通过异步补偿方式，在稍后的时间段内同步这些节点，确保最终一致性。</li>
<li>读取操作（R-读仲裁）：
客户端通过与NamingServer集群中的任意一个节点进行交互，发送读取请求以获取服务注册信息。
系统会从至少R个副本中读取数据，采用最新版本的数据作为返回结果。即使某些节  点的数据存在短暂不一致，客户端通过读取多个副本并比较其版本号或一致性标记，能够确保读取到最新的注册信息。
由于客户端只与一个NamingServer节点进行交互，读取操作的效率得到了提升，并且避免了多个节点之间的复杂协调，系统依然能保证最终一致性。</li>
<li>NWR参数的设计与权衡：
在namingserver中我们设置W=N、R=1。W=N虽然意味着写入需要发送到所有节点，但并不要求所有节点必须立即成功写入。系统允许某些节点暂时失败，通过补偿机制在后续阶段同步这些节点，从而提高系统的容错性，因为即便某些节点在写入时发生故障或网络中断，数据更新仍然可以通过补偿机制最终传播到所有节点。这既保证了系统的高可用性，也确保了数据最终在所有节点上是一致的。由于写操作要求所有节点参与，因此每个节点都会接收到最新的数据更新。
客户端在执行读取操作时，可以从任意一个NamingServer节点读取数据，而不必担心数据不一致的问题。即使某些节点未能在写入时立即成功，客户端仍能从其他已成功写入的节点获取最新的注册信息。这样，R值可以设定较低（如R=1），从而提高读取操作的效率，同时系统通过补偿机制确保所有节点最终达到一致。
<img decoding="async" loading="lazy" alt="img" src="/zh-cn/assets/images/namingserver2-c904449e0f07a7fade6f396e739e27ef.png" width="773" height="526" class="img_ev3q"></li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="32-架构图">3.2 架构图<a href="#32-架构图" class="hash-link" aria-label="3.2 架构图的直接链接" title="3.2 架构图的直接链接">​</a></h2>
<p><img decoding="async" loading="lazy" alt="img" src="/zh-cn/assets/images/namingserver3-064de2cc03cdcd915f67c9eebe081154.png" width="1194" height="782" class="img_ev3q"></p>
<p>namingserver的运行链路如上图所示：</p>
<ol>
<li>通过 控制台在某个cluster下创建一个事务分组vgroup。</li>
<li>创建vgroup-&gt;cluster的请求发送给namingserver，namingserver再传递给对应的tc节点。</li>
<li>tc节点将vgroup-&gt;cluster映射关系持久化保存。</li>
<li>tc节点在心跳的时候将vgroup-&gt;cluster的映射关系更新到所有的namingserver。</li>
<li>client通过自己配置的事务分组vgroup从namingserver获取对应cluster元数据。</li>
<li>client在事务流程中，使用cluster下的unit进行负载均衡，再进行begin，registry，commit，rollback等。</li>
<li>事务决议后，对应的unit下的leader节点下发二阶段，无状态节点下，每个unit的唯一node就是leader。</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="33-设计细节">3.3 设计细节<a href="#33-设计细节" class="hash-link" aria-label="3.3 设计细节的直接链接" title="3.3 设计细节的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="331-长轮询推送集群变化情况">3.3.1 长轮询推送集群变化情况<a href="#331-长轮询推送集群变化情况" class="hash-link" aria-label="3.3.1 长轮询推送集群变化情况的直接链接" title="3.3.1 长轮询推送集群变化情况的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" src="https://camo.githubusercontent.com/82b14f95feb7ce17af5ca953dbb0340f1a86519c9067433944ac5fa8c26711c8/68747470733a2f2f63646e2e6e6c61726b2e636f6d2f79757175652f302f323032332f706e672f33333531373535322f313639353236343333343035342d38393065623863382d653437302d343761362d623030372d3732343365303938313732652e706e67" alt="img" class="img_ev3q"></p>
<p>如上图所示，每隔30s client侧需要向namingserver发起一次服务发现的请求，用以拉取最新的tc列表。而在这30s的间隔中，client侧将采用HTTP长轮询的方式一直watch namingserver节点，如果namingserver 侧有如下的变化：</p>
<blockquote>
<p>1.事务分组映射关系的变化；</p>
<p>2.集群中实例的增加或  者减少；</p>
<p>3.集群中实例的属性的变化；</p>
</blockquote>
<p>那么watch返回200状态码，告知client需要获取最新集群信息；否则namingserver将一直挂起watch方法，直到HTTP长轮询超时，然后返回304状态码， 告知client进行下一轮watch。</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="在本文中，我将分享基于Raft和RocksDB设计的Seata配置中心和使用方式。"><meta itemprop="keywords" content="seata,分布式事务,配置中心,Raft,RocksDB"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-raft-config-center">Seata Raft模式配置中心</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-09-19T00:00:00.000Z" itemprop="datePublished">2024年9月19日</time> · <!-- -->阅读需 14 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">蒋奕晨-清华大学，Seata 开源之夏学生参与者</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>目前seata支持丰富的第三方配置中心，但是考虑使用的便捷性同时为了降低使用seata的门槛，在seata-server利用现有的sofa-jraft+rocksdb构建一个配置中心功能，seata-client直接与seata-server通信,获取seata相关的配置，不需要再去第三方配置中心读取，实现配置中心自闭环。</p>
<h1>2. 设计说明</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="21-配置中心">2.1 配置中心<a href="#21-配置中心" class="hash-link" aria-label="2.1 配置中心的直接链接" title="2.1 配置中心的直接链接">​</a></h2>
<p>在现有  的第三方配置中心实现中，Client端和Server端对于配置中心是解耦的，Client端和Server端直接通过<code>Configuration</code>实例获取配置项，且<code>Configuration</code>对于Client端和Server端的初始化行为是一致的，都是先连接到配置中心中间件然后获取配置，以及添加监听器等。
<img decoding="async" loading="lazy" alt="img" src="/zh-cn/assets/images/seata-raft-config-center1-ac0c53e30a59a88eda4264af9828d0e0.png" width="1066" height="448" class="img_ev3q"></p>
<p>当使用Raft的实现配置中心后，由于所有的配置项信息是保存在Server端的，因此初始化<code>Configuration</code>实例时对于Client端和Server端的行为是<strong>不一致</strong>的。</p>
<p>此外为保证和原来配置中心的逻辑相同，Client端和Server端获取配置项依旧统一从<code>RaftConfiguration</code>实例中获取，不直接和RocksDB进行交互。
<img decoding="async" loading="lazy" alt="img" src="/zh-cn/assets/images/seata-raft-config-center2-169055a43f25e2e83a5c59790db7ce3c.png" width="1059" height="824" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="img" src="/zh-cn/assets/images/seata-raft-config-center3-6b48c99ff1bfdcb8817c1424de389648.png" width="1116" height="880" class="img_ev3q"></p>
<p><code>RaftConfiguration</code>分为Server端和Client端，按照启动环境返回不同配置实例。</p>
<div class="language-Java language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">RaftConfigurationProvider</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">implements</span><span class="token plain"> </span><span class="token class-name">ConfigurationProvider</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">Configuration</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">provide</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> applicationType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getProperty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">APPLICATION_TYPE_KEY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">APPLICATION_TYPE_SERVER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">equals</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">applicationType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">RaftConfigurationServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">RaftConfigurationClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@SpringBootApplication</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scanBasePackages </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;org.apache.seata&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ServerApplication</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">IOException</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setProperty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">APPLICATION_TYPE_KEY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">APPLICATION_TYPE_SERVER</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// run the spring-boot application</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">SpringApplication</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ServerApplication</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="22-配置存储模块">2.2 配置存储模块<a href="#22-配置存储模块" class="hash-link" aria-label="2.2 配置存储模块的直接链接" title="2.2 配置存储模块的直接链接">​</a></h2>
<p><img decoding="async" loading="lazy" alt="img" src="/zh-cn/assets/images/seata-raft-config-center4-9a3ba618a6214bb22821bf4b1f528fe9.png" width="1618" height="1070" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="抽象设计">抽象设计<a href="#抽象设计" class="hash-link" aria-label="抽象设计的直接链接" title="抽象设计的直接链接">​</a></h3>
<p>为了未来支持和拓展更多的KV内存键值对数据库（如LevelDB，Caffeine），现抽象一个<code>ConfigStoreManager</code>接口以及抽象类<code>AbstractConfigStoreManager</code>，提供如下公共方法：</p>
<ul>
<li>Get：获取指定namespace，dataId中名为key的单一配置项</li>
<li>GetAll：获取指定namespace，dataId中全部配置项</li>
<li>Put：新增/修改指定namespace，dataId中某一配置项<code>&lt;key,value&gt;</code></li>
<li>Delete：删除指定namespace，dataId中名为key的配置项</li>
<li>DeleteAll：删除指定namespace，dataId中全部配置项</li>
<li>Clear：清空所有配置</li>
<li>GetAllNamespaces：获取所有命名空间</li>
<li>GetAllDataIds：获取指定namespace下的所有配置dataIds</li>
<li>...</li>
</ul>
<p>ConfigStoreManagerFactory、ConfigStoreManagerProvider.java：使用SPI机制实现的配置存储工厂类和提供者。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置监听">配置监听<a href="#配置监听" class="hash-link" aria-label="配置监听的直接链接" title="配置监听的直接链接">​</a></h3>
<p>Server端和Client端配置中心需要监听配置项的变化。</p>
<p>在Server端，由于配置本身存储在Server端，我们直接拦截配置变更的方法即可。我们在抽象接口中定义了<code>addConfigListener</code>、<code>removeConfigListener</code>方法用户添加和删除配置监听器。监听的逻辑由具体的实现类负责。</p>
<p>在<code>RocksDBConfigStoreManager</code>中，定义了<code>notifyConfigChange</code>方法来触发监听，当调用写相关操作时（如Put、Delete)触发该方法来通  知配置的变更。从而触发回调事件通知Server端配置中心。</p>
<p>在Client端，我们定义了<strong>配置版本号</strong>和<strong>长连接机制</strong>来实现配置的监听。具体的Client端在启动时，与Server建立长连接并定期刷新该连接。Server端内部维护一个<code>watchMap</code>存放所有客户端的监听信息。每当Raft状态机执行配置更新的操作会发送一个<code>ApplicationEvent</code>事件，该事件被<code>ClusterConfigWatcherManager</code>监听，从而通知<code>watchMap</code>中所有客户端配置变更。此外使用了配置版本号来优化实现，在建立长连接时，客户端需要传入版本号，当版本号低于Server端对应配置的版本号时直接返回最新配置。反之，若Server端配置版本号低于本地，则Client端认为该Server的配置已经过期（可能宕机或集群发生脑裂）会重试请求集群中其他的节点。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="多租户方案">多租户方案<a href="#多租户方案" class="hash-link" aria-label="多租户方案的直接链接" title="多租户方案的直接链接">​</a></h3>
<p>在Seata-Server端存放配置时，需要实现多租户的配置隔离，要求不同租户间的配置是相互独立、物理/逻辑上是隔离的。</p>
<p>首先调研了业内使用RocksDB的开源项目的实现，总结如下。</p>
<ol>
<li>JRaft，单RocksDB实例，两个列族，一个用来存Raft条目，一个用来存元信息。</li>
<li>TiKV，两个RocksDB实例，分别为raftDB，kvDB。kvDB中使用了多个列族存放元数据，用户数据，锁数据等。</li>
<li>Pika，为每个数据结构（String，Hash，List，Set，Zset等）创建了一个RocksDB实例，每个RocksDB实例分别用多个列族存储数据，比如Data、Meta</li>
</ol>
<p>考虑到无法提前知道租户数量（无法在启动时创建指定数量的RocksDB)，因此使用单个RocksDB实例，多列族存储。不同租户使用<code>namespace</code>区分，在Rocksdb中通过列族（ColumnFamily）进行逻辑隔离，一个namespace对应一个列族。列族相当于关系型数据库中表的概念。在配置的增删改查时指定namespace操作具体的列族，实现多租户的隔离。此外名为<code>config_version</code>的列族是内置的，用于对现有的配置进行版本号跟踪。
<img decoding="async" loading="lazy" alt="img" src="/zh-cn/assets/images/seata-raft-config-center5-8e261cdedd0f19bf2ddad4468359505f.png" width="1081" height="634" class="img_ev3q"></p>
<h1>3. 使用方式</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="30-准备配置文件">3.0 准备配置文件<a href="#30-准备配置文件" class="hash-link" aria-label="3.0 准备配置文件的直接链接" title="3.0 准备配置文件的直接链接">​</a></h2>
<p>首先准备好配置文件，具体可以参考：<a href="https://github.com/apache/incubator-seata/blob/2.x/script/config-center/config.txt" target="_blank" rel="noopener noreferrer">配置文件示例</a>。
并将配置文件置于Seata server项目资源目录下。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="31-server端配置">3.1 Server端配置<a href="#31-server端配置" class="hash-link" aria-label="3.1 Server端配置的直接链接" title="3.1 Server端配置的直接链接">​</a></h2>
<p>在 <strong><a href="https://github.com/apache/incubator-seata/blob/develop/script/client/spring/application.yml" target="_blank" rel="noopener noreferrer">application.yml</a></strong> 中加入Raft配置中心配置,其余<a href="https://seata.apache.org/zh-cn/docs/next/user/configurations" target="_blank" rel="noopener noreferrer">配置参考</a></p>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># support: nacos, consul, apollo, zk, etcd3, raft</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">raft</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">db</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rocksdb </span><span class="token comment" style="color:#999988;font-style:italic"># db类型，目前只支持rocksdb</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">dir</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> configStore  </span><span class="token comment" style="color:#999988;font-style:italic"># db文件存储目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">destroy-on-shutdown</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">#应用关闭时是否清除db文件, 默认false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;default&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 命名空间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">dataId</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;seata.properties&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 配置文件id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">file</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;file&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 初始配置文件名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">raft</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">group</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default </span><span class="token comment" style="color:#999988;font-style:italic">#此值代表该raft集群的group，client的事务分组对应的值要与之对应</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">server-addr</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 192.168.241.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9091</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 192.168.241.2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9091</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">192.168.241.3</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9091</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 其他Raft节点的ip和端口，端口为该节点的netty端口+1000，默认netty端口为8091</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">snapshot-interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">600</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 600秒做一次数据的快照，以便raftlog的快速滚动，但是每次做快照如果内存中事务数据过多会导致每600秒产生一次业务rt的抖动，但是对于故障恢复比较友好，重启节点较快，可以调整为30分钟，1小时都行，具体按业务来，可以自行压测看看是否有抖动，在rt抖动和故障恢复中自行找个平衡点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">apply-batch</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 最多批量32次动作做一次提交raftlog</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">max-append-bufferSize</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">262144</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">#日志存储缓冲区最大大小，默认256K</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">max-replicator-inflight-msgs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">256</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">#在启用 pipeline 请求情况下，最大 in-flight 请求数，默认256</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">disruptor-buffer-size</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16384</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">#内部 disruptor buffer 大小，如果是写入吞吐量较高场景，需要适当调高该值，默认 16384</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">election-timeout-ms</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">#超过多久没有leader的心跳开始重选举</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">reporter-enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># raft自身的监控是否开启</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">reporter-initial-delay</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">60</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 监控的区间间隔</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">serialization</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jackson </span><span class="token comment" style="color:#999988;font-style:italic"># 序列化方式，不要改动</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">compressor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> none </span><span class="token comment" style="color:#999988;font-style:italic"># raftlog的压缩方式，如gzip，zstd等</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">sync</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># raft日志的刷盘方式，默认是同步刷盘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在Seata-Server下，需要一个<strong>初始配置文件</strong>作为Server端的配置文件（也就是上一步所述的配置文件），<code>file.name</code>配置项需要和该文件名保持一致。在Server初次启动时，会将该配置文件作为Raft配置中心的初始配置。目前支持的文件类型有：conf、yaml、properties、txt。</p>
<blockquote>
<p>注意：Raft集群内节点的<strong>初始配置文件</strong>需要保持一致。</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="32-控制台配置管理界面">3.2 控制台配置管理界面<a href="#32-控制台配置管理界面" class="hash-link" aria-label="3.2 控制台配置管理界面的直接链接" title="3.2 控制台配置管理界面的直接链接">​</a></h2>
<p>当Server端使用<strong>Raft模式</strong>的配置中心后，可通过在<a href="http://127.0.0.1:7091" target="_blank" rel="noopener noreferrer">Seata Console</a>中内置的配置管理页面，进行配置中心的管理。用户可以通过在该页面对存储于Seata-Server集群的配置进行增删改查，注意该操作是对于集群生效的，因此可以在集群中的<strong>任意节点</strong>进行修改，所有操作会通过Raft在集群内进行同步。</p>
<blockquote>
<p>注意：该配置管理页面仅在配置中心为<strong>Raft模式</strong>下开启，对其他类型的配置中心不开放。</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="321-配置隔离">3.2.1 配置隔离<a href="#321-配置隔离" class="hash-link" aria-label="3.2.1 配置隔离的直接链接" title="3.2.1 配置隔离的直接链接">​</a></h3>
<p>Raft配置中心提供了<strong>namespace命名空间</strong>的机制来实现多租户的配置隔离。不同<strong>namespace</strong>下的配置通过底层存储机制实现逻辑隔离。在同一<strong>namespace</strong>下可以有多套配置文件，不同的配置文件用<strong>dataId</strong>进行区分。一套配置以<strong>namespace</strong>和<strong>dataId</strong>来唯一标识。</p>
<p>例如：</p>
<ul>
<li>
<p>namespace=default（默认），dataId=seata.properties（默认）</p>
</li>
<li>
<p>namespace=dev，dataId=seata-server.properties，dataId=seata-client.yaml</p>
</li>
<li>
<p>namespace=prop，dataId=seata-server.properties，dataId=seata-client.txt</p>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="img" src="/zh-cn/assets/images/seata-raft-config-center配置隔离-833cd7894e339619e1887832302b4aef.png" width="1280" height="730" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="322-配置上传">3.2.2 配置上传<a href="#322-配置上传" class="hash-link" aria-label="3.2.2 配置上传的直接链接" title="3.2.2 配置上传的直接链接">​</a></h3>
<p>在Sever启动时，Server端配置的初始文件会自动上传到配置中心。此外用户还可以通过点击&quot;上传（Upload）&quot;按钮上传配置文件到指定的<strong>namespace</strong>和<strong>dataId。</strong>
当配置上传到Server端配置中心后，Client端就可以通过<strong>namespace</strong>和<strong>dataId</strong>来获取具体的配置文件了。</p>
<p><img decoding="async" loading="lazy" alt="img" src="/zh-cn/assets/images/seata-raft-config-center配置上传-57202fb7b010d6ff7373ee8247aac757.png" width="1280" height="730" class="img_ev3q"></p>
<p>目前支持上传的配置文件类型有：txt、text、yaml、properties类型。具体的配置文件可参考示例：<a href="https://github.com/apache/incubator-seata/blob/2.x/script/config-center/config.txt" target="_blank" rel="noopener noreferrer">配置文件示例</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="323-配置查询">3.2.3 配置查询<a href="#323-配置查询" class="hash-link" aria-label="3.2.3 配置查询的直接链接" title="3.2.3 配置查询的直接链接">​</a></h3>
<p>选择<strong>namespace</strong>和<strong>dataId</strong>后，可点击&quot;<strong>搜索（Search）</strong>&quot;按钮查询该配置下的所有配置项信息。</p>
<p>配置以配置项列表的形式呈现，每一行都代表一个配置项，以<strong>Key</strong>和<strong>Value</strong>展示。</p>
<p><img decoding="async" loading="lazy" alt="img" src="/zh-cn/assets/images/seata-raft-config-center配置查询-39fa5a191bbda09868f6d4ddc4ebdebc.png" width="1280" height="731" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="324-配置删除">3.2.4 配置删除<a href="#324-配置删除" class="hash-link" aria-label="3.2.4 配置删除的直接链接" title="3.2.4 配置删除的直接链接">​</a></h3>
<p>当不再需要某一套配置时，用户可以删除指定<strong>namespace</strong>和<strong>dataId</strong>的配置数据。</p>
<p>注意该操作一旦完成，会清空该配置下的所有配置项信息，且无法恢复。请避免删除正在使用中的配置。</p>
<p><img decoding="async" loading="lazy" alt="img" src="/zh-cn/assets/images/seata-raft-config-center配置删除-b0084f1a6663581cdb9c73338e059e08.png" width="1280" height="729" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="325-配置修改">3.2.5 配置修改<a href="#325-配置修改" class="hash-link" aria-label="3.2.5 配置修改的直接链接" title="3.2.5 配置修改的直接链接">​</a></h3>
<p>在配置项列表中，用户可以对该配置下的某个配置项进行<strong>新增</strong>、<strong>修改</strong>或<strong>删除</strong>操作。操作成功后Server端和Client端会及时收到配置变更，从而获取到最新的值。</p>
<ul>
<li><strong>新增：在当前配置下添加配置项</strong>。</li>
</ul>
<p><img decoding="async" loading="lazy" alt="img" src="/zh-cn/assets/images/seata-raft-config-center配置修改1-b1df6c2e83b37cd71c4c0601de6c2652.png" width="1280" height="729" class="img_ev3q"></p>
<ul>
<li><strong>修改：修改指定配置项的值。</strong></li>
</ul>
<p><img decoding="async" loading="lazy" alt="img" src="/zh-cn/assets/images/seata-raft-config-center配置修改2-7f23063fd4584d8fd27db66f9d3ef4e1.png" width="1280" height="731" class="img_ev3q"></p>
<ul>
<li><strong>删除：删除指定的配置项</strong>。</li>
</ul>
<p><img decoding="async" loading="lazy" alt="img" src="/zh-cn/assets/images/seata-raft-config-center配置修改3-eee28221e04d28731920c3a3e46797d2.png" width="1280" height="730" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="33-client端配置">3.3 Client端配置<a href="#33-client端配置" class="hash-link" aria-label="3.3 Client端配置的直接链接" title="3.3 Client端配置的直接链接">​</a></h2>
<p>Client需要添加如下的配置项。其中<code>raft.server-addr</code>需要和<strong>Server端Raft集群的IP地址列表</strong>一致。</p>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> raft </span><span class="token comment" style="color:#999988;font-style:italic"># Raft模式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">raft</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">server-addr</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 192.168.241.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">7091</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 192.168.241.2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">7091</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">192.168.241.3</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">7091</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 配置raft相关元数据的获取地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;seata&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 鉴权</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;seata&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 鉴权</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">db</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;default&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 命名空间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">dataId</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;seata.properties&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 配置文件Id</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>此外，client需要引入<strong>HttpClient</strong>依赖，用于通过Http请求向Seata-Server集群获取配置信息</p>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;dependency</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;groupId</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.httpcomponents&lt;/groupId</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;artifactId</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain">httpclient&lt;/artifactId</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/dependency</span><span class="token punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>配置完成后，Client应用启动时就会从<code>raft.server-addr</code>配置的Server中订阅并获取指定<strong>namespace</strong>和<strong>dataId</strong>的配置，并通过监听机制在配置发生变更时获取获取最新配置。</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="引言和概述"><meta itemprop="keywords" content="Seata、RPC模块、协议"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-rpc-multi-protocol01">Seata的RPC通信源码分析01：传输篇</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-08-15T00:00:00.000Z" itemprop="datePublished">2024年8月15日</time> · <!-- -->阅读需 9 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">谢明华</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="引言和概述">引言和概述<a href="#引言和概述" class="hash-link" aria-label="引言和概述的直接链接" title="引言和概述的直接链接">​</a></h2>
<p>在分布式系统中，通信协议的设计直接影响系统的可靠性和可扩展性。Apache Seata的RPC通信协议为各组件间的数据传输提供了基础，对这方面的源码分析是深入理解seata的又一个好方式。在最近的2.2.0版本里，我为Seata的通信机制进行了重构，以支持多版本协议的兼容性，现在改造完成了，我将从传输机制和通信协议两个方面去分析新版本里源码。
本文是第一篇，介绍Seata传输机制。</p>
<p>seata里的RPC通信主角是<code>TC</code>、<code>TM</code>、<code>RM</code>三者，当然过程中还可能会涉及注册中心甚至配置中心等其他网络交互，但这些相对内容所使用的通信机制是相对独立的，本文不作讨论。</p>
<p>接下来我将按照我最早了解源码时的几个直觉提问，带大家进行探索。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="seata中的netty谁在传输">Seata中的Netty（谁在传输）<a href="#seata中的netty谁在传输" class="hash-link" aria-label="Seata中的Netty（谁在传输）的直接链接" title="Seata中的Netty（谁在传输）的直接链接">​</a></h2>
<p>第一个问题：seata通信的底层是什么在进行发送请求报文和接收请求报文？答案是netty，而netty在seata里面是如何工作的呢？我们将去到core包的org.apache.seata.core.rpc.netty去探索</p>
<img src="/img/blog/rpc_multi-protocol/01-netty-class.jpg" width="700px">
<p>从这个继承关系我们可以看到，<code>AbstractNettyRemoting</code>作为核心的父类，RM和TM和Server(TC)都实现了他，实际上这个类里面已经实现了核心的发送和接收</p>
<p>在<code>sendSync</code>实现了同步发送逻辑，异步发送<code>sendAsync</code>的逻辑相似且更简单这里不再重复，只要拿到channel进行发送即可</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">protected</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sendSync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Channel</span><span class="token plain"> channel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">RpcMessage</span><span class="token plain"> rpcMessage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> timeoutMillis</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">TimeoutException</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 此处省略非关键代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">MessageFuture</span><span class="token plain"> messageFuture </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MessageFuture</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        messageFuture</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setRequestMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rpcMessage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        messageFuture</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setTimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timeoutMillis</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        futures</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rpcMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> messageFuture</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">channelWritableCheck</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rpcMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> remoteAddr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">ChannelUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getAddressFromChannel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">doBeforeRpcHooks</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">remoteAddr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rpcMessage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// netty的写方法(netty write)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">writeAndFlush</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rpcMessage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ChannelFutureListener</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> future </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">future</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isSuccess</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">MessageFuture</span><span class="token plain"> messageFuture1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> futures</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">remove</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rpcMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">messageFuture1 </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    messageFuture1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setResultMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">future</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">cause</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">destroyChannel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">future</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">channel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Object</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> messageFuture</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timeoutMillis</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">TimeUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">MILLISECONDS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">doAfterRpcHooks</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">remoteAddr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rpcMessage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Exception</span><span class="token plain"> exx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// 此处省略非关键代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>而接收报文的方式，主要在processMessage方法里，这个方法被<code>AbstractNettyRemotingClient.ClientHandler</code>和<code>AbstractNettyRemotingServer.ServerHandler</code>这两个类的channelRead调用，这两个内部类都是<code>ChannelDuplexHandler</code>的子类，他们各自注册在client和server的Bootstrap里（为什么注册到bootstrap就能进行接收操作？这个要移步netty的原理）</p>
<img src="/img/blog/rpc_multi-protocol/03-netty-handler.jpg" width="700px">
<p>收到信息后就会调进父类的<code>processMessage</code>方法里，我们来看看源码</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">protected</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">processMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ChannelHandlerContext</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">RpcMessage</span><span class="token plain"> rpcMessage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">Exception</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 此处省略非关键代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Object</span><span class="token plain"> body </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rpcMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">body </span><span class="token keyword" style="color:#00009f">instanceof</span><span class="token plain"> </span><span class="token class-name">MessageTypeAware</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">MessageTypeAware</span><span class="token plain"> messageTypeAware </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MessageTypeAware</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">Pair</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">RemotingProcessor</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">ExecutorService</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> pair </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">processorTable</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> messageTypeAware</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getTypeCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pair </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// 这里可读性稍微差点，first是Processor，表示普通处理，而second是线程池，表示池化处理。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pair</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getSecond</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pair</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getSecond</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                pair</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getFirst</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rpcMessage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Throwable</span><span class="token plain"> th</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">FrameworkErrorCode</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">NetDispatch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getErrCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> th</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> th</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">finally</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token constant" style="color:#36acaa">MDC</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">RejectedExecutionException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">// 此处省略非关键代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pair</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getFirst</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rpcMessage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Throwable</span><span class="token plain"> th</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">FrameworkErrorCode</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">NetDispatch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getErrCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> th</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> th</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;This message type [{}] has no processor.&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> messageTypeAware</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getTypeCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;This rpcMessage body[{}] is not MessageTypeAware type.&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>实际上这些processor和executor是client和server注册进来的处理器：下面是一部分的处理器，他们对应着不同的MessageType，以下是部分处理器的注册举例（他们在NettyRemotingServer#registerProcessor）</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerProcessor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MessageType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">TYPE_GLOBAL_ROLLBACK</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> onRequestProcessor</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> messageExecutor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerProcessor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MessageType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">TYPE_GLOBAL_STATUS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> onRequestProcessor</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> messageExecutor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerProcessor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MessageType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">TYPE_SEATA_MERGE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> onRequestProcessor</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> messageExecutor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerProcessor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MessageType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">TYPE_BRANCH_COMMIT_RESULT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> onResponseProcessor</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branchResultMessageExecutor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerProcessor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MessageType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">TYPE_BRANCH_ROLLBACK_RESULT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> onResponseProcessor</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branchResultMessageExecutor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerProcessor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MessageType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">TYPE_REG_RM</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> regRmProcessor</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> messageExecutor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerProcessor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MessageType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">TYPE_REG_CLT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> regTmProcessor</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以看到这些processor实际上就是seata各种提交回滚等等的处理器</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="seata中的nettychannelchannel怎么管理">Seata中的NettyChannel（channel怎么管理）<a href="#seata中的nettychannelchannel怎么管理" class="hash-link" aria-label="Seata中的NettyChannel（channel怎么管理）的直接链接" title="Seata中的NettyChannel（channel怎么管理）的直接链接">​</a></h2>
<p>那第二个问题，既然上面是netty依靠着channel在进行着收发，那这个channel怎么来呢？会一直持有吗？如果断了怎么重连？答案在<code>ChannelManager</code>和上面的两个reg的<code>processor</code>。</p>
<p>当RM/TM取得了server的地址，进行注册的时候（第一次通信），如果server能成功解析报文并发现是REG信息，就会进入<code>regRmProcessor</code>/<code>regTmProcessor</code>，这里以TM为例子</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// server接收 RegTmProcessor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">onRegTmMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ChannelHandlerContext</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">RpcMessage</span><span class="token plain"> rpcMessage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">RegisterTMRequest</span><span class="token plain"> message </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">RegisterTMRequest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> rpcMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> ipAndPort </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">NetUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toStringAddress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">channel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">remoteAddress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Version</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">putChannelVersion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">channel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getVersion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> isSuccess </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> errorInfo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">StringUtils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">EMPTY</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> checkAuthHandler </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> checkAuthHandler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">regTransactionManagerCheckAuth</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// 在ChannelManager中注册channel，这里可以预见到注册之后，server进行sendSync(channel,xxx)的时候就可以拿到这个channel了</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">ChannelManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerTMChannel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">channel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">Version</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">putChannelVersion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">channel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getVersion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                isSuccess </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Exception</span><span class="token plain"> exx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            isSuccess </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            errorInfo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> exx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;TM register fail, error message:{}&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> errorInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">RegisterTMResponse</span><span class="token plain"> response </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">RegisterTMResponse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">isSuccess</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 异步回复</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        remotingServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sendAsyncResponse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rpcMessage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">channel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> response</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 此处省略非关键代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//    ChannelManager</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">registerTMChannel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">RegisterTMRequest</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Channel</span><span class="token plain"> channel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">IncompatibleVersionException</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">RpcContext</span><span class="token plain"> rpcContext </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">buildChannelHolder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">NettyPoolKey</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">TransactionRole</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">TMROLE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getVersion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getApplicationId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getTransactionServiceGroup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> channel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rpcContext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">holdInIdentifiedChannels</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">IDENTIFIED_CHANNELS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> clientIdentified </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rpcContext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getApplicationId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token class-name">Constants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">CLIENT_ID_SPLIT_CHAR</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token class-name">ChannelUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getClientIpFromChannel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ConcurrentMap</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Integer</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">RpcContext</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> clientIdentifiedMap </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">CollectionUtils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">computeIfAbsent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">TM_CHANNELS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> clientIdentified</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ConcurrentHashMap</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rpcContext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">holdInClientChannels</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">clientIdentifiedMap</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在ChannelManager里管理着<code>RM_CHANNELS</code>和<code>RM_CHANNELS</code>两个比较复杂的map，特别是RM_CHANNELS里面有4层（resourceId -&gt; applicationId -&gt; ip -&gt; port -&gt; RpcContext）</p>
<p>说完了server对channel的管理，那client呢？这个map管理更简单一些，就是注册成功后在onRegisterMsgSuccess里面也用一个<code>NettyClientChannelManager</code>里registerChannel，后续跟server交互尽量都用这个channel。</p>
<p>那么第三个问题又来了，client的channel不可用了可以自行新建，可是server接收后发现这是新channel怎么办？或者server在异步回复的时候发现channel不可用了怎么办？
答案依然在<code>NettyClientChannelManager</code>，这里面相对复杂的是，client方面需要用到channel的时候，实际上由一个对象池<code>nettyClientKeyPool</code>管理着，这是个apache的objectPool，所以当channel不可用时也会由这个池子去新增并在使用完后入池。这个对象池实际上是一直持有着<code>RegisterTMRequest</code>，跟第一次进来时一样，每次创建需要创建channel的时候，实际上都发生了一次注册</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// NettyClientChannelManager</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">Channel</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">makeObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">NettyPoolKey</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">InetSocketAddress</span><span class="token plain"> address </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">NetUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toInetSocketAddress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getAddress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isInfoEnabled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;NettyPool create channel to &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Channel</span><span class="token plain"> tmpChannel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> clientBootstrap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getNewChannel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Object</span><span class="token plain"> response</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Channel</span><span class="token plain"> channelToServer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// key持有RegisterTMRequest</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">FrameworkException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;register msg is null, role:&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getTransactionRole</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// 实际上是在进行reg操作</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            response </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rpcRemotingClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sendSyncRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tmpChannel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">isRegisterSuccess</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">response</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getTransactionRole</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                rpcRemotingClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">onRegisterMsgFail</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getAddress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tmpChannel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> response</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                channelToServer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tmpChannel</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// 成功后会入池</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                rpcRemotingClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">onRegisterMsgSuccess</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getAddress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tmpChannel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> response</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 此处省略非关键代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> channelToServer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="最后">最后<a href="#最后" class="hash-link" aria-label="最后的直接链接" title="最后的直接链接">​</a></h2>
<p>这一篇我们了解了seata是怎样借助netty来传输数据的，为了更好的看懂netty处理的全貌，我画了个层级图</p>
<img src="/img/blog/rpc_multi-protocol/00-netty-layer.png" width="700px">
<p>上面已经讲了请求发送时，serverHandler/clientHandler和NettyRemoting(包括RM、TM、TC)的处理，知道了从外部到netty处理器再到内部的DefaultCoordinator的过程，但我们还缺Decoder/Encoder没讲，这里面会进行协议的解析/封装，也会进行序列化和反序列化，请看 <a href="/zh-cn/blog/seata-rpc-multi-protocol02">Seata的RPC通信源码分析02：协议篇</a></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="引言和概述"><meta itemprop="keywords" content="Seata、RPC模块、协议"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-rpc-multi-protocol02">Seata的RPC通信源码分析02：协议篇（多版本协议）</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-08-15T00:00:00.000Z" itemprop="datePublished">2024年8月15日</time> · <!-- -->阅读需 11 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">谢明华</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="引言和概述">引言和概述<a href="#引言和概述" class="hash-link" aria-label="引言和概述的直接链接" title="引言和概述的直接链接">​</a></h3>
<p>上一篇<a href="/zh-cn/blog/seata-rpc-multi-protocol01">Seata的RPC通信源码分析01：传输篇</a>已经介绍了RPC通信的传输机制，这一篇我们继续来看协议部分的内容，把这个图里没解析清楚的encode/decode部分给补充完整。</p>
<img src="/img/blog/rpc_multi-protocol/00-netty-layer.png" width="700px">
<p>同样的，我们以提问来深入的方式去探究它。在本文中，我们不仅要了解二进制如何解析成rpcMsg类型，还要知道如何兼容不同版本的协议，那么第一个问题：协议长什么样？</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="协议结构">协议结构<a href="#协议结构" class="hash-link" aria-label="协议结构的直接链接" title="协议结构的直接链接">​</a></h2>
<img src="/img/blog/rpc_multi-protocol/04-protocol.jpg" width="900px">
<p>上图展示了协议在0.7.1之前和之后的变化，（在ProtocolDecoderV1的注释也可以看到，更旧版本的要看ProtocolV1Decoder），可以看到新版本的有以下这些构成部分</p>
<ul>
<li>magic-code：0xdada</li>
<li>protocal-verson：版本号</li>
<li>full-length：总长度</li>
<li>head-length：头部长度</li>
<li>msgtype：消息类型</li>
<li>serializer/codecType：序列化方式</li>
<li>compress：压缩方式</li>
<li>requestid：请求id</li>
</ul>
<p>这里我们说明一下seata各版本的server之间对协议的处理差异</p>
<ul>
<li>version<code>&lt;</code>0.7.1 : 只能处理v0版本的协议（上图中的上半部分，带有flag段的），无法识别其他版本协议</li>
<li>0.7.1<code>&lt;=</code>version<code>&lt;</code>2.2.0 : 只能处理v1版本的协议（上图中的下半部分），无法识别其他版本协议</li>
<li>version<code>&gt;=</code>2.2.0 : 可以同时识别v0和v1版本的协议，并处理</li>
</ul>
<p>那么2.2.0是怎样做到兼容的呢？先卖个关子，在说明这个之前我们先看看v1的encoder和decoder分别都是怎样运作的。需要注意的是，和之前提到的传输机制一样，协议处理也是client和server共用的，所以下面提到的都是通用逻辑。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="从bytebuf到rpcmessageencoderdecoder做了什么">从ByteBuf到RpcMessage（Encoder/Decoder做了什么）<a href="#从bytebuf到rpcmessageencoderdecoder做了什么" class="hash-link" aria-label="从ByteBuf到RpcMessage（Encoder/Decoder做了什么）的直接链接" title="从ByteBuf到RpcMessage（Encoder/Decoder做了什么）的直接链接">​</a></h2>
<p>先来看<code>ProtocolDecoderV1</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">RpcMessage</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">decodeFrame</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ByteBuf</span><span class="token plain"> frame</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">byte</span><span class="token plain"> b0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> frame</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readByte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">byte</span><span class="token plain"> b1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> frame</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readByte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 获取version</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">byte</span><span class="token plain"> version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> frame</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readByte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 获取header和body以外的字段</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> fullLength </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> frame</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readInt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">short</span><span class="token plain"> headLength </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> frame</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readShort</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">byte</span><span class="token plain"> messageType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> frame</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readByte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">byte</span><span class="token plain"> codecType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> frame</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readByte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">byte</span><span class="token plain"> compressorType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> frame</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readByte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> requestId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> frame</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readInt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ProtocolRpcMessageV1</span><span class="token plain"> rpcMessage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ProtocolRpcMessageV1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rpcMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setCodec</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">codecType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rpcMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">requestId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rpcMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setCompressor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">compressorType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rpcMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setMessageType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">messageType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 头部信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> headMapLength </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> headLength </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token class-name">ProtocolConstants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">V1_HEAD_LENGTH</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">headMapLength </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> map </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">HeadMapSerializer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">frame</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> headMapLength</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            rpcMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getHeadMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">putAll</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">map</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 如果是心跳信息不需要对body进行序列化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">messageType </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token class-name">ProtocolConstants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">MSGTYPE_HEARTBEAT_REQUEST</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            rpcMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HeartbeatMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">PING</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">messageType </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token class-name">ProtocolConstants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">MSGTYPE_HEARTBEAT_RESPONSE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            rpcMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HeartbeatMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">PONG</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> bodyLength </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fullLength </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> headLength</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bodyLength </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> bs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">bodyLength</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                frame</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// 根据刚才得到的compressorType来按需做解压处理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">Compressor</span><span class="token plain"> compressor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">CompressorFactory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCompressor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">compressorType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                bs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> compressor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decompress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">SerializerType</span><span class="token plain"> protocolType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">SerializerType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getByCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rpcMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCodec</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">supportDeSerializerTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">contains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">protocolType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// 序列化器，由于这个是v1专用的ProtocolDecoderV1，所以可以直接传入version1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name">Serializer</span><span class="token plain"> serializer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">SerializerServiceLoader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">protocolType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">ProtocolConstants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">VERSION_1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    rpcMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">serializer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">deserialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">IllegalArgumentException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;SerializerType not match&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> rpcMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">protocolMsg2RpcMsg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>由于encode操作正好和decode操作相反，这里不再重复介绍，我们继续看里面的serialize操作。上面的serialize类来自<code>SerializerServiceLoader</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">Serializer</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">SerializerType</span><span class="token plain"> type</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">byte</span><span class="token plain"> version</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">EnhancedServiceNotFoundException</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 先处理PROTOBUF方式的序列化，通过反射工具取得</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token class-name">SerializerType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">PROTOBUF</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">ReflectionUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getClassByName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">PROTOBUF_SERIALIZER_CLASS_NAME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ClassNotFoundException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">EnhancedServiceNotFoundException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;&#x27;ProtobufSerializer&#x27; not found. &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token string" style="color:#e3116c">&quot;Please manually reference &#x27;org.apache.seata:seata-serializer-protobuf&#x27; dependency &quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">serialzerKey</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> version</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 这里是一个SERIALIZER_MAP，相当于序列化类的缓存。为什么需要缓存，因为SeataSerializer的scope = Scope.PROTOTYPE，防止多次创建类</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Serializer</span><span class="token plain"> serializer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">SERIALIZER_MAP</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">serializer </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token class-name">SerializerType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">SEATA</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// 这里是seata的SPI机制，本文不再往里深入加载类的逻辑，只需要知道去加载Serializer这个接口，并且把version给到了构造方法</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                serializer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">EnhancedServiceLoader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Serializer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> type</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">version</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                serializer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">EnhancedServiceLoader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Serializer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> type</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token constant" style="color:#36acaa">SERIALIZER_MAP</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> serializer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> serializer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 这里是SeataSerializer构造方法，里面是单例模式的构造器，因为现在是两个版本各一个类，也可以说是双例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">SeataSerializer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Byte</span><span class="token plain"> version</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">version </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token class-name">ProtocolConstants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">VERSION_0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            versionSeataSerializer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">SeataSerializerV0</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">version </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token class-name">ProtocolConstants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">VERSION_1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            versionSeataSerializer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">SeataSerializerV1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">versionSeataSerializer </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">UnsupportedOperationException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;version is not supported&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这样，decoder就得到了一个Serializer，程序运行到<code>rpcMessage.setBody(serializer.deserialize(bs))</code>，我们来看看deserialize是怎样处理的</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">T</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">deserialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> bytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">deserializeByVersion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bytes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">ProtocolConstants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">VERSION_0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">T</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">deserializeByVersion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> bytes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">byte</span><span class="token plain"> version</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//前面是合法性判断，此处忽略</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ByteBuffer</span><span class="token plain"> byteBuffer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">ByteBuffer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">wrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">short</span><span class="token plain"> typecode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> byteBuffer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getShort</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ByteBuffer</span><span class="token plain"> in </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> byteBuffer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">slice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//创建父类，并根据版本号创建Codec</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">AbstractMessage</span><span class="token plain"> abstractMessage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">MessageCodecFactory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">typecode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">MessageSeataCodec</span><span class="token plain"> messageCodec </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">MessageCodecFactory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getMessageCodec</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">typecode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> version</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//codec的decode操作</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        messageCodec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">abstractMessage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> in</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> abstractMessage</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复  制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>很遗憾，这个serialize并没有太多逻辑，关键还是在MessageCodecFactory和Codec，我们继续往里看。可以看到<code>MessageCodecFactory</code>内容不少，但形式单一，都是根据MessageType返回message和codec，所以这里不再展示factory的内容，我们直接看message和codec，也就是<code>messageCodec.decode(abstractMessage, in)</code>，虽然codec类型还是很多，但我们可以看到他们的结构都是相似的，逐个字段解析：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// BranchRegisterRequestCodec的decode，这个请求是注册一个事务分支</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">T</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">decode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">T</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">ByteBuffer</span><span class="token plain"> in</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">BranchRegisterRequest</span><span class="token plain"> branchRegisterRequest </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">BranchRegisterRequest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 解析xid</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">short</span><span class="token plain"> xidLen </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> in</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getShort</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">xidLen </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> bs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">xidLen</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            in</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            branchRegisterRequest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setXid</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UTF8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 解析branchType</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        branchRegisterRequest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setBranchType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">BranchType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">short</span><span class="token plain"> len </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> in</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getShort</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">len </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> bs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">len</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            in</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            branchRegisterRequest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setResourceId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UTF8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 解析lockKey</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> iLen </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> in</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getInt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">iLen </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> bs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">iLen</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            in</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            branchRegisterRequest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setLockKey</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UTF8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 解析applicationData</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> applicationDataLen </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> in</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getInt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">applicationDataLen </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> bs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">applicationDataLen</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            in</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            branchRegisterRequest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setApplicationData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UTF8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>好了，到这里，我们已经得到了branchRegisterRequest，可以愉快地交给TCInboundHandler处理了。</p>
<p>但是问题又来了，我们只看到client（RM/TM）有以下这种添加encoder/decoder的代码，也就是我们知道client都使用当前版本的encoder/decoder处理：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        bootstrap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ChannelInitializer</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">SocketChannel</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initChannel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">SocketChannel</span><span class="token plain"> ch</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name">ChannelPipeline</span><span class="token plain"> pipeline </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pipeline</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addLast</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">IdleStateHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nettyClientConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getChannelMaxReadIdleSeconds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">nettyClientConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getChannelMaxWriteIdleSeconds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">nettyClientConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getChannelMaxAllIdleSeconds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addLast</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ProtocolDecoderV1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addLast</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ProtocolEncoderV1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">channelHandlers </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token function" style="color:#d73a49">addChannelPipelineLast</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> channelHandlers</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>但server如何处理？还有说好的多版本协议呢？</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="多版本协议版本识别和绑定">多版本协议（版本识别和绑定）<a href="#多版本协议版本识别和绑定" class="hash-link" aria-label="多版本协议（版本识别和绑定）的直接链接" title="多版本协议（版本识别和绑定）的直接链接">​</a></h2>
<p>我们先来看encoder/decoder的一个类图：</p>
<img src="/img/blog/rpc_multi-protocol/05-encode-decode-class.jpg" width="800px">
<p>ProtocolDecoderV1我们已经分析完了，ProtocolEncoderV1是反向操作，应该比较好理解，至 于ProtocolDecoderV0和ProtocolEncoderV0，从图上也可以看到他们和v1是平行关系，除了v0的操作（虽然目前为止我们还没让他派上用场），他们都是netty里典型的encode和decode的子类，但MultiProtocolDecoder又是什么？他是多版本协议的主角，而且在启动的时候已经注册进server的bootstrap。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">protected</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">isV0</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ByteBuf</span><span class="token plain"> in</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> isV0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        in</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">markReaderIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">byte</span><span class="token plain"> b0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> in</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readByte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">byte</span><span class="token plain"> b1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> in</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readByte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 实际上，识别协议就靠第3个byte(b2)，只要是正常的新版本，b2就是大于0的版本号，而对于0.7以下的版本来说，b2是FLAG的第一位，正好无论是哪种情况他都是0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// v1/v2/v3 : b2 = version</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// v0 : b2 = 0 ,1st byte in FLAG(2byte:0x10/0x20/0x40/0x80)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">byte</span><span class="token plain"> b2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> in</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readByte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ProtocolConstants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">MAGIC_CODE_BYTES</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> b0 </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token class-name">ProtocolConstants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">MAGIC_CODE_BYTES</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> b1 </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> b2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            isV0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 读完的字节还要吐回去，为了让各版本的decoder能从头解析</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        in</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">resetReaderIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> isV0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">protected</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">decode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ChannelHandlerContext</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">ByteBuf</span><span class="token plain"> in</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">Exception</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ByteBuf</span><span class="token plain"> frame</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Object</span><span class="token plain"> decoded</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">byte</span><span class="token plain"> version</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// 识别版本号，获取当前版本号</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">isV0</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                decoded </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> in</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">ProtocolConstants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">VERSION_0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                decoded </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> in</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">decideVersion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">decoded</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">decoded </span><span class="token keyword" style="color:#00009f">instanceof</span><span class="token plain"> </span><span class="token class-name">ByteBuf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                frame </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> decoded</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">ProtocolDecoder</span><span class="token plain"> decoder </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> protocolDecoderMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">version</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">ProtocolEncoder</span><span class="token plain"> encoder </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> protocolEncoderMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">version</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">decoder </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> encoder </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">UnsupportedOperationException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Unsupported version: &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> version</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// 首次进来，使用判断好的decoder进行操作</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> decoder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decodeFrame</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">frame</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">finally</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">version </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token class-name">ProtocolConstants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">VERSION_0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        frame</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">release</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// 首次进来，绑定对应version的encoder和decoder，也就相当于绑定了channel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addLast</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ChannelHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">decoder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addLast</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ChannelHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">encoder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">channelHandlers </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addLast</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">channelHandlers</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// 绑定好之后，将自身移除，后续不再判断</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">remove</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Exception</span><span class="token plain"> exx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Decode frame error, cause: {}&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">DecodeException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> decoded</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">protected</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">byte</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">decideVersion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Object</span><span class="token plain"> in</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in </span><span class="token keyword" style="color:#00009f">instanceof</span><span class="token plain"> </span><span class="token class-name">ByteBuf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">ByteBuf</span><span class="token plain"> frame </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> in</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            frame</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">markReaderIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">byte</span><span class="token plain"> b0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> frame</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readByte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">byte</span><span class="token plain"> b1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> frame</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readByte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// 和isV0方法相似，取第3个byte</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ProtocolConstants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">MAGIC_CODE_BYTES</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> b0 </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token class-name">ProtocolConstants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">MAGIC_CODE_BYTES</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> b1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">IllegalArgumentException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Unknown magic code: &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> b0 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;, &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> b1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">byte</span><span class="token plain"> version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> frame</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readByte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            frame</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">resetReaderIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> version</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>通过上面的分析，v0终于派上用场（当有旧版本的client注册时，server就会为其分配低版本的encoder/decoder），我们也摸清了多版本协议如何识别、如何绑定。</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="这篇文章主要介绍了Seata中已经使用的测试用例相关框架，以及社区建议开发者如何更好的编写测试用例"><meta itemprop="keywords" content="Seata,unit test,junit,mockito,assertj"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/how-to-write-unit-tests">如何在seata中编写测试用例</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-02-20T00:00:00.000Z" itemprop="datePublished">2024年2月20日</time> · <!-- -->阅读需 10 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">汪忠祥 - trustdecision 技术专家</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="背景">背景<a href="#背景" class="hash-link" aria-label="背景的直接链接" title="背景的直接链接">​</a></h2>
<p>随着 Seata 项目的不断发展和壮大，我们的贡献者群体也在持续扩大。项目的功能不断增强，对于代码质量的要求也在提高。在这个过程中，我们期望每一位贡献者在提交功能代码的同时，能够附带规范、完备的测试用例。</p>
<p>一个优秀的项目，其完备的单元测试是基本保障。Test-Driven Development（TDD）理念已经提出多年，它强调在编写功能代码之前先编写测试用例。通过编写单元测试，开发者可以更深入地理解代码中相关类和方法的作用，掌握核心逻辑，熟悉各种场景的运行情况。同时，单元测试也为开源项目提供了稳定安全的保障，使得项目在接受贡献者代码时，能够确保代码的质量和稳定性。  单元测试是质量保障的第一环，有效的单元测试能够提前发现90%以上的代码Bug问题，同时也能防止代码的腐化。在项目重构和演进过程中，单元测试起到了至关重要的作用，它能够确保重构后的代码仍然能够正常工作，不会引入新的Bug。</p>
<p>在社区看来，贡献合理的测试用例代码和贡献功能代码同样重要，为了帮助开发者编写出高质量的测试用例，本文给出一些基础的规范和建议。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="推荐的框架">推荐的框架<a href="#推荐的框架" class="hash-link" aria-label="推荐的框架的直接链接" title="推荐的框架的直接链接">​</a></h2>
<p>当前社区使用以下三个框架编写测试用例；</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="junit5">junit5<a href="#junit5" class="hash-link" aria-label="junit5的直接链接" title="junit5的直接链接">​</a></h3>
<p>junit是Java中最常用的单元测试框架，用于编写和运行可重复的测试用例。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">junit</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">jupiter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5.8</span><span class="token number" style="color:#36acaa">.2</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">junit</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">jupiter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">dependency</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">groupId</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">org</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">junit</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">groupId</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">artifactId</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">junit</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">bom</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">artifactId</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">version</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">junit</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">jupiter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">version</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dependency</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mockito">mockito<a href="#mockito" class="hash-link" aria-label="mockito的直接链接" title="mockito的直接链接">​</a></h3>
<p><a href="https://javadoc.io/static/org.mockito/mockito-core/5.10.0/org/mockito/Mockito.html" target="_blank" rel="noopener noreferrer">mockito</a>是一个mock框架，主要是用来做mock测试，他可以模拟任何 Spring管理的 bean、模拟方法的返回值、模拟抛出异常等，可以让我们在缺乏一些依赖的情况下，完成测试及验证。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">mockito</span><span class="token generics punctuation" style="color:#393A34">.</span><span class="token generics">version</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">4.11</span><span class="token number" style="color:#36acaa">.0</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mockito</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">dependency</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">groupId</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">org</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mockito</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">groupId</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">artifactId</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">mockito</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">core</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">artifactId</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">version</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">mockito</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">version</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dependency</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">dependency</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">groupId</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">org</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mockito</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">groupId</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">artifactId</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">mockito</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">junit</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">jupiter</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">artifactId</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">version</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">mockito</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">version</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dependency</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">dependency</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">groupId</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">org</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mockito</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">groupId</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">artifactId</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">mockito</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">inline</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">artifactId</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">version</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">mockito</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">version</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dependency</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="assertj">assertj<a href="#assertj" class="hash-link" aria-label="assertj的直接链接" title="assertj的直接链接">​</a></h3>
<p>assertj是一个断言库，提供了一组易于使用和可读性很强的断言方法，当junit的断言难以满足时，可以使用assertj进行断言；</p>
<p>请注意：我们在seata-dependencies的pom.xml中统一管理了这三个库的版本。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">assertj</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">3.12</span><span class="token number" style="color:#36acaa">.2</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">assertj</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">dependency</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">groupId</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">org</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">assertj</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">groupId</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">artifactId</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">assertj</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">core</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">artifactId</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">version</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">assertj</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">version</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dependency</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="规范">规范<a href="#规范" class="hash-link" aria-label="规范的直接链接" title="规范的直接链接">​</a></h2>
<p>我们参考阿里巴巴JAVA开发手册，整理了一些建议及规范，分为不同的级别，其中【【强制】部分，开发者需要严格遵守，社区在合并代码时会按照强制规则进行review，【【推荐】【参考】部分，方便大家更好的了解我们对于测试用例的考量和原则。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="1强制单元测试必须遵守-air-原则">1.【强制】单元测试必须遵守 AIR 原则。<a href="#1强制单元测试必须遵守-air-原则" class="hash-link" aria-label="1.【强制】单元测试必须遵守 AIR 原则。的直接链接" title="1.【强制】单元测试必须遵守 AIR 原则。的直接链接">​</a></h5>
<p>说明：好的单元测试宏观上来说，具有自动化、独立性、可重复执行的特点。</p>
<ul>
<li>A：Automatic（自动化）</li>
<li>I：Independent（独立性）</li>
<li>R：Repeatable（可重复）</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="2强制单元测试应该是全自动执行的并且非交互式的">2.【强制】单元测试应该是全自动执行的，并且非交互式的。<a href="#2强制单元测试应该是全自动执行的并且非交互式的" class="hash-link" aria-label="2.【强制】单元测试应该是全自动执行的，并且非交互式的。的直接链接" title="2.【强制】单元测试应该是全自动执行的，并且非交互式的。的直接链接">​</a></h5>
<p>测试用例通常是被定期执行的，执行过程必须完全自动化才有意义。输出结果需要人工检查的测试不是一个好的单元测试。单元测试中不准使用 System.out 来进行人肉验证，必须使用 assert 来验证。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="3强制保持单元测试的独立性为了保证单元测试稳定可靠且便于维护单元测试用例之间决不能互相调用也不能依赖执行的先后次序">3.【强制】保持单元测试的独立性。为了保证单元测试稳定可靠且便于维护，单元测试用例之间决不能互相调用，也不能依赖执行的先后次序。<a href="#3强制保持单元测试的独立性为了保证单元测试稳定可靠且便于维护单元测试用例之间决不能互相调用也不能依赖执行的先后次序" class="hash-link" aria-label="3.【强制】保持单元测试的独立性。为了保证单元测试稳定可靠且便于维护，单元测试用例之间决不能互相调用，也不能依赖执行的先后次序。的直接链接" title="3.【强制】保持单元测试的独立性。为了保证单元测试稳定可靠且便于维护，单元测试用例之间决不能互相调用，也不能依赖执行的先后次序。的直接链接">​</a></h5>
<p>反例：method2 需要依赖 method1 的执行，将执行结果作为 method2 的输入。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="4强制单元测试是可以重复执行的不能受到外界环境的影响">4.【强制】单元测试是可以重复执行的，不能受到外界环境的影响。<a href="#4强制单元测试是可以重复执行的不能受到外界环境的影响" class="hash-link" aria-label="4.【强制】单元测试是可以重复执行的，不能受到外界环境的影响。的直接链接" title="4.【强制】单元测试是可以重复执行的，不能受到外界环境的影响。的直接链接">​</a></h5>
<p>说明：单元测试通常会被放到持续集成中，每次有代码 check in 时单元测试都会被执行。如果单测对外部环境（网络、服务、中间件等）有依赖，容易导致持续集成机制的不可用。</p>
<p>正例：为了不受外界环境影响，要求设计代码时就把 SUT 的依赖改成注入，在测试时用 spring 这样的 DI框架注入一个本地（内存）实现或者 Mock 实现。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="5强制对于单元测试要保证测试粒度足够小有助于精确定位问题单测粒度至多是类级别一般是方法级别">5.【强制】对于单元测试，要保证测试粒度足够小，有助于精确定位问题。单测粒度至多是类级别，一般是方法级别。<a href="#5强制对于单元测试要保证测试粒度足够小有助于精确定位问题单测粒度至多是类级别一  般是方法级别" class="hash-link" aria-label="5.【强制】对于单元测试，要保证测试粒度足够小，有助于精确定位问题。单测粒度至多是类级别，一般是方法级别。的直接链接" title="5.【强制】对于单元测试，要保证测试粒度足够小，有助于精确定位问题。单测粒度至多是类级别，一般是方法级别。的直接链接">​</a></h5>
<p>说明：只有测试粒度小才能在出错时尽快定位到出错位置。单测不负责检查跨类或者跨系统的交互逻辑，那是集成测试的领域。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="6强制核心业务核心应用核心模块的增量代码确保单元测试通过">6.【强制】核心业务、核心应用、核心模块的增量代码确保单元测试通过。<a href="#6强制核心业务核心应用核心模块的增量代码确保单元测试通过" class="hash-link" aria-label="6.【强制】核心业务、核心应用、核心模块的增量代码确保单元测试通过。的直接链接" title="6.【强制】核心业务、核心应用、核心模块的增量代码确保单元测试通过。的直接链接">​</a></h5>
<p>说明：新增代码及时补充单元测试，如果新增代码影响了原有单元测试，请及时修正。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="7强制单元测试代码必须写在如下工程目录srctestjava不允许写在业务代码目录下">7.【强制】单元测试代码必须写在如下工程目录：src/test/java，不允许写在业务代码目录下。<a href="#7强制单元测试代码必须写在如下工程目录srctestjava不允许写在业务代码目录下" class="hash-link" aria-label="7.【强制】单元测试代码必须写在如下工程目录：src/test/java，不允许写在业务代码目录下。的直接链接" title="7.【强制】单元测试代码必须写在如下工程目录：src/test/java，不允许写在业务代码目录下。的直接链接">​</a></h5>
<p>说明：源 码编译时会跳过此目录，而单元测试框架默认是扫描此目录。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="8强制单元测试的基本目标语句覆盖率达到-70核心模块的语句覆盖率和分支覆盖率都要达到-100">8.【强制】单元测试的基本目标：语句覆盖率达到 70%；核心模块的语句覆盖率和分支覆盖率都要达到 100%。<a href="#8强制单元测试的基本目标语句覆盖率达到-70核心模块的语句覆盖率和分支覆盖率都要达到-100" class="hash-link" aria-label="8.【强制】单元测试的基本目标：语句覆盖率达到 70%；核心模块的语句覆盖率和分支覆盖率都要达到 100%。的直接链接" title="8.【强制】单元测试的基本目标：语句覆盖率达到 70%；核心模块的语句覆盖率和分支覆盖率都要达到 100%。的直接链接">​</a></h5>
<p>说明：在工程规约的应用分层中提到的 DAO 层，Manager 层，可重用度高的 Service，都应该进行单元测试。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="9推荐编写单元测试代码遵守-bcde-原则以保证被测试模块的交付质量">9.【推荐】编写单元测试代码遵守 BCDE 原则，以保证被测试模块的交付质量。<a href="#9推荐编写单元测试代码遵守-bcde-原则以保证被测试模块的交付质量" class="hash-link" aria-label="9.【推荐】编写单元测试代码遵守 BCDE 原则，以保证被测试模块的交付质量。的直接链接" title="9.【推荐】编写单元测试代码遵守 BCDE 原则，以保证被测试模块的交付质量。的直接链接">​</a></h5>
<ul>
<li>B：Border，边界值测试，包括循环边界、特殊取值、特殊时间点、数据顺序等。</li>
<li>C：Correct，正确的输入，并得到预期的结果。</li>
<li>D：Design，与设计文档相结合，来编写单元测试。</li>
<li>E：Error，强制错误信息输入（如：非法数据、异常流程、业务允许外等），并得到预  期的结果。</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="10推荐对于数据库相关的查询更新删除等操作不能假设数据库里的数据是存在的或者直接操作数据库把数据插入进去请使用程序插入或者导入数据的方式来准备数据">10.【推荐】对于数据库相关的查询，更新，删除等操作，不能假设数据库里的数据是存在的，或者直接操作数据库把数据插入进去，请使用程序插入或者导入数据的方式来准备数据。<a href="#10推荐对于数据库相关的查询更新删除等操作不能假设数据库里的数据是存在的或者直接操作数据库把数据插入进去请使用程序插入或者导入数据的方式来准备数据" class="hash-link" aria-label="10.【推荐】对于数据库相关的查询，更新，删除等操作，不能假设数据库里的数据是存在的，或者直接操作数据库把数据插入进去，请使用程序插入或者导入数据的方式来准备数据。的直接链接" title="10.【推荐】对于数据库相关的查询，更新，删除等操作，不能假设数据库里的数据是存在的，或者直接操作数据库把数据插入进去，请使用程序插入或者导入数据的方式来准备数据。的直接链接">​</a></h5>
<p>反例：删除某一行数据的单元测试，在数据库中，先直接手动增加一行作为删除目标，但是这一行新增数据并不符合业务插入规则，导致测试结果异常。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="11推荐和数据库相关的单元测试可以设定自动回滚机制不给数据库造成脏数据或者对单元测试产生的数据有明确的前后缀标识">11.【推荐】和数据库相关的单元测试，可以设定自动回滚机制，不给数据库造成脏数据。或者对单元测试产生的数据有明确的前后缀标识。<a href="#11推荐和数据库相关的单元测试可以设定自动回滚机制不给数据库造成脏数据  或者对单元测试产生的数据有明确的前后缀标识" class="hash-link" aria-label="11.【推荐】和数据库相关的单元测试，可以设定自动回滚机制，不给数据库造成脏数据。或者对单元测试产生的数据有明确的前后缀标识。的直接链接" title="11.【推荐】和数据库相关的单元测试，可以设定自动回滚机制，不给数据库造成脏数据。或者对单元测试产生的数据有明确的前后缀标识。的直接链接">​</a></h5>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="12推荐对于不可测的代码在适当的时机做必要的重构使代码变得可测避免为了达到测试要求而书写不规范测试代码">12.【推荐】对于不可测的代码在适当的时机做必要的重构，使代码变得可测，避免为了达到测试要求而书写不规范测试代码。<a href="#12推荐对于不可测的代码在适当的时机做必要的重构使代码变得可测避免为了达到测试要求而书写不规范测试代码" class="hash-link" aria-label="12.【推荐】对于不可测的代码在适当的时机做必要的重构，使代码变得可测，避免为了达到测试要求而书写不规范测试代码。的直接链接" title="12.【推荐】对于不可测的代码在适当的时机做必要的重构，使代码变得可测，避免为了达到测试要求而书写不规范测试代码。的直接链接">​</a></h5>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="13推荐单元测试作为一种质量保障手段在提交pr前完成单元测试的编写及验证">13.【推荐】单元测试作为一种质量保障手段，在提交pr前完成单元测试的编写及验证。<a href="#13推荐单元测试作为一种质量保障手段在提交pr前完成单元测试的编写及验证" class="hash-link" aria-label="13.【推荐】单元测试作为一种质量保障手段，在提交pr前完成单元测试的编写及验证。的直接链接" title="13.【推荐】单元测试作为一种质量 保障手段，在提交pr前完成单元测试的编写及验证。的直接链接">​</a></h5>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="14参考为了更方便地进行单元测试业务代码应避免以下情况">14.【参考】为了更方便地进行单元测试，业务代码应避免以下情况：<a href="#14参考为了更方便地进行单元测试业务代码应避免以下情况" class="hash-link" aria-label="14.【参考】为了更方便地进行单元测试，业务代码应避免以下情况：的直接链接" title="14.【参考】为了更方便地进行单元测试，业务代码应避免以下情况：的直接链接">​</a></h5>
<ul>
<li>构造方法中做的事情过多。</li>
<li>存在过多的全局变量和静态方法。</li>
<li>存在过多的外部依赖。</li>
<li>存在过多的条件语句。
说明：多层条件语句建议使用卫语句、策略模式、状态模式等方式重构。</li>
</ul></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="本文中，我将与大家分享我在 Seata 社区中的开发者之旅，以及在这个旅程中积累的经验和见解。"><meta itemprop="keywords" content="Seata,开源,开源之夏,分布式事务"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/explore-seata-journey">探索 Seata 项目开源开发之旅</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-11-27T00:00:00.000Z" itemprop="datePublished">2023年11月27日</time> · <!-- -->阅读需 20 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">尹祥琨-清华大学，Seata 开源之夏学生参与者</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><blockquote>
<p>Seata 是一款开源的分布式事务解决方案，致力于在微服务架构下提供高性能和简单易用的分布式事务服务。在今年的开源之夏活动中，我加入了 Apache Seata (Incubator) 社区，完成了开源之夏的课题，并从此一直积极参与社区。我有幸在云栖大会-开发者秀场上分享了我的开发者经验。在本文中，我将与大家分享我在 Seata 社区中的开发者之旅，以及在这个旅程中积累的经验和见解。希望通过我的故事，能够激励更多人踏上这充满挑战和激励的开源之路，为开源社区的繁荣做出自己的贡献。</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="相关背景">相关背景<a href="#相关背景" class="hash-link" aria-label="相关背景的直接链接" title="相关背景的直接链接">​</a></h2>
<p>在正式介绍我的经历之前，我想先提供一些相关的背景信息，以解释为什么我要参与开源以及如何参与开源。关于参与开源的原因，我相信每个人都有不同的动机。以下是我认为一些主要的原因：</p>
<ul>
<li><strong>学习</strong>：参与开源使我们有机会为不同组织开发的开源项目做出贡献，与行业专家互动，提供了学习的机会。</li>
<li><strong>技能提升</strong>：以我为例，我通常使用 Java 和 Python 进行后端开发。但在参与Seata项目时，我有机会学习Go语言，拓宽了我的后端技术栈。此外作为学生，我很难接触到生产级框架或应用，而开源社区为我提供了这个机会。</li>
<li><strong>兴趣</strong>：我身边的朋友都是热衷于开源的，他们享受编程，对开源充满热情。</li>
<li><strong>求职</strong>：参与开源可以丰富我们的作品集，为简历增加分量。</li>
<li><strong>工作需求</strong>：有时参与开源是为了解决工作中遇到的问题或满足工作需求。</li>
</ul>
<p>这些都是参与开源的原因，对我来说，学习、技能提升和兴趣是我参与开源的主要动机。无论你是在校学生还是在职人员，如果你有参与开源的意愿，不要犹豫，任何人都可以为开源项目做出贡献。年龄、性别、工作和所在地都不重要，关键是你的热情和对开源项目的好奇心。</p>
<p><strong>我参与开源的契机是参加了中科院软件所举办的开源之夏活动。</strong></p>
<p>开源之夏是一个面向高校开发者的开源活动，社区发布开源项目，学生开发者在导师的指导下完成项目的开发，结项成果贡献给社区，合入社区仓库，获得项目奖金和证书。开源之夏是踏入开源社区的一个绝佳契机，也是我第一次比较正式地接触开源项目，而这个经历为我打开了一扇全新的大门。自此我深刻地认识到参与开源项目的建设，分享自己的技术成果，让更多的开发者能够使用你所贡献的东西，是一件极富乐趣和意义的事情。</p>
<p>下面我分享的这张图片是开源之夏官方公开的数据，从 2020 年开始参与的社区数量还有学生数量都在逐年增加，活动也是越办越好。可以看到今年的参与的社区项目共有 133 个，每个社区又提供了若干个课题，而每位学生只能选择一个课题。想要在这么多个社区中找到想要参与的社区和适合自己的课题是一个相对复杂的任务。</p>
<p><img decoding="async" loading="lazy" alt="img" src="/zh-cn/assets/images/explore-seata-ospp-ea3140f489f2794691a5ec30584dc17d.png" width="1736" height="455" class="img_ev3q"></p>
<p><strong>综合考虑社区的活跃程度、技术栈契合度、新人引导情况等，最终我选择加入 Seata 社区。</strong></p>
<p>Seata 是一款开源的分布式事务框架，提供了完整的分布式事务解决方案，包括 AT、TCC、Saga 和 XA 事务模式，可支持多种编程语言和数据存储 方案。从 19 年开源起到今年已经走过了 <strong>5</strong> 个年头，社区中有超过 <strong>300</strong> 多位贡献者，项目收获了 <strong>24k+</strong> 星标，是一个非常成熟的社区。同时 Seata 兼容 <strong>10</strong> 余种主流 RPC 框架和 RDBMS，与 <strong>20</strong> 多个社区存在集成和被集成的关系，被<strong>几千</strong>家客户应用到业务系统中，可以说是分布式事务解决方案的事实标准。</p>
<p><img decoding="async" loading="lazy" alt="img" src="/zh-cn/assets/images/explore-seata-apache-0ab436a0c1d070e4d1dbff2df66ea775.png" width="750" height="146" class="img_ev3q"></p>
<p>2023 年 10 月 29 日，Seata 正式捐赠给了 Apache 软件基金会，成为孵化项目。经过孵化之后，Seata将有望成为首个 Apache 软件基金会的分布式事务框架顶级项目。这次捐赠也将推动 Seata 更广泛地发展，对生态系统的建设产生深远的影响，从而使更多的开发者受益。这个重要的里程碑也为 Seata 带来更广阔的发展空间。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="开发之旅">开发之旅<a href="#开发之旅" class="hash-link" aria-label="开发之旅的直接链接" title="开发之旅的直接链接">​</a></h2>
<p><strong>介绍完了一些基本情况，后文中我将分享我在 Seata 社区的开发之旅。</strong></p>
<p>在正式开始开发之前，我进行了许多准备工作。因为 Seata 已经经历了五年的发展，积累了数十万行代码，因此直接参与开发需要一定的上手成本。我分享了一些准备经验，希望能够为大家提供一些启发。</p>
<ol>
<li>文档和博客是第一手材料
文档和博客这类的文本材料可以帮助社区新人迅速了解项目背景和代码结构。
首先，官方文档是最主要的参考资料，从这里可以了解到一切官方认为你需要了解的东西。
<img decoding="async" loading="lazy" alt="img" src="/zh-cn/assets/images/explore-seata-docs-481f1fed9d84cd5bf6459048ab08e169.png" width="722" height="146" class="img_ev3q">
博客，仅次于官方文档的材料，一般是开发者或者是深度用户编写的，和文档不同的点在于博客可能会更深入到某个专项上去介绍，比如一些项目的理论模型、项目结构、某个模块的源码分析等等。
<img decoding="async" loading="lazy" alt="img" src="/zh-cn/assets/images/explore-seata-blogs-3a309daa3407d8705311955654df0b21.png" width="722" height="155" class="img_ev3q">
公众号，和博客类似，一般是偏技术性的文章，公众号还有个优点是可以订阅推送，利用碎片时间阅读一些技术。
<img decoding="async" loading="lazy" alt="img" src="/zh-cn/assets/images/explore-seata-pubs-b79d08833dc9443c20d5badd02f46ad1.png" width="722" height="131" class="img_ev3q">
此外，开源社区的一些在线分享或线下 Meetup 公开的幻灯片也是非常有意义的文本资料。
<img decoding="async" loading="lazy" alt="img" src="/zh-cn/assets/images/explore-seata-slides-9d9ec97761879e8d3a74be56c6908a4a.png" width="722" height="115" class="img_ev3q">
除了官方资料之外，还有许多第三方资料可供学习，比如可以通过用户分享的 use cases 了解项目的具体实施和实践；通过第三方社区的集成文档了解项目的生态；还有就是通过第三方的视频教程来学习。但在所有这些资料中，我认为官方文档和博客是最有帮助的。</li>
<li>熟悉使用框架
当然刚才说的这些文本资料肯定不需要面面俱到的看完，纸上得来终觉浅，看到感觉差不多明白了就可以去实践了。可以按照官方文档的&quot;Get Started&quot;章节逐步了解项目的基本流程。另一种方法是查找官方提供的示例或演示，构建并运行它们，理解代码和配置的含义，并通过使用项目了解项目的需求、目标以及现有功能和架构。
例如，Seata有一个名为 seata-samples 的仓库，其中包含20多种用例，  比如 Seata 和 Dubbo 集成，和 SCA, Nacos 集成的案例，基本可以覆盖到支持的所有场景。</li>
<li>粗略阅读源代码把握主要逻辑
在准备阶段，粗略地阅读源代码以把握项目的主要逻辑也很重要。了解如何高效地把握项目的主要内容是一个需要长期积累的技能。首先，通过前述的准备步骤，了解项目的概念、交互和流程模型是很有帮助的。
以Seata为例，通过官方文档和实际操作，可以了解Seata事务领域的三个角色：TC（Transaction Coordinator）、TM（Transaction Manager）和 RM（Resource Manager）。TC 作为独立部署的 Server 用于维护全局和分支事务的状态，是 Seata 实现高可用的关键；TM 用于与 TC 交互，定义全局事务的开始、提交或回滚；RM 用于管理分支事务处理的资源，与 TC 交互以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。粗略地了解这些角色之间的交互后，可以更轻松地把握项目的主要逻辑。
<img decoding="async" loading="lazy" alt="img" src="/zh-cn/assets/images/solution-1bdadb80e54074aa3088372c17f0244b.png" width="868" height="473" class="img_ev3q">
脑海里刻下了这些模型的印象，对源码的主干提取就相对得心应手了一些。比如 Seata TC 事务协调者，作为 Server 端，是一个独立于业务部署的单独应用。那为了分析源码，就可以直接在本地把 server 起起来，通过启动类开始追踪。可以分析到一些初始化的逻辑比如服务注册、全局锁的初始化等等。还有可以通过 RPC 的调用来追踪到交互逻辑的代码，比如 TC 是如何对全局事务和分支事务进行持久化，如何驱动全局事务提交或者回滚的。
然而内嵌客户端的框架代码，没有一个启动类入口可以入手分析。那其实可以从一个 sample 入手，找到其对框架代码的引用从而进行阅读。比如 Seata 一个很重要的注解是 <code>GlobalTransaction</code>，用于标识一个全局事务。想要知道 TM 是如何对这个注解分析的，那我们通过 IDE 的搜索功能，找到 <code>GlobalTransaction</code> 的拦截器即可分析其中的逻辑。
还有一个小 tips 分享给大家，往往来说单测注重于单一模块的职能，可以通过阅读单测可以了解一个模块的输入输出、逻辑边界，也可以顺着单测的调用链去阅读代码，也是理解源码一个很重要的手段。</li>
</ol>
<p><strong>万事俱备只欠东风，做完充足的准备，下一步就是区积极参与到社区之中。</strong></p>
<p>参与的方式也有很多种，最常见的参与方式是查看项目的 Issues 列表，社区通常会为新贡献者标记一些带有特殊标签的 Issue，如“good-first-issue”、“contributions-welcome”和“help-wanted”等。可以通过这些标签筛选感兴趣的任务。</p>
<p><img decoding="async" loading="lazy" alt="img" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAu4AAABQCAMAAABxnADUAAACuFBMVEXMztD+/v/y9PX5+vuoq62nqq3////Iy83MztDFyMv29/j988Xw763//vz+//////3o6On9/f7+/PP9+/j///79/Pv7/P7u7/Hu7e399Mr99tX9/v/t6+n5+/3x8vL18/H8+ub+9Mfz8O329cvb4+33+PrJys3y8bLl5ebM09xlXGPAwsjy8a65vML39fPp6+7q5+Tv8vZ4dHX59O359/X6+fjS1trv597h6O7Bv8D19veZh33HxcXFztlycHPOyml5eoD2+v6OfXTh3dm0uL69ydfFyMvj6/O8w8zU09Pu9fvp49xfZXbd2dTO0dVeX2rBxs728OZ0dXvU3umgkYbx7OTMzc+Dc2vFy9Lc4eb8+fPz+PzOysbz6r7i4eBlZW3m28+0vcrZ3N/Rzs27rqDVybzDtanq6amPk5txfZDN2OXi18p/eXWLmKzp8PiDf3vQwrKwpZjJuqvY0MmapLRjYVrq4dba1M9rcHprdol/gop+bGWvoI6CrYXT2eG5p5rF0uJxYmBsbHGDkKe1wtO8ubmcq8FfWVNkbYCvsrjl46bz9vno7vRyeYWqrbKomond0MCjrLv9+e5WWWd+i6CMg36Hh2mXprtsaGepssCEipTw5bqSnrJ1amjRz3fe3Z99fWROUF347sKquMja1ZTIx6d2gZdYTEru7Kqnm5OUuZeRiYasu8/p6L2pnHRERk2Xj4nGxpd6a1iKgFqkssd/eFn68cOzqHjg06ekqbGYnaWvtoyVh2Pr8+zOxLr599yYlZX27r6glGnRwo03ODulpqZvcVeRkXS3uqGdnobg6+Hn4bihwqSanHeUtOmzr67N3s7Gv4Xv79PS1Z+iqYLCt47Asn1uYUysya7V04WwlYx/cnnV5NbE2cZsluG7r4u40bqsxe5Rg9vH2PR+o+Vdi95vmm////+WVYwoAAAA6HRSTlPE////lpb/xMXE///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////E/33mMAAAIABJREFUeNrsm/lTU1kWxyWZeWVBJSQkISwhLAVWEkuBsGhBEQI0g0toBAMoTkhggAFZwhIQCBhZFBRlEwgYBAxEShEUFAgMssgoxNjVFjO0S7dF/zR/x5z7AJcedKRVnMH3TeUldznvJNTnnnfueWHHH3buIETom9DOP+7YSbcgROibEB1CuwVGiNA3IYsdBO6ECNwJESJwJ0SIwP3/SdaU3y9rgphthTude5+0rfGnuMw4fIJcbAhmtg/uj5+Ul5c/f8zctt/XxsHe6pPk0ExE+C1VwtLg4FLzZomk4/ovuP9SfvPp41c3yx9vX9pXoR2Dh5WVXjaGv9PL1nrX2r99WK2/k+mtrOybCQS38GK81NcVHNzVN8jYjBVp13e4dll+CHdu+XM/eAl4cpP0hT78n/lUt8jjTmjRnnV/e4T67sTosxGv38f+eMDp010zM/eEYNYziGrdGt2uxjv4O9c+kx5/vfDA7LpRRF83mBsywLgDg6Bwy5KPpRfBuLrMrE2YxU3uQfouPRnDfA/udnfcCHeLp+X3MfJ9FkYrf/qFgmtodqxUJO+1xTCf2TNv+n3O7n93okL+epTSIDlg+xlw19QewmxQJjO3sKiX6cYA4vmsQRlEeNf5NrPMakwnM442zqERFObn9Hr9nE4/JtPJ5oby9Hqd3mrOfHcRLQcivG+VmNEvuvogvMPhxdIm7HafxxcHuf57DHPbdbbp0IbR/flNFvbqX08x8s1fUZPBIVPsSJhzIptK4fDIuH83Hgnz49GcMGe2m6etGw1mcDlsFseTjsGcOrAh0bzRNG+I1zCH5wHriwej2F6epyPg7vYXXlltDoaxeN577ZxhGMwCUmt6PZh20GBx4PyYM61xFXc3cL1P3XJx1bM3xvBa9UyzBct3PJOQZy9v3AR9H4YnyYtNReeD6xnDi0fGcW9GuBv75YahnsX5NtNy1orJWDboOv+oTWleblsYHjVMLfQYIJz/YHywuLy4ctdkDF1QDvcXGsbbTMaptmc47i4Eh1uVypiDuwZnBvvg2dXN+H24W2CRE+/DnY79CrizVnFXCI82t3YolDEqUlqW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" width="750" height="80" class="img_ev3q"></p>
<p>除了 Issues，GitHub 还提供了讨论的功能，可以参与一些公开的讨论并获取新的想法。</p>
<p><img decoding="async" loading="lazy" alt="img" src="data:image/png;base64,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" width="750" height="86" class="img_ev3q"></p>
<p>此外，社区通常会定期举行会议，比如周会或双周会，可以通过参加这些会议来了解社区的最新进展，提出问题以及与其他社区成员交流。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结与心得">总结与心得<a href="#总结与心得" class="hash-link" aria-label="总结与心得的直接链接" title="总结与心得的直接链接">​</a></h2>
<p>我加入 Seata 社区最初是通过开源之夏活动。我完成了我的课题，为 Seata Saga 实现了一些新的功能，也做了一系列的优化。但我不止于此，因为在 Seata 的开源经历中我获得了学生生涯中最宝贵的一次开发者体验，在之后的时间我也持续通过上述参与方式持续活跃在社区中。这主要得益于以下几个方面：</p>
<ol>
<li><strong>沟通与社交</strong>：导师制度为我提供了重要的支持。在开发过程中，我与我的导师亦夏之间的密切合作对我适应社区文化和工作流程起到了关键作用。他不仅帮助我适应了社区，还为我提供了程序设计的思路，也与我分享了一些在工作中的经验和见解，这些都对我的发展非常有帮助。此外，Seata 社区创始人清铭也提供了很多帮助，包括建立了与其他同学的联系，帮助我进行 Code Review，也为我提供了许多机会。</li>
<li><strong>正反馈</strong>：在 Seata 的开发过程中，我经历了一个良性的循环。许多细节为我提供了许多正反馈，例如我的贡献能被用户广泛使用和受益，比如开发得到了社区的认可。这些正反馈加强了我继续在 Seata 社区贡献的意愿。</li>
<li><strong>技能提升</strong>：再就是参与 Seata 开发，对我能力的提升也是巨大的。在这里，我能学习到生产级别的代码，包括性能优化，接口设计，边界判断的技巧。可以直接参与一个开源项目的运作，包括项目计划，安排，沟通等。当然还了解一个分布式事务框架是如何设计并实现的。</li>
</ol>
<p>除了这些宝贵的开发者体验，我也从这次经历中体悟到了一些关于参与开源的个人心得，为激励其他有兴趣参与开源社区的同学，我做了简单的总结：</p>
<ol>
<li><strong>了解和学习社区文化和价值观</strong>：每个开源社区都有不同的文化和价值观。了解社区的文化和价值观对于成功参与社区至关重要。观察和了解社区其他成员的日常开发和交流方式是学习社区文化的好方法。在社区中要尊重他人的意见和包容不同的观点。</li>
<li><strong>敢于迈出第一步</strong>：不要害怕面对困难，迈出第一步是参与开源社区的关键。可以通过领取标有&quot;good-first-issue&quot;等标签的 Issue，编写文档、单元测试等方式来开始。重要的是要克服畏难情绪，积极尝试并学习。</li>
<li><strong>对自己的工作要充满信心</strong>：不要怀疑自己的能力。每个人都是从零开始的，没有人天生就是专家。参与开源社区是一个学习和成长的过程，需要不断的实践和积累经验。</li>
<li><strong>积极参与讨论，持续学习不同技术</strong>：不要害怕提出问题，无论是关于项目的具体技术还是开发过程中的挑战。同时也不要局限于一个领域。尝试学习和掌握不同编程语言、框架和工具，这可以拓宽技术视野，为项目提供有价值的洞见。</li>
</ol>
<hr>
<p>通过我的开源之旅，我积累了宝贵的经验和技能，这些不仅帮助我成长为一个更有价值的开发者，也让我深刻地了解了开源社区的力量。然而，我不仅仅是个别的参与者，我代表着 Seata 社区的一部分。Seata 作为一个正在不断成长和演变的开源项目，有着巨大的潜力，同时也面临着新的挑战。因此我要强调 Seata 社区的重要性和未来的潜力，它已经进入 Apache 软件  基金会的孵化阶段，这个重要的里程碑将为 Seata 带来更广阔的发展空间。Seata 欢迎更多的开发者和贡献者的加入，让我们共同推动这个开源项目的发展，为分布式事务领域的进步贡献一份力量。</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="从传统的存算分离，再到及存算一体化依靠分布式一致性算法保证事务数据一致性下的高可用模式，Seata 2.x做出了哪些改动？本文将详细介绍架构，及性能比对"><meta itemprop="keywords" content="fescar、seata、分布式事务,raft"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-raft-detailed-explanation">Seata-Raft 存储模式详解及入门</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-10-13T00:00:00.000Z" itemprop="datePublished">2023年10月13日</time> · <!-- -->阅读需 24 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">funkye</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><ul>
<li><a href="#">1. 概述</a></li>
<li><a href="#">2. 架构介绍</a></li>
<li><a href="#">3. 使用部署</a></li>
<li><a href="#">4. 压测对比</a></li>
<li><a href="#">5. 总结</a></li>
</ul>
<p>Seata 是一款开源的分布式事务解决方案，star高达24000+，社区活跃度极高，致力于在微服务架构下提供高性能和简单易用的分布式事务服务.</p>
<p>目前Seata的分布式事务数据存储模式有file，db，redis，而本篇文章将Seata-Server Raft模式的架构，部署使用，压测对比，及为什么Seata需要Raft,并领略从调研对比,设计,到具体实现,再到知识沉淀的过程.</p>
<p>分享人：陈健斌（funkye） github id: <a href="https://github.com/funky-eyes" target="_blank" rel="noopener noreferrer">funky-eyes</a></p>
<h1>2. 架构介绍</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="21-raft-模式是什么">2.1 Raft 模式是什么？<a href="#21-raft-模式是什么" class="hash-link" aria-label="2.1 Raft 模式是什么？的直接链接" title="2.1 Raft 模式是什么？的直接链接">​</a></h2>
<p>首先需要明白什么是raft分布式一致性算法,这里直接摘抄sofa-jraft官网的相关介绍:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RAFT 是一种新型易于理解的分布式一致性复制协议，由斯坦福大学的 Diego Ongaro 和 John Ousterhout 提出，作为 RAMCloud 项目中的中心协调组件。Raft 是一种 Leader-Based 的 Multi-Paxos 变种，相比 Paxos、Zab、View Stamped Replication 等协议提供了更完整更清晰的协议描述，并提供了清晰的节点增删描述。 Raft 作为复制状态机，是分布式系统中最核心最基础的组件，提供命令在多个节点之间有序复制和执行，当多个节点初始状态一致的时候，保证节点之间状态一致。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">简而言之Seata的Raft模式就是基于Sofa-Jraft组件实现可保证Seata-Server自身的数据一致性和服务高可用.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="22-为什么需要raft模式">2.2 为什么需要raft模式<a href="#22-为什么需要raft模式" class="hash-link" aria-label="2.2 为什么需要raft模式的直接链接" title="2.2 为什么需要raft模式的直接链接">​</a></h2>
<p>看完上述的Seata-Raft模式是什么的定义后,是否就有疑问,难道现在Seata-Server就无法保证一致性和高可用了吗?那么下面从一致性和高可用来看看目前Seata-Server是如何做的.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="221-现有存储模式">2.2.1 现有存储模式<a href="#221-现有存储模式" class="hash-link" aria-label="2.2.1 现有存储模式的直接链接" title="2.2.1 现有存储模式的直接链接">​</a></h3>
<p>在当前的 Seata 设计中，Server 端的作用是保证事务的二阶段被正确执行。然而，这取决于事务记录的正确存储。为确保事务记录不丢失，需要在保持状态正确的前提下，驱动所有的 Seata-RM 执行正确的二阶段行为。那么，Seata 目前是如何存储事务状态和记录的呢？</p>
<p>首先介绍一下 Seata 支持的三种事务存储模式：file、db 和 redis。根据一致性的排名，db 模式下的事务记录可以得到最好的保证，其次是 file 模式的异步刷盘，最后是 redis 模式下的 aof 和 rdb</p>
<p>顾名思义:</p>
<ul>
<li>file 模式是 Seata 自实现的事务存储方式，它以顺序写的形式将事务信息  存储到本地磁盘上。为了兼顾性能，默认采用异步方式，并将事务信息存储在内存中，确保内存和磁盘上的数据一致性。当 Seata-Server（TC）意外宕机时，在重新启动时会从磁盘读取事务信息并恢复到内存中，以便继续运行事务上下文。</li>
<li>db 是 Seata 的抽象事务存储管理器（AbstractTransactionStoreManager）的另一种实现方式。它依赖于数据库，如 PostgreSQL、MySQL、Oracle 等，在数据库中进行事务信息的增删改查操作。一致性由数据库的本地事务保证，数据也由数据库负责持久化到磁盘。</li>
<li>redis 和 db 类似，也是一种事务存储方式。它利用 Jedis 和 Lua 脚本来进行事务的增删改查操作，部分操作（如竞争锁）在 Seata 2.x 版本中全部采用了 Lua 脚本。数据的存储与 db 类似，依赖于存储方（Redis）来保证数据的一致性。与 db 类似，redis 在 Seata 中采用了计算和存储分离的架构设计.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="222-高可用">2.2.2 高可用<a href="#222-高可用" class="hash-link" aria-label="2.2.2 高可用的直接链接" title="2.2.2 高可用的直接链接">​</a></h3>
<p>高可用简单理解就是集群能够在主节点宕机后继续正常运行，常见的方式是通过部署多个提供相同服务的节点，并通过注册中心实时感知主节点的上下线情况，以便及时切换到可用的节点。</p>
<p>看起来似乎只需要加几台机器进行部署，但实际上背后存在一个问题，即如何确保多个节点像一个整体一样运作。如果其中一个节点宕机，另一个节点能够完美接替宕机节点的工作，包括处理宕机节点的数据。解决这个问题的答案其实很简单，在计算与存储分离的架构下，只需将数据存储在共享的存储中间件中，任何一个节点都可以通过访问该公共存储区域获取所有节点操作的事务信息，从而实现高可用的能力。</p>
<p>然而，前提条件是计算与存储必须分离。为什么计算与存储一体化设计不可行呢？这就要说到 File 模式的实现了。如之前描述的，File 模式将数据存储在本地磁盘和节点内存中，数据写操作没有任何同步，这意味着目前的 File 模式无法实现高可用，仅支持单机部署。作为初级的快速入门和简单使用而言，File 模式适用性较低，高性能的基于内存的 File 模式也基本上不再被生产环境使用。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="23-seata-raft是如何设计的呢">2.3 Seata-Raft是如何设计的呢？<a href="#23-seata-raft是如何设计的呢" class="hash-link" aria-label="2.3 Seata-Raft是如何设计的呢？的直接链接" title="2.3 Seata-Raft是如何设计的呢？的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="231-设计原理">2.3.1 设计原理<a href="#231-设计原理" class="hash-link" aria-label="2.3.1 设计原理的直接链接" title="2.3.1 设计原理的直接链接">​</a></h3>
<p>Seata-Raft模式的设计思路是通过封装无法高可用的file模式，利用Raft算法实现多个TC之间数据的同步。该模式保证了使用file模式时多个TC的数据一致性，同时将异步刷盘操作改为使用Raft日志和快照进行数据恢复。
<img decoding="async" loading="lazy" alt="流程图" src="/zh-cn/assets/images/Dingtalk_20230105203431-6a34d0f29cb4b8663f604d87cd73920c.jpg" width="600" height="467" class="img_ev3q"></p>
<p>在Seata-Raft模式中，client端在启动时会从配置中心获取当前client的事务分组（例如default）以及相关Raft集群节点的IP地址。通过向Seata-Server的控制端口发送请求，client可以获取到default分组对应的Raft集群的元数据，包括leader、follower和learner成员节点。然后，client会监视（watch）非leader节点的任意成员节点。</p>
<p>假设TM开始一个事务，并且本地的metadata中的leader节点指向了TC1的地址，那么TM只会与TC1进行交互。当TC1添加一个全局事务信息时，通过Raft协议，即图中标注为步骤1的日志发送，TC1会将日志发送给其他节点，步骤2是follower节点响应日志接收情况。当超过半数的节点（如TC2）接受并响应成功时，TC1上的状态机（FSM）将执行添加全局事务的动作。</p>
<p><img decoding="async" loading="lazy" alt="watch" src="/zh-cn/assets/images/Dingtalk_20230105204423-03b6eb78f785f04c532df8119fe9ddc9.jpg" width="815" height="591" class="img_ev3q">
<img decoding="async" loading="lazy" alt="watch2" src="/zh-cn/assets/images/Dingtalk_20230105211035-6a61157bb4bb72208c63caf3dd647856.jpg" width="808" height="595" class="img_ev3q"></p>
<p>如果TC1宕机或发生重选举，会发生什么呢？由于首次启动时已经获取到了元数据，client会执行watch follower节点的接口来更新本地的metadata信息。因此，后续的事务请求将发送到新的leader（例如TC2）。同时，TC1的数据已经被同步到了TC2和TC3，因此数据一致性不会受到影响。只在选举发生的瞬间，如果某个事务正好发送给了旧的leader，该事务会被主动回滚，以确保数据的正确性。</p>
<p>需要注意的是，在该模式下，如果事务处于决议发送请求或一阶段流程还未走完的时刻，并且恰好在选举时发生，这些事务会被主动回滚。因为RPC节点已经宕机或发生了重选举，当前没有实现RPC重试。TM侧默认有5次重试机制，但由于选举需要大约1s-2s的时间，这些处于begin状态的事务可能无法成功决议，因此会优先回滚，释放锁，以避免影响其他业务的正确性。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="232-故障恢复">2.3.2 故障恢复<a href="#232-故障恢复" class="hash-link" aria-label="2.3.2 故障恢复的直接链接" title="2.3.2 故障恢复的直接链接">​</a></h3>
<p>在Seata中，当TC发生故障时，数据恢复的  过程如下：</p>
<p><img decoding="async" loading="lazy" alt="故障恢复" src="/zh-cn/assets/images/Dingtalk_20230106231817-3ab6f266e902a1778a874edd974cfabd.jpg" width="835" height="572" class="img_ev3q"></p>
<p>如上图所示</p>
<ul>
<li>
<p>检查是否存在最新的数据快照：首先，系统会检查是否存在最新的数据快照文件。数据快照是基于内存的数据状态的一次全量拷贝，如果有最新的数据快照，则系统将直接加载该快照到内存中。</p>
</li>
<li>
<p>根据快照后的Raft日志进行回放：如果存在最新的快照或者没有快照文件，系统将根据之前记录的Raft日志进行数据回放。每个Seata-Server中的请求最终会经过ServerOnRequestProcessor进行处理，然后转移到具体的协调者类(DefaultCoordinator或RaftCoordinator)中，再转向具体的业务代码(DefaultCore)进行相应的事务处理（如begin、commit、rollback等）。</p>
</li>
<li>
<p>当日志回放完成后，便会由leader发起日志的同步，并继续执行相关事务的增删改动作。f</p>
</li>
</ul>
<p>通过以上步骤，Seata能够实现在故障发生后的数据恢复。首先尝试加载最新的快照，如果有的话可以减少回放的时间；然后根据Raft日志进行回放，保证数据操作的一致性；最后通过日志同步机制，确保数据在多节点之间的一致性。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="233-业务处理同步过程">2.3.3 业务处理同步过程<a href="#233-业务处理同步过程" class="hash-link" aria-label="2.3.3 业务处理同步过程的直接链接" title="2.3.3 业务处理同步过程的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" alt="流程" src="/zh-cn/assets/images/Dingtalk_20230106230931-89b853c79183f50afd746c4a662df1e7.jpg" width="1228" height="566" class="img_ev3q">
对于client侧获取最新metadata时恰好有业务线程在执行begin、commit或registry等操作的情况，Seata采取了以下处理方式  ：</p>
<ul>
<li>
<p>client侧：</p>
<ul>
<li>如果客户端正在执行begin、commit或registry等操作，并且此时需要获取最新metadata，由于此时的leader可能已经不存在或不是当前leader，因此客户端的RPC请求可能会失败。</li>
<li>如果请求失败，客户端会收到异常响应，此时客户端需要根据请求的结果进行回滚操作。</li>
</ul>
</li>
<li>
<p>TC侧对旧leader的检测：</p>
<ul>
<li>在TC侧，如果此时客户端的请求到达旧的leader节点，TC会进行当前是否是leader的检测，如果不是leader，则会拒绝该请求。</li>
<li>如果是leader但在中途失败，比如在提交任务到状态机的过程中失败，由于当前已经不是leader，创建任务（createTask）的动作会失败。这样，客户端也会接收到响应异常。</li>
<li>旧leader的提交任务也会失败，确保了事务信息的一致性。
通过上述处理方式，当客户端获取最新metadata时恰好遇到业务操作的情况，Seata能够保证数据的一致性和事务的正确性。如果客户端的RPC请求失败，将触发回滚操作；而在TC侧，对旧leader的检测和任务提交的失败可以防止事务信息不一致的问题。这样，客户端的数据也能保持一致性。</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3使用部署">3.使用部署<a href="#3使用部署" class="hash-link" aria-label="3.使用部署的直接链接" title="3.使用部署的直接链接">​</a></h2>
<p>在使用和部署上，社区秉持着最小侵入，最小改动的原则，所以整体的部署上手应该是非常简单的，接下来分开client与server两端的部署改动点进行介绍</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-client">3.1 client<a href="#31-client" class="hash-link" aria-label="3.1 client的直接链接" title="3.1 client的直接链接">​</a></h3>
<p>首先，使用注册配置中心较多的同学应该知道Seata的配置项中有一个<code>seata.registry.type</code>的配置项，支持了nacos，zk，etcd，redis等等，而在2.0以后增加了一个raft的配置项</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">   registry:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type: raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      raft:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         server-addr: 192.168.0.111:7091, 192.168.0.112:7091, 192.168.0.113:7091</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>将<code>registry.type</code> 改为raft，并配置raft相关元数据的获取地址，该地址统一为seata-server的ip+http端口
然后必不可少的就是传统的事务分组的配置</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">seata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   tx-service-group: default_tx_group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      vgroup-mapping:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         default_tx_group: default</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如现在使用的事务分组为<code>default_tx_group</code>，那么对应的seata集群/分组就是default，这个是有对应关系的，后续再server部署环节上会介绍
至此client的改动已经完成了</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-server">3.2 server<a href="#32-server" class="hash-link" aria-label="3.2 server的直接链接" title="3.2 server的直接链接">​</a></h3>
<p>对于server的改动可能会多一些，要熟悉一些调优参数和配置，当然也可以选择默认值不做任何修改</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">seata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    raft:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      group: default #此值代表该raft集群的group，client的事务分组对应的值要与之对应</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      server-addr: 192.168.0.111:9091,192.168.0.112:9091,192.168.0.113:9091 # 3台节点的ip和端口，端口为该节点的netty端口+1000，默认netty端口为8091</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      snapshot-interval: 600 # 600秒做一次数据的快照，以便raftlog的快速滚动，但是每次做快照如果内存中事务数据过多会导致每600秒产生一次业务rt的抖动，但是对于故障恢复比较友好，重启节点较快，可以调整为30分钟，1小时都行，具体按业务来，可以自行压测看看是否有抖动，在rt抖动和故障恢复中自行找个平衡点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      apply-batch: 32 # 最多批量32次动作做一次提交raftlog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      max-append-bufferSize: 262144 #日志存储缓冲区最大大小，默认256K</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      max-replicator-inflight-msgs: 256 #在启用 pipeline 请求情况下，最大 in-flight 请求数，默认256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      disruptor-buffer-size: 16384 #内部 disruptor buffer 大小，如果是写入吞吐量较高场景，需要适当调高该值，默认 16384</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      election-timeout-ms: 1000 #超过多久没有leader的心跳开始重选举</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      reporter-enabled: false # raft自身的监控是否开启</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      reporter-initial-delay: 60 # 监控的区间间隔</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serialization: jackson # 序列化方式，不要改动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      compressor: none # raftlog的压缩方式，如gzip，zstd等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      sync: true # raft日志的刷盘方式，默认是同步刷盘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # support: nacos, consul, apollo, zk, etcd3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type: file # 该配置可以选择不同的配置中心</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  registry:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # support: nacos, eureka, redis, zk, consul, etcd3, sofa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type: file # raft模式下不允许使用非file的其他注册中心</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  store:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # support: file 、 db 、 redis 、 raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode: raft # 使用raft存储模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    file:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dir: sessionStore # 该路径为raftlog及事务相关日志的存储位置，默认是相对路径，最好设置一个固定的位置</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在3个或者大于3个节点的seata-server中配置完以上参数后，直接启动便可以看到类似以下的日志输出,就代表集群已经正常启动了</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.392  WARN --- [Rpc-netty-server-worker-10-thread-1] [com.alipay.sofa.jraft.rpc.impl.BoltRaftRpcFactory] [ensurePipeline] []: JRaft SET bolt.rpc.dispatch-msg-list-in-default-executor to be false for replicator pipeline optimistic.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.439  INFO --- [default/PeerPair[10.58.16.231:9091 -&gt; 10.58.12.217:9091]-AppendEntriesThread0] [com.alipay.sofa.jraft.storage.impl.LocalRaftMetaStorage] [save] []: Save raft meta, path=sessionStore/raft/9091/default/raft_meta, term=4, votedFor=0.0.0.0:0, cost time=25 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.441  WARN --- [default/PeerPair[10.58.16.231:9091 -&gt; 10.58.12.217:9091]-AppendEntriesThread0] [com.alipay.sofa.jraft.core.NodeImpl] [handleAppendEntriesRequest] []: Node &lt;default/10.58.16.231:9091&gt; reject term_unmatched AppendEntriesRequest from 10.58.12.217:9091, term=4, prevLogIndex=4, prevLogTerm=4, localPrevLogTerm=0, lastLogIndex=0, entriesSize=0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.442  INFO --- [JRaft-FSMCaller-Disruptor-0] [io.seata.server.cluster.raft.RaftStateMachine] [onStartFollowing] []: groupId: default, onStartFollowing: LeaderChangeContext [leaderId=10.58.12.217:9091, term=4, status=Status[ENEWLEADER&lt;10011&gt;: Raft node receives message from new leader with higher term.]].</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.449  WARN --- [default/PeerPair[10.58.16.231:9091 -&gt; 10.58.12.217:9091]-AppendEntriesThread0] [com.alipay.sofa.jraft.core.NodeImpl] [handleAppendEntriesRequest] []: Node &lt;default/10.58.16.231:9091&gt; reject term_unmatched AppendEntriesRequest from 10.58.12.217:9091, term=4, prevLogIndex=4, prevLogTerm=4, localPrevLogTerm=0, lastLogIndex=0, entriesSize=0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.459  INFO --- [Bolt-default-executor-4-thread-1] [com.alipay.sofa.jraft.core.NodeImpl] [handleInstallSnapshot] []: Node &lt;default/10.58.16.231:9091&gt; received InstallSnapshotRequest from 10.58.12.217:9091, lastIncludedLogIndex=4, lastIncludedLogTerm=4, lastLogId=LogId [index=0, term=0].</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.489  INFO --- [Bolt-conn-event-executor-13-thread-1] [com.alipay.sofa.jraft.rpc.impl.core.ClientServiceConnectionEventProcessor] [onEvent] []: Peer 10.58.12.217:9091 is connected</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.519  INFO --- [JRaft-Group-Default-Executor-0] [com.alipay.sofa.jraft.util.Recyclers] [&lt;clinit&gt;] []: -Djraft.recyclers.maxCapacityPerThread: 4096.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.574  INFO --- [JRaft-Group-Default-Executor-0] [com.alipay.sofa.jraft.storage.snapshot.local.LocalSnapshotStorage] [destroySnapshot] []: Deleting snapshot sessionStore/raft/9091/default/snapshot/snapshot_4.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.574  INFO --- [JRaft-Group-Default-Executor-0] [com.alipay.sofa.jraft.storage.snapshot.local.LocalSnapshotStorage] [close] []: Renaming sessionStore/raft/9091/default/snapshot/temp to sessionStore/raft/9091/default/snapshot/snapshot_4.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.689  INFO --- [JRaft-FSMCaller-Disruptor-0] [io.seata.server.cluster.raft.snapshot.session.SessionSnapshotFile] [load] []: on snapshot load start index: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.694  INFO --- [JRaft-FSMCaller-Disruptor-0] [io.seata.server.cluster.raft.snapshot.session.SessionSnapshotFile] [load] []: on snapshot load end index: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.694  INFO --- [JRaft-FSMCaller-Disruptor-0] [io.seata.server.cluster.raft.RaftStateMachine] [onSnapshotLoad] []: groupId: default, onSnapshotLoad cost: 110 ms.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.694  INFO --- [JRaft-FSMCaller-Disruptor-0] [io.seata.server.cluster.raft.RaftStateMachine] [onConfigurationCommitted] []: groupId: default, onConfigurationCommitted: 10.58.12.165:9091,10.58.12.217:9091,10.58.16.231:9091.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.705  INFO --- [JRaft-FSMCaller-Disruptor-0] [com.alipay.sofa.jraft.storage.snapshot.SnapshotExecutorImpl] [onSnapshotLoadDone] []: Node &lt;default/10.58.16.231:9091&gt; onSnapshotLoadDone, last_included_index: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">last_included_term: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peers: &quot;10.58.12.165:9091&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peers: &quot;10.58.12.217:9091&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peers: &quot;10.58.16.231:9091&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.722  INFO --- [JRaft-Group-Default-Executor-1] [com.alipay.sofa.jraft.storage.impl.RocksDBLogStorage] [lambda$truncatePrefixInBackground$2] []: Truncated prefix logs in data path: sessionStore/raft/9091/default/log from log index 1 to 5, cost 0 ms.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="33-faq">3.3 faq<a href="#33-faq" class="hash-link" aria-label="3.3 faq的直接链接" title="3.3 faq的直接链接">​</a></h3>
<ul>
<li>当<code>seata.raft.server-addr</code>配置好后，必须通过server的openapi进行集群的扩缩容，直接改动该配置进行重启是不会生效的
接口为<code>/metadata/v1/changeCluster?raftClusterStr=新的集群列表</code></li>
<li>如果<code>server-addr:</code>中的地址都为本机，那么需要根据本机上不同的server的netty端口增加1000的偏移量，如<code>server.port: 7092</code>那么netty端口为8092，raft选举和通信端口便为9092，需要增加启动参数<code>-Dserver.raftPort=9092</code>.
Linux下可以通过<code>export JAVA_OPT=&quot;-Dserver.raftPort=9092&quot;</code>等方式指定。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4压测对比">4.压测对比<a href="#4压测对比" class="hash-link" aria-label="4.压测对比的直接链接" title="4.压测对比的直接链接">​</a></h2>
<p>压测对比分为两种场景,并且为了避免数据热点冲突与线程调优等情况,将Client侧的数据初始化300W条商品,并直接使用jdk21虚拟线程+spring boot3+seata AT来测试,在gc方面全部采用分代ZGC进行,压测工具为阿里云PTS，Server侧统一使用jdk21(目前还未适配虚拟线程) 服务器配置如下
TC: 4c8g<em>3  Client: 4c</em>8G*1  数据库为阿里云rds 4c16g</p>
<ul>
<li>64并发压测只增加<code>@Globaltransactional</code>注解接口空提交的性能</li>
<li>随机300W数据进行32并发10分钟的扣库存</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-171-db模式">4.1 1.7.1 db模式<a href="#41-171-db模式" class="hash-link" aria-label="4.1 1.7.1 db模式的直接链接" title="4.1 1.7.1 db模式的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" src="https://img.alicdn.com/imgextra/i3/O1CN011dNh3H1UK8G5prQAg_!!6000000002498-0-tps-731-333.jpg" alt="raft压测模型" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="空提交-64c">空提交 64C<a href="#空提交-64c" class="hash-link" aria-label="空提交 64C的直接链接" title="空提交 64C的直接链接">​</a></h4>
<p><img decoding="async" loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01pE1Anf1nRtgcnlx9t_!!6000000005087-0-tps-622-852.jpg" alt="db64-2" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="随机扣库存-32c">随机扣库存 32C<a href="#随机扣库存-32c" class="hash-link" aria-label="随机扣库存 32C的直接链接" title="随机扣库存 32C的直接链接">​</a></h4>
<p><img decoding="async" loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN016hZkJC20OJax9ce31_!!6000000006839-0-tps-624-852.jpg" alt="db32-2" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-20-raft模式">4.2 2.0 raft模式<a href="#42-20-raft模式" class="hash-link" aria-label="4.2 2.0 raft模式的直接链接" title="4.2 2.0 raft模式的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01nNL6oe1X95YcQQEjs_!!6000000002880-0-tps-773-353.jpg" alt="raft压测模型" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="空提交-64c-1">空提交 64C<a href="#空提交-64c-1" class="hash-link" aria-label="空提交 64C的直接链接" title="空提交 64C的直接链接">​</a></h4>
<p><img decoding="async" loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01rs1ykr1dhnH8qnXj3_!!6000000003768-0-tps-631-851.jpg" alt="raft64-2" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="随机扣库存-32c-1">随机扣库存 32C<a href="#随机扣库存-32c-1" class="hash-link" aria-label="随机扣库存 32C的直接链接" title="随机扣库存 32C的直接链接">​</a></h4>
<p><img decoding="async" loading="lazy" src="https://img.alicdn.com/imgextra/i4/O1CN015OwA2k20enquV7Yfu_!!6000000006875-0-tps-624-856.jpg" alt="raft32c-2" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="43-压测结果对比">4.3 压测结果对比<a href="#43-压测结果对比" class="hash-link" aria-label="4.3 压测结果对比的直接链接" title="4.3 压测结果对比的直接链接">​</a></h3>
<p>32并发对300W商品随机扣库存场景</p>
<table><thead><tr><th>tps avg</th><th>tps max</th><th>count</th><th>rt</th><th>error</th><th>存储类型</th></tr></thead><tbody><tr><td>1709(42%↑)</td><td>2019(21%↑)</td><td>1228803(42%↑)</td><td>13.86ms(30%↓)</td><td>0</td><td>Raft</td></tr><tr><td>1201</td><td>1668</td><td>864105</td><td>19.86ms</td><td>0</td><td>DB</td></tr></tbody></table>
<p>64并发空压<code>@Globaltransactional</code>接口（压测峰值上限为8000）</p>
<table><thead><tr><th>tps avg</th><th>tps max</th><th>count</th><th>rt</th><th>error</th><th>存储类型</th></tr></thead><tbody><tr><td>5704(20%↑)</td><td>8062(30%↑)</td><td>4101236(20%↑)</td><td>7.79ms(19%↓)</td><td>0</td><td>Raft</td></tr><tr><td>4743</td><td>6172</td><td>3410240</td><td>9.65ms</td><td>0</td><td>DB</td></tr></tbody></table>
<p>除了以上数据上的直观对比,通过对压测的曲线图来观察,raft模式下tps与rt更加平稳,抖动更少,性能与吞吐量上更佳.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5总结">5.总结<a href="#5总结" class="hash-link" aria-label="5.总结的直接链接" title="5.总结的直接链接">​</a></h2>
<p>在Seata未来的发展中，性能、入门门槛、部署运维成本，都是我们需要关注和不断优化的方向，在raft模式推出后有以下几个特点:</p>
<ol>
<li>如存储方面，存算分离后Seata对其优化的上限被拔高，自主可控</li>
<li>部署成本更低，无需额外的注册中心，存储中间件</li>
<li>入门的门槛更低，无需学习其他的一些如注册中心的知识，一站式直接使用Seata Raft 即可上手</li>
</ol>
<p>针对业界发展趋势，一些开源项目如ClickHouse和Kafka已经开始放弃使用ZooKeeper，并转而采用自研的解决方案，比如ClickKeeper和KRaft。这些方案将元数据等信息交由自身保证存储，以减少对第三方依赖的需求，从而降低运维成本和学习成本。这些特性是非常成熟和可借鉴的。</p>
<p>当然，目前来看，基于Raft模式的解决方案可能还不够成熟，可能无法完全达到上述描述的那样美好。然而，正是因为存在这样的理论基础，社区更应该朝着这个方向努力，让实践逐步接近理论的要求。在这里，欢迎所有对Seata感兴趣的同学加入社区，共同为Seata添砖加瓦！</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="本文介绍Seata的过去、现在和未来演进"><meta itemprop="keywords" content="Seata、分布式事务、数据一致性、微服务"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-connect-data-and-application">Seata：连接数据与应用</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-06-30T00:00:00.000Z" itemprop="datePublished">2023年6月30日</time> · <!-- -->阅读需 23 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">季敏-Seata 开源社区创始人，分布式事务团队负责人</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>本文主要介绍分布式事务从内部到商业化和开源的演进历程，Seata社区当前进展和未来规划。</p>
<p>Seata是一款开源的分布式事务解决方案，旨在为现代化微服务架构下的分布式事务提供解决方案。Seata提供了完整的分布式事务解决方案，包括AT、TCC、Saga和XA事务模式，可支持多种编程语言和数据存储方案。Seata还提供了简便易用的API，以及丰富的文档和示例，方便企业在应用Seata时进行快速开发和部署。</p>
<p><strong>Seata的优势在于具有高可用性、高性能、高扩展性等特点，同时在进行横向扩展时也无需做额外的复杂操作。</strong> 目前Seata已在阿里云上几千家客户业务系统中使用，其可靠性得到了业内各大厂商的认可和应用。</p>
<p>作为一个开源项目，Seata的社区也在不断扩大，现已成为开发者交流、分享和学习的重要平台，也得到了越来越多企业的支持和关注。</p>
<p>今天我主要针对以下三个小议题对Seata进行分享：</p>
<ul>
<li><strong>从TXC/GTS 到 Seata</strong></li>
<li><strong>Seata 社区最新进展</strong></li>
<li><strong>Seata 社区未来规划</strong></li>
</ul>
<br>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="从txcgts-到seata">从TXC/GTS 到Seata<a href="#从txcgts-到seata" class="hash-link" aria-label="从TXC/GTS 到Seata的直接链接" title="从TXC/GTS 到Seata的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="分布式事务的缘起">分布式事务的缘起<a href="#分布式事务的缘起" class="hash-link" aria-label="分布式事务的缘起的直接链接" title="分布式事务的缘起的直接链接">​</a></h4>
<p><img decoding="async" loading="lazy" alt="产品矩阵" src="/zh-cn/assets/images/产品矩阵-911645846cd62c27fb3e2aaef802b52e.jpg" width="1468" height="1316" class="img_ev3q">
Seata 在阿里内部的产品代号叫TXC（taobao transaction constructor），这个名字有非常浓厚的组织架构色彩。TXC 起源于阿里五彩石项目，五彩石是上古神话中女娲补天所用的石子，项目名喻意为打破关键技术壁垒，象征着阿里在从单体架构向分布式架构的演进过程中的重要里程碑。在这个项目的过程中演进出一批划时代的互联网中间件，包括我们常说的三大件：</p>
<ul>
<li><strong>HSF 服务调用框架</strong><br>
<!-- -->解决单体应用到服务化后的服务通信调用问题。</li>
<li><strong>TDDL 分库分表框架</strong><br>
<!-- -->解决规模化后单库存储容量和连接数问题。</li>
<li><strong>MetaQ 消息框架</strong><br>
<!-- -->解决异步调用问题。</li>
</ul>
<p>三大件的诞生满足了微服务化业务开发的基本需求，但是微服务化后的数据一致性问题并未得到妥善解决，缺少统一的解决方案。应用微服务化后出现数据一致性问题概率远大于单体应用，从进程内调用到网络调用这种复杂的环境加剧了异常场景的产生，服务跳数的增多使得在出现业务处理异常时无法协同上下游服务同时进行数据回滚。TXC的诞生正是为了解决应用架构层数据一致性的痛点问题，TXC 核心要解决的数据一致性场景包括：</p>
<ul>
<li><strong>跨服务的一致性。</strong> 应对系统异常如调用超时和业务异常时协调上下游服务节点回滚。</li>
<li><strong>分库分表的数据一致性。</strong> 应对业务层逻辑SQL操作的数据在不同数据分片上，保证其分库分表操作的内部事务。</li>
<li><strong>消息发送的数据一致性。</strong> 应对数据操作和消息发送成功的不一致性问题。</li>
</ul>
<p>为了克服以上通用场景遇到的问题，TXC与三大件做了无缝集成。业务使用三大件开发时，完全感知不到背后TXC的存在，业务不需要考虑数据一致性的设计问题，数据一致性保证交给了框架托管，业务更加聚焦于业务本身的开发，极大的提升了开发的效率。</p>
<br>
<p><img decoding="async" loading="lazy" alt="GTS架构" src="/zh-cn/assets/images/GTS架构-f19f670582426aaac8da0f69c1d7ae35.jpg" width="1482" height="1294" class="img_ev3q"></p>
<p>TXC已在阿里集团内部广泛应用多年，经过双11等大型活动的洪荒流量洗礼，TXC极大提高了业务的开发效率，保证了数据的正确性，消除了数据不一致导致的资损和商誉问题。随着架构的不断演进，<strong>标准的三节点集群已可以承载接近10W TPS的峰值和毫秒级事务处理。在可用性和性能方面都达到了4个9的SLA保证，即使在无值守状态下也能保证全年无故障。</strong></p>
<br>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="分布式事务的演进">分布式事务的演进<a href="#分布式事务的演进" class="hash-link" aria-label="分布式事务的演进的直接链接" title="分布式事务的演进的直接链接">​</a></h4>
<p>新事物的诞生总是会伴随着质疑的声音。中间件层来保证数据一致性到底可靠吗？TXC最初的诞生只是一种模糊的理论，缺乏理论模型和工程实践。在我们进行MVP（最小可行产品）模型测试并推广业务上线后，经常出现故障，常常需要在深夜起床处理问题，睡觉时要佩戴手环来应对紧急响应，这也是我接管这个团队在技术上过的最痛苦的几年。</p>
<p><img decoding="async" loading="lazy" alt="分布式事务演进" src="/zh-cn/assets/images/分布式事务演进-cd118286fd5a0add7ecf5775e381a1f5.jpg" width="1488" height="702" class="img_ev3q"></p>
<p>随后，我们进行了广泛的讨论和系统梳理。我们首先需要定义一致性问题，我们是要像RAFT一样实现多数共识一致性，还是要像Google Spanner一样解决数据库一致性问题，还是其他方式？从应用节点自上而下的分层结构来看，主要包括开发框架、服务调用框架、数据中间件、数据库Driver和数据库。我们需要决定在哪一层解决数据一致性问题。我们比较了解决不同层次数据一致性问题所面临的一致性要求、通用性、实现复杂度和业务接入成本。最  后，我们权衡利弊，把实现复杂度留给我们，作为一个一致性组件，我们需要确保较高的一致性，但又不能锁定到具体数据库的实现上，确保场景的通用性和业务接入成本足够低以便更容易实现业务，这也是TXC最初采用AT模式的原因。</p>
<p><strong>分布式事务它不仅仅是一个框架，它是一个体系。</strong>  我们在理论上定义了一致性问题，概念上抽象出了模式、角色、动作和隔离性等。从工程实践的角度，我们定义了编程模型，包括低侵入的注解、简单的方法模板和灵活的API ，定义了事务的基础能力和增强能力（例如如何以低成本支持大量活动），以及运维、安全、性能、可观测性和高可用等方面的能力。</p>
<p><img decoding="async" loading="lazy" alt="事务逻辑模型" src="/zh-cn/assets/images/事务逻辑模型-bd13bfb9738e5aca63823d268e543280.jpg" width="1482" height="656" class="img_ev3q">
分布式事务解决了哪些问题呢？一个经典且具有体感的例子就是转账场景。转账过程包括减去余额和增加余额两个步骤，我们如何保证操作的原子性？在没有任何干预的情况下，这两个步骤可能会遇到各种问题，例如B账户已销户或出现服务调用超时等情况。</p>
<p><strong>超时问题一直是分布式应用中比较难解决的问题</strong>，我们无法准确知晓B服务是否执行以及其执行顺序。从数据的角度来看，这意味着B 账户的钱未必会被成功加起来。在服务化改造之后，每个节点仅获知部分信息，而事务本身需要全局协调所有节点，因此需要一个拥有上帝视角、能够获取全部信息的中心化角色，这个角色就是<strong>TC（transaction coordinator）</strong>，它用于全局协调事务的状态。<strong>TM（Transaction Manager）</strong> 则是驱动事务生成提议的角色。但是，即使上帝也有打瞌睡的时候，他的判断也并不总是正确的，因此需要一个<strong>RM（resource manager）</strong> 角色作为灵魂的代表来验证事务的真实性。这就是TXC 最基本的哲学模型。我们从方法论上验证了它的数据一致性是非常完备的，当然，我们的认知是有边界的。也许未来会证明我们是火鸡工程师，但在当前情况下，它的模型已经足以解决大部分现有问题。</p>
<p><img decoding="async" loading="lazy" alt="分布式事务性能" src="/zh-cn/assets/images/分布式事务性能-379ce638304757417a8ed74fe07fc69c.jpg" width="1494" height="674" class="img_ev3q">
<strong>经过多年的架构演进，从事务的单链路耗时角度来看，TXC在事务开始时的处理平均时间约为0.2毫秒，分支注册的平均时间约为0.4毫秒，整个事务额外的耗时在毫秒级别之内。这也是我们推算出的极限理论值。在吞吐量方面，单节点的TPS达到3万次/秒，标准集群的TPS接近10万次/秒。</strong></p>
<br>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="seata-开源">Seata 开源<a href="#seata-开源" class="hash-link" aria-label="Seata 开源的直接链接" title="Seata 开源的直接链接">​</a></h4>
<p>为什么要做开源？这是很多人问过我的问题。2017年我们做了商业化的 GTS（Global Transaction Service ）产品产品在阿里云上售卖，有公有云和专有云两种形态。此时集团内发展的顺利，但是在我们商业化的过程中并不顺利，我们遇到了各种各样的问题，问题总结起来主要包括两类：<strong>一是开发者对于分布式事务的理论相当匮乏，</strong> 大多数人连本地事务都没搞明白是怎么回事更何况是分布式事务。 <strong>二是产品成熟度上存在问题，</strong> 经常遇到稀奇古怪的场景问题，导致了支持交付成本的急剧上升，研发变成了售后客服。</p>
<p>我们反思为什么遇到如此多的问题，这里主要的问题是在阿里集团内部是统一语言栈和统一技术栈的，我们对特定场景的打磨是非常成熟的，服务阿里一家公司和服务云上成千上万家企业有本质的区，这也启示我们产品的场景生态做的不够好。在GitHub 80%以上的开源软件是基础软件，基础软件首要解决的是场景通用性问题，因此它不能被有一家企业Lock In，比如像Linux，它有非常多的社区分发版本。因此，为了让我们的产品变得更好，我们选择了开源，与开发者们共建，普及更多的企业用户。</p>
<p><img decoding="async" loading="lazy" alt="阿里开源" src="/zh-cn/assets/images/阿里开源-b55a3c66abd52e6502162a991c8e92c3.jpg" width="1484" height="696" class="img_ev3q">
阿里的开源经历了三个主要阶段。<strong>第一个阶段是Dubbo所处的阶段，开发者用爱发电，</strong> Dubbo开源了有10几年的时间，时间充分证明了Dubbo是非常优秀的开源软件，它的微内核插件化的扩展性设计也是我最初开源Seata 的重要参考。做软件设计的时候我们要思考扩展性和性能权衡起来哪个会更重要一些，我们到底是要做一个三年的设计，五年的设计亦或是满足业务发展的十年设计。我们在做0-1服务调用问题的解决方案的同时，能否预测到1-100规模化后的治理问题。</p>
<p><strong>第二个阶段是开源和商业化的闭环，商业化反哺于开源社区，促进了开源社区的发展。</strong> 我认为云厂商更容易做好开源的原因如下：</p>
<ul>
<li>首先，云是一个规模化的经济，必然要建立在稳定成熟的内核基础上，在上面去包装其产品化能力包括高可用、免运维和弹性能力。不稳定的内核必然导致过高的交付支持成本，研发团队的支持答疑穿透过高，过高的交付成本无法实现大规模的复制，穿透率过高无法使产品快速的演进迭代。</li>
<li>其次，商业产品是更懂业务需求的。我们内部团队做技术的经常是站在 研发的视角YY 需求，做出来的东西没有人使用，也就不会形成价值的转换。商业化收集到的都是真实的业务需求，因此，它的开源内核也必须会朝着这个方向演进。如果不朝着这个方向去演进必然导致两边架构上的分裂，增加团队的维护成本。</li>
<li>最后，开源和商业化闭环，能促进双方更好的发展。如果开源内核经常出现各种问题，你是否愿意相信的它的商业化产品是足够优秀的。</li>
</ul>
<p><strong>第三个阶段是体系化和标准化。</strong> 首先，体系化是开源解决方案的基础。阿里的开源项目大多是基于内部电商场景的实践而诞生的。例如Higress，它用于打通蚂蚁集团的网关；Nacos承载着服务的百万实例和千万连接；Sentinel 提供大促时的降级和限流等高可用性能力；而Seata负责保障交易数据的一致性。这套体系化的开源解决方案是基于阿里电商生态的最佳实践而设计的。其次，标准化是另一个重要的特点。以OpenSergo为例，它既是一个标准，又是一个实现。在过去几年里，国内开源项目数量呈爆发式增长。然而，各个开源产品的能力差异很大，彼此集成时会遇到许多兼容性问题。因此，像OpenSergo这样的开源项目能够定义一些标准化的能力和接口，并提供一些实现，这将为整个开源生态系统的发展提供极大的帮助。</p>
<br>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="seata-社区最新进展">Seata 社区最新进展<a href="#seata-社区最新进展" class="hash-link" aria-label="Seata 社区最新进展的直接链接" title="Seata 社区最新进展的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="seata-社区简介">Seata 社区简介<a href="#seata-社区简介" class="hash-link" aria-label="Seata 社区简介的直接链接" title="Seata 社区简介的直接链接">​</a></h4>
<p><img decoding="async" loading="lazy" alt="社区简介" src="/zh-cn/assets/images/社区简介-f911410600da0ddea225d92d7a0e3e96.jpg" width="1484" height="686" class="img_ev3q">
<strong>目前，Seata已经开源了4种事务模式，包括AT、TCC、Saga和XA，并在积极探索其他可行的事务解决方案。</strong> Seata已经与10多个主流的RPC框架和关系数据库进行了集成，同时与20 多个社区存在集成和被集成的关系。此外，我们还在多语言体系上探索除Java之外的语言，如Golang、PHP、Python和JS。</p>
<p>Seata已经被几千家客户应用到业务系统中。Seata的应用已经变得越来越成熟，在金融业务场景中信银行和光大银行与社区做了很好的合作，并成功将其纳入到核心账务系统中。在金融场景对微服务体系的落地是非常严苛的，这也标志着Seata的内核成熟度迈上了一个新台阶。</p>
<br>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="seata-扩展生态">Seata 扩展生态<a href="#seata-扩展生态" class="hash-link" aria-label="Seata 扩展生态的直接链接" title="Seata 扩展生态的直接链接">​</a></h4>
<p><img decoding="async" loading="lazy" alt="扩展生态" src="/zh-cn/assets/images/扩展生态-aceedf7095dbb328b9a75e08443ec1c1.jpg" width="1490" height="702" class="img_ev3q">
<strong>Seata采用了微内核和插件化的设计，它在API、注册配置中心、存储模式、锁控制、SQL解析器、负载均衡、传输、协议编解码、可观察性等方面暴露了丰富的扩展点。</strong> 这使得业务可以方便地进行灵活的扩展和技术组件的选择。</p>
<br>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="seata-应用案例">Seata 应用案例<a href="#seata-应用案例" class="hash-link" aria-label="Seata 应用案例的直接链接" title="Seata 应用案例的直接链接">​</a></h4>
<p><img decoding="async" loading="lazy" alt="应用案例" src="/zh-cn/assets/images/应用案例-be6fb71d8ac5031679b2b52a9f158f61.jpg" width="1268" height="1286" class="img_ev3q">
<strong>案例1：中航信航旅纵横项目</strong><br>
<!-- -->中航信航旅纵横项目在Seata 0.2版本中引入Seata解决机票和优惠券业务的数据一致性问题，大大提高了开发效率、减少了数据不一致造成的资损并提升了用户交互体验。</p>
<p><strong>案例2：滴滴出行二轮车事业部</strong><br>
<!-- -->滴滴出行二轮车事业部在Seata 0.6.1版本中引入Seata，解决了小蓝单车、电动车、资产等业务流程的数据一致性问题，优化了用户使用体验并减少了资产的损失。</p>
<p><strong>案例3：美团基础架构</strong><br>
<!-- -->美团基础架构团队基于开源的Seata项目开发了内部分布式事务解决方案Swan，被用于解决美团内部各业务的分布式事务问题。</p>
<p><strong>场景4：盒马小镇</strong><br>
<!-- -->盒马小镇在游戏互动中使用Seata控制偷花的流程，开发周期大大缩短，从20天缩短到了5天，有效降低了开发成本。</p>
<br>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="seata-事务模式的演进">Seata 事务模式的演进<a href="#seata-事务模式的演进" class="hash-link" aria-label="Seata 事务模式的演进的直接链接" title="Seata 事务模式的演进的直接链接">​</a></h4>
<p><img decoding="async" loading="lazy" alt="模式演进" src="/zh-cn/assets/images/模式演进-ec00bf742388aa93e4aa2624f5d6fbc1.jpg" width="1492" height="574" class="img_ev3q"></p>
<br>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="seata-当前进展">Seata 当前进展<a href="#seata-当前进展" class="hash-link" aria-label="Seata 当前进展的直接链接" title="Seata 当前进展的直接链接">​</a></h4>
<ul>
<li>支持 Oracle和 Postgresql 多主键。</li>
<li>支持 Dubbo3</li>
<li>支持 Spring Boot3</li>
<li>支持 JDK 17</li>
<li>支持 ARM64 镜像</li>
<li>支持多注册模型</li>
<li>扩展了多种SQL语法</li>
<li>支持 GraalVM Native Image</li>
<li>支持 Redis lua 存储模  式</li>
</ul>
<br>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="seata-2x-发展规划">Seata 2.x 发展规划<a href="#seata-2x-发展规划" class="hash-link" aria-label="Seata 2.x 发展规划的直接链接" title="Seata 2.x 发展规划的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" alt="发展规划" src="/zh-cn/assets/images/发展规划-9b7132eb93fdaaa430a832be0142cebc.jpg" width="1476" height="678" class="img_ev3q"></p>
<p>主要包括下面几个方面：</p>
<ul>
<li><strong>存储/协议/特性</strong><br>
<!-- -->存储模式上探索存算不分离的Raft集群模式；更好的体验，统一当前4种事务模式的API；兼容GTS协议；支持Saga注解；支持分布式锁的控制；支持以数据视角的洞察和治理。</li>
<li><strong>生态</strong><br>
<!-- -->融合支持更多的数据库，更多的服务框架，同时探索国产化信创生态的支持；支持MQ生态；进一步完善APM的支持。</li>
<li><strong>解决方案</strong><br>
<!-- -->解决方案上除了支持微服务生态探索多云方案；更贴近云原生的解决方案；增加安全和流量防护能力；实现架构上核心组件的自闭环收敛。</li>
<li><strong>多语言生态</strong><br>
<!-- -->多语言生态中Java最成熟，其他已支持的编程语言继续完善，同时探索与语言无关的Transaction Mesh方案。</li>
<li><strong>研发效能/体验</strong><br>
<!-- -->提升测试的覆盖率，优先保证质量、兼容性和稳定性；重构官网文档结构，提升文档搜索的命中率；在体验上简化运维部署，实现一键安装和配置元数据简化；控制台支持事务控制和在线分析能力。</li>
</ul>
<p>一句话总结2.x 的规划：<strong>更大的场景，更大的生态，从可用到好用。</strong></p>
<br>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="seata-社区联系方式">Seata 社区联系方式<a href="#seata-社区联系方式" class="hash-link" aria-label="Seata 社区联系方式的直接链接" title="Seata 社区联系方式的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" alt="联系方式" src="/zh-cn/assets/images/联系方式-9883f643b19238bb617036df09d2731f.jpg" width="1158" height="356" class="img_ev3q"></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="本文介绍Seata在可观测领域的探索和实践"><meta itemprop="keywords" content="Seata、分布式事务、数据一致性、微服务、可观测"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-observable-practice">Seata的可观测实践</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-06-25T00:00:00.000Z" itemprop="datePublished">2023年6月25日</time> · <!-- -->阅读需 12 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">刘戎-Seata</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="seata简介">Seata简介<a href="#seata简介" class="hash-link" aria-label="Seata简介的直接链接" title="Seata简介的直接链接">​</a></h2>
<p>Seata的前身是阿里巴巴集团内大规模使用保证分布式事务一致性的中间件，Seata是其开源产品，由社区维护。在介绍Seata前，先与大家讨论下我们业务发展过程中经常遇到的一些问题场景。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="业务场景">业务场景<a href="#业务场景" class="hash-link" aria-label="业务场景的直接链接" title="业务场景的直接链接">​</a></h3>
<p>我们业务在发展的过程中，基本上都是从一个简单的应用，逐渐过渡到规模庞大、业务复杂的应用。这些复杂的场景难免遇到分布式事务管理问题，Seata的出现正是解决这些分布式场景下的事务管理问题。介绍下其中几个经典的场景：</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="场景一分库分表场景下的分布式事务">场景一：分库分表场景下的分布式事务<a href="#场景一分库分表场景下的分布式事务" class="hash-link" aria-label="场景一：分库分表场景下的分布式事务的直接链接" title="场景一：分库分表场景下的分布式事务的直接链接">​</a></h4>
<p><img decoding="async" loading="lazy" alt="image.png" src="/zh-cn/assets/images/metrics-分库分表场景下的分布式事务-ee0eff8cf24e6e3e997b0b040c56690e.png" width="1200" height="624" class="img_ev3q">
起初我们的业务规模小、轻量化，单一数据库就能保障我们的数据链路。但随着业务规模不断扩大、业务不断复杂化，通常单一数据库在容量、性能上会遭遇瓶颈。通常的解决方案是向分库、分表的架构演进。此时，即引入了<strong>分库分表场景下</strong>的分布式事务场景。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="场景二跨服务场景下的分布式事务">场景二：跨服务场景下的分布式事务<a href="#场景二跨服务场景下的分布式事务" class="hash-link" aria-label="场景二：跨服务场景下的分布式事务的直接链接" title="场景二：跨服务场景下的分布式事务的直接链接">​</a></h4>
<p><img decoding="async" loading="lazy" alt="image.png" src="/zh-cn/assets/images/metrics-跨服务场景下的分布式事务-ccc122e03531914d0945e82137912655.png" width="1200" height="647" class="img_ev3q">
降低单体应用复杂度的方案：应用微服务化拆分。拆分后，我们的产品由多个功能各异的微服务组件构成，每个微服务都使用独立的数据库资源。在涉及到跨服务调  用的数据一致性场景时，就引入了<strong>跨服务场景下</strong>的分布式事务。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="seata架构">Seata架构<a href="#seata架构" class="hash-link" aria-label="Seata架构的直接链接" title="Seata架构的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" alt="image.png" src="/zh-cn/assets/images/metrics-Seata架构-d45c1d1bf146b044c4f1b7f85ba3beb8.png" width="1534" height="908" class="img_ev3q">
其核心组件主要如下：</p>
<ul>
<li><strong>Transaction Coordinator（TC）</strong></li>
</ul>
<p>事务协调器，维护全局事务的运行状态，负责协调并驱动全局事务的提交或回滚。</p>
<ul>
<li><strong>Transaction Manager（TM）</strong></li>
</ul>
<p>控制全局事务的边界，负责开启一个全局事务，并最终发起全局提交或全局回滚的决议，TM定义全局事务的边界。</p>
<ul>
<li><strong>Resource Manager（RM）</strong></li>
</ul>
<p>控制分支事务，负责分支注册、状态汇报，并接收事务协调器的指令，驱动分支（本地）事务的提交和回滚。RM负责定义分支事务的边界和行为。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="seata的可观测实践">Seata的可观测实践<a href="#seata的可观测实践" class="hash-link" aria-label="Seata的可观测实践的直接链接" title="Seata的可观测实践的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="为什么需要可观测">为什么需要可观测？<a href="#为什么需要可观测" class="hash-link" aria-label="为什么需要可观测？的直接链接" title="为什么需要可观测？的直接链接">​</a></h3>
<ul>
<li><strong>分布式事务消息链路较复杂</strong></li>
</ul>
<p>Seata在解决了用户易用性和分布式事务一致性这些问题的同时，需要多次TC与TM、RM之间的交互，尤其当微服务的链路变复杂时，Seata的交互链路也会呈正相关性增加。这种情况  下，其实我们就需要引入可观测的能力来观察、分析事物链路。</p>
<ul>
<li><strong>异常链路、故障排查难定位，性能优化无从下手</strong></li>
</ul>
<p>在排查Seata的异常事务链路时，传统的方法需要看日志，这样检索起来比较麻烦。在引入可观测能力后，帮助我们直观的分析链路，快速定位问题；为优化耗时的事务链路提供依据。</p>
<ul>
<li><strong>可视化、数据可量化</strong></li>
</ul>
<p>可视化能力可让用户对事务执行情况有直观的感受；借助可量化的数据，可帮助用户评估资源消耗、规划预算。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="可观测能力概览">可观测能力概览<a href="#可观测能力概览" class="hash-link" aria-label="可观测能力概览的直接链接" title="可观测能力概览的直接链接">​</a></h3>
<table><thead><tr><th><strong>可观测维度</strong></th><th><strong>seata期望的能力</strong></th><th><strong>技术选型参考</strong></th></tr></thead><tbody><tr><td>Metrics</td><td>功能层面：可按业务分组隔离，采集事务总量、耗时等重要指标</td><td></td></tr><tr><td>性能层面：高度量性能，插件按需加载</td><td></td><td></td></tr><tr><td>架构层面：减少第三方依赖，服务端、客户端能够采用统一的架构，减少技术复杂度</td><td></td><td></td></tr><tr><td>兼容性层面：至少兼容Prometheus生态</td><td>Prometheus：指标存储和查询等领域有着业界领先的地位</td><td></td></tr><tr><td>OpenTelemetry：可观测数据采集和规范的事实标准。但自身并不负责数据的存储，展示和分析</td><td></td><td></td></tr><tr><td>Tracing</td><td>功能层面：全链路追踪分布式事务生命周期，反应分布式事务执行性能消耗</td><td></td></tr><tr><td>易用性方面：对使用seata的用户而言简单易接入</td><td>SkyWalking：利用Java的Agent探针技术，效率高，简单易用。</td><td></td></tr><tr><td>Logging</td><td>功能层面：记录服务端、客户端全部生命周期信息</td><td></td></tr><tr><td>易用性层面：能根据XID快速匹配全局事务对应链路日志</td><td>Alibaba Cloud Service</td><td></td></tr><tr><td>ELK</td><td></td><td></td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="metrics维度">Metrics维度<a href="#metrics维度" class="hash-link" aria-label="Metrics维度的直接链接" title="Metrics维度的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="设计思路">设计思路<a href="#设计思路" class="hash-link" aria-label="设计思路的直接链接" title="设计思路的直接链接">​</a></h4>
<ol>
<li>Seata作为一个被集成的数据一致性框架，Metrics模块将尽可能少的使用第三方依赖以降低发生冲突的风险</li>
<li>Metrics模块将竭力争取更高的度量性能和更低的资源开销，尽可能降低开启后带来的副作用</li>
<li>配置时，Metrics是否激活、数据如何发布，取决于对应的配置；开启配置则自动启用，并默认将度量数据通过prometheusexporter的形式发布</li>
<li>不使用Spring，使用SPI(Service Provider Interface)加载扩展</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="模块设计">模块设计<a href="#模块设计" class="hash-link" aria-label="模块设计的直接链接" title="模块设计的直接链接">​</a></h4>
<p><img decoding="async" loading="lazy" alt="图片 1.png" src="/zh-cn/assets/images/metrics-模块设计-44acf0482c9b8fbb5f6ec11a1423440c.png" width="1296" height="746" class="img_ev3q"></p>
<ul>
<li>seata-metrics-core：Metrics核心模块，根据配置组织（加载）1个Registry和N个Exporter；</li>
<li>seata-metrics-api：定义了Meter指标接口，Registry指标注册中心接口；</li>
<li>seata-metrics-exporter-prometheus：内置的prometheus-exporter实现；</li>
<li>seata-metrics-registry-compact：内置的Registry实现，并轻量级 实现了Gauge、Counter、Summay、Timer指标；</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="metrics模块工作流">metrics模块工作流<a href="#metrics模块工作流" class="hash-link" aria-label="metrics模块工作流的直接链接" title="metrics模块工作流的直接链接">​</a></h4>
<p><img decoding="async" loading="lazy" alt="图片 1.png" src="/zh-cn/assets/images/metrics-模块工作流-cf55ed8598aa42930fb5d0c58399463d.png" width="1534" height="964" class="img_ev3q">
上图是metrics模块的工作流，其工作流程如下：</p>
<ol>
<li>利用SPI机制，根据配置加载Exporter和Registry的实现类；</li>
<li>基于消息订阅与通知机制，监听所有全局事务的状态变更事件，并publish到EventBus；</li>
<li>事件订阅者消费事件，并将生成的metrics写入Registry；</li>
<li>监控系统（如prometheus）从Exporter中拉取数据。</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="tc核心指标">TC核心指标<a href="#tc核心指标" class="hash-link" aria-label="TC核心指标的直接链接" title="TC核心指标的直接链接">​</a></h4>
<p><img decoding="async" loading="lazy" alt="image.png" src="/zh-cn/assets/images/metrics-TC核心指标-7de91006545ab3e5518b6889456a8302.png" width="1746" height="1072" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="tm核心指标">TM核心指标<a href="#tm核心指标" class="hash-link" aria-label="TM核心指标的直接链接" title="TM核心指标的直接链接">​</a></h4>
<p><img decoding="async" loading="lazy" alt="image.png" src="/zh-cn/assets/images/metrics-TM核心指标-8ef5523801c632ae5af707ade30576b5.png" width="2308" height="1094" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="rm核心指标">RM核心指标<a href="#rm核心指标" class="hash-link" aria-label="RM核心指标的直接链接" title="RM核心指标的直接链接">​</a></h4>
<p><img decoding="async" loading="lazy" alt="image.png" src="/zh-cn/assets/images/metrics-RM核心指标-30ac5fe4e5c6e0d0727a3d28bf94ec82.png" width="2122" height="1580" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="大盘展示">大盘展示<a href="#大盘展示" class="hash-link" aria-label="大盘展示的直接链接" title="大盘展示的直接链接">​</a></h4>
<p><img decoding="async" loading="lazy" alt="lQLPJxZhZlqESU3NBpjNBp6w8zYK6VbMgzYCoKVrWEDWAA_1694_1688.png" src="/zh-cn/assets/images/metrics-大盘展示-1f6d2bdf7f5bc02f56244b361764ee7c.png" width="1694" height="1688" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tracing维度">Tracing维度<a href="#tracing维度" class="hash-link" aria-label="Tracing维度的直接链接" title="Tracing维度的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="seata为什么需要tracing">Seata为什么需要tracing？<a href="#seata为什么需要tracing" class="hash-link" aria-label="Seata为什么需要tracing？的直接链接" title="Seata为什么需要tracing？的直接链接">​</a></h4>
<ol>
<li>对业务侧而言，引入Seata后，对业务性能会带来多大损耗？主要时间消耗在什么地方？如何针对性的优化业务逻辑？这些都是未知的。</li>
<li>Seata的所有消息记录都通过日志持久化落盘，但对不了解Seata的用户而言，日志非常不友好。能否通过接入Tracing，提升事务链路排查效率？</li>
<li>对于新手用户，可通过Tracing记录，快速了解seata的工作原理，降低seata使用门槛。</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="seata的tracing解决方案">Seata的tracing解决方案<a href="#seata的tracing解决方案" class="hash-link" aria-label="Seata的tracing解决方案的直接链接" title="Seata的tracing解决方案的直接链接">​</a></h4>
<ul>
<li>Seata在自定义的RPC消息协议中定义了Header信息；</li>
<li>SkyWalking拦截指定的RPC消息，并注入tracing相关的span信息；</li>
<li>以RPC消息的发出&amp;接收为临界点，定义了span的生命周期范围。</li>
</ul>
<p>基于上述的方式，Seata实现了事务全链路的tracing，具体接入可参考<a href="/zh-cn/docs/user/apm/skywalking/">为[Seata应用 | Seata-server]接入Skywalking</a>。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="tracing效果">tracing效果<a href="#tracing效果" class="hash-link" aria-label="tracing效果的直接链接" title="tracing效果的直接链接">​</a></h4>
<ul>
<li>基于的demo场景：</li>
</ul>
<ol>
<li>用户请求交易服务</li>
<li>交易服务锁定库存</li>
<li>交易服务创建账单</li>
<li>账单服务进行扣款</li>
</ol>
<p><img decoding="async" loading="lazy" alt="image.png" src="/zh-cn/assets/images/metrics-tracing效果-业务逻辑图-92ed3a1bb1fc62135d8d02d1a21951fb.png" width="865" height="489" class="img_ev3q"></p>
<ul>
<li>GlobalCommit成功的事务链路（事例）</li>
</ul>
<p><img decoding="async" loading="lazy" alt="image.png" src="/zh-cn/assets/images/metrics-tracing效果-tracing链1-e4e8b13e4b0a74c76631560a66973d2a.png" width="1080" height="1788" class="img_ev3q">
<img decoding="async" loading="lazy" alt="image.png" src="/zh-cn/assets/images/metrics-tracing效果-tracing链2-d5a816ec8b49b6ca95309eeda8470825.png" width="1080" height="2647" class="img_ev3q">
<img decoding="async" loading="lazy" alt="image.png" src="/zh-cn/assets/images/metrics-tracing效果-tracing链3-c50deab1728f8e61946a26d7d1b49da8.png" width="1080" height="1466" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="logging维度">Logging维度<a href="#logging维度" class="hash-link" aria-label="Logging维度的直接链接" title="Logging维度的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="设计思路-1">设计思路<a href="#设计思路-1" class="hash-link" aria-label="设计思路的直接链接" title="设计思路的直接链接">​</a></h4>
<p><img decoding="async" loading="lazy" alt="image.png" src="/zh-cn/assets/images/metrics-logging设计思路-c90fe7b88cab305e7b3c918df2cba8b6.png" width="1434" height="454" class="img_ev3q">
Logging这一块其实承担的是可观测这几个维度当中的兜底角色。放在最底层的，其实就是我们日志格式的设计，只有好日志格式，我们才能对它进行更好的采集、模块化的存储和展示。在其之上，是日志的采集、存储、监控、告警、数据可视化，这些模块更多的是有现成的工具，比如阿里的SLS日志服务、还有ELK的一套技术栈，我们更多是将开销成本、接入复杂度、生态繁荣度等作为考量。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="日志格式设计">日志格式设计<a href="#日志格式设计" class="hash-link" aria-label="日志格式设计的直接链接" title="日志格式设计的直接链接">​</a></h4>
<p>这里拿Seata-Server的一个日志格式作为案例：
<img decoding="async" loading="lazy" alt="image.png" src="/zh-cn/assets/images/metrics-logging日志效果-049f409856a4895fe3d27d7930e028f8.png" width="1342" height="364" class="img_ev3q"></p>
<ul>
<li>线程池规范命名：当线程池、线程比较多时，规范的线程命名能将无序执行的线程执行次序清晰展示。</li>
<li>方法全类名可追溯：快速定位到具体的代码块。</li>
<li>重点运行时信息透出：重点突出关键日志，不关键的日志不打印，减少日志冗余。</li>
<li>消息格式可扩展：通过扩展消息类的输出格式，减少日志的代码修改量。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结展望">总结&amp;展望<a href="#总结展望" class="hash-link" aria-label="总结&amp;展望的直接链接" title="总结&amp;展望的直接链接">​</a></h2>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="metrics">Metrics<a href="#metrics" class="hash-link" aria-label="Metrics的直接链接" title="Metrics的直接链接">​</a></h4>
<p>总结：基本实现分布式事务的可量 化、可观测。
展望：更细粒度的指标、更广阔的生态兼容。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="tracing">Tracing<a href="#tracing" class="hash-link" aria-label="Tracing的直接链接" title="Tracing的直接链接">​</a></h4>
<p>总结：分布式事务全链路的可追溯。
展望：根据xid追溯事务链路，异常链路根因快速定位。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="logging">Logging<a href="#logging" class="hash-link" aria-label="Logging的直接链接" title="Logging的直接链接">​</a></h4>
<p>总结：结构化的日志格式。
展望：日志可观测体系演进。</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="生产环境可用的 seata-go 1.2.0 来了！！！"><meta itemprop="keywords" content="seata、分布式事务、golang、1.2.0"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-go-1.2.0">生产环境可用的 seata-go 1.2.0 来了！！！</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-06-08T00:00:00.000Z" itemprop="datePublished">2023年6月8日</time> · <!-- -->阅读需 3 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">Seata社区</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="生产环境可用的-seata-go-120-来了">生产环境可用的 seata-go 1.2.0 来了<a href="#生产环境可用的-seata-go-120-来了" class="hash-link" aria-label="生产环境可用的 seata-go 1.2.0 来了的直接链接" title="生产环境可用的 seata-go 1.2.0 来了的直接链接">​</a></h2>
<p>Seata 是一款开源的分布式事务解决方案，提供高性能和简单易用的分布式事务服务。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="发布概览">发布概览<a href="#发布概览" class="hash-link" aria-label="发布概览的直接链接" title="发布概览的直接链接">​</a></h3>
<p>Seata-go 1.2.0 版本支持 XA 模式。XA 协议是由 X/Open 组织提出的分布式事务处理规范，其优点是对业务代码无侵入。当前 Seata-go 的 XA 模式支持 MySQL 数据库。至此，seata-go 已经集齐 AT、TCC 和 XA 三种事务模式。 XA 模式的主要功能:</p>
<ul>
<li>支持了 XA 数据源代理 <a href="https://github.com/apache/incubator-seata-go-samples/tree/main/xa" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata-go-samples/tree/main/xa</a></li>
<li>支持了 XA 事务模式
XA 相关的 sampes 可以参考示例：<a href="https://github.com/apache/incubator-seata-go-samples/tree/main/xa" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata-go-samples/tree/main/xa</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="feature">feature<a href="#feature" class="hash-link" aria-label="feature的直接链接" title="feature的直接链接">​</a></h3>
<ul>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/467" target="_blank" rel="noopener noreferrer">#467</a>] 实现 XA 模式支持 MySQL</li>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/534" target="_blank" rel="noopener noreferrer">#534</a>] 支持 session 的负载均衡</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bugfix">bugfix<a href="#bugfix" class="hash-link" aria-label="bugfix的直接链接" title="bugfix的直接链接">​</a></h3>
<ul>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/540" target="_blank" rel="noopener noreferrer">#540</a>] 修复初始化 xa 模式的 bug</li>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/545" target="_blank" rel="noopener noreferrer">#545</a>] 修复 xa 模式获取 db 版本号的 bug</li>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/548" target="_blank" rel="noopener noreferrer">#548</a>] 修复启动 xa 会失败的 bug</li>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/556" target="_blank" rel="noopener noreferrer">#556</a>] 修复 xa 数据源的 bug</li>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/562" target="_blank" rel="noopener noreferrer">#562</a>] 修复提交 xa 全局事务的 bug</li>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/564" target="_blank" rel="noopener noreferrer">#564</a>] 修复提交 xa 分支事务的 bug</li>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/566" target="_blank" rel="noopener noreferrer">#566</a>] 修复使用 xa 数据源执行本地事务的 bug</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="optimize">optimize<a href="#optimize" class="hash-link" aria-label="optimize的直接链接" title="optimize的直接链接">​</a></h3>
<ul>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/523" target="_blank" rel="noopener noreferrer">#523</a>] 优化 CI 流程</li>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/525" target="_blank" rel="noopener noreferrer">#525</a>] 将 jackson 序列化重命名为 json</li>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/532" target="_blank" rel="noopener noreferrer">#532</a>] 移除重复的代码</li>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/536" target="_blank" rel="noopener noreferrer">#536</a>] 优化 go import 代码格式</li>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/554" target="_blank" rel="noopener noreferrer">#554</a>] 优化 xa 模式的性能</li>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/561" target="_blank" rel="noopener noreferrer">#561</a>] 优化 xa 模式的日 志输出</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="test">test<a href="#test" class="hash-link" aria-label="test的直接链接" title="test的直接链接">​</a></h3>
<ul>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/535" target="_blank" rel="noopener noreferrer">#535</a>] 添加集成测试</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="doc">doc<a href="#doc" class="hash-link" aria-label="doc的直接链接" title="doc的直接链接">​</a></h3>
<ul>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/550" target="_blank" rel="noopener noreferrer">#550</a>] 添加 1.2.0 版本的改动日志</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="contributors">contributors<a href="#contributors" class="hash-link" aria-label="contributors的直接链接" title="contributors的直接链接">​</a></h3>
<p>Thanks to these contributors for their code commits. Please report an unintended omission.</p>
<ul>
<li><a href="https://github.com/georgehao" target="_blank" rel="noopener noreferrer">georgehao</a></li>
<li><a href="https://github.com/luky116" target="_blank" rel="noopener noreferrer">luky116</a></li>
<li><a href="https://github.com/jasondeng1997" target="_blank" rel="noopener noreferrer">jasondeng1997</a></li>
<li><a href="https://github.com/106umao" target="_blank" rel="noopener noreferrer">106umao</a></li>
<li><a href="https://github.com/wang1309" target="_blank" rel="noopener noreferrer">wang1309</a></li>
<li><a href="https://github.com/iSuperCoder" target="_blank" rel="noopener noreferrer">iSuperCoder</a></li>
<li><a href="https://github.com/Charlie17Li" target="_blank" rel="noopener noreferrer">Charlie17Li</a></li>
<li><a href="https://github.com/Code-Fight" target="_blank" rel="noopener noreferrer">Code-Fight</a></li>
<li><a href="https://github.com/Kirhaku" target="_blank" rel="noopener noreferrer">Kirhaku</a></li>
<li><a href="https://github.com/VaderKai" target="_blank" rel="noopener noreferrer">Vaderkai</a></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="link">Link<a href="#link" class="hash-link" aria-label="Link的直接链接" title="Link的直接链接">​</a></h4>
<ul>
<li><a href="https://github.com/apache/incubator-seata" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata</a></li>
<li><a href="https://github.com/apache/incubator-seata-go" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata-go</a></li>
<li><a href="https://github.com/apache/incubator-seata-samples" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata-samples</a></li>
<li><a href="https://github.com/apache/incubator-seata-go-samples" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata-go-samples</a></li>
<li><a href="https://seata.apache.org" target="_blank" rel="noopener noreferrer">https://seata.apache.org</a></li>
</ul></div><footer class="row docusaurus-mt-lg"></footer></article><nav class="pagination-nav" aria-label="博文列表分页导航"><a class="pagination-nav__link pagination-nav__link--next" href="/zh-cn/blog/page/2"><div class="pagination-nav__label">较旧的博文</div></a></nav></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://incubator.apache.org/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/zh-cn/img/apache/incubator.svg" alt="Apache Incubator Logo" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE"><img src="/zh-cn/img/apache/incubator.svg" alt="Apache Incubator Logo" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU"></a></div><div class="footer__copyright">
                  <div class="fs-12">
                    <div class="center-div">
                      <span>Apache Seata (incubating) is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</span>
                    </div>
                    <br>
                    <div class="center-div">
                      <span>Copyright © 2023-2024, The Apache Software Foundation Apache Seata, Seata, Apache, Apache Incubator, the Apache feather, the Apache Incubator logo and the Apache Seata project logo are either registered trademarks or trademarks of the Apache Software Foundation.</span>
                      <br>
                    </div>
                    <br>
                  </div>
                  </div></div></div></footer></div>
</body>
</html>