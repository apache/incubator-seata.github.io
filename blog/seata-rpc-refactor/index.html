<!doctype html>
<html lang="en-US" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">The Refactoring Journey of Seata RPC Module | Apache Seata</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://seata.apache.org/img/seata_logo.png"><meta data-rh="true" name="twitter:image" content="https://seata.apache.org/img/seata_logo.png"><meta data-rh="true" property="og:url" content="https://seata.apache.org/blog/seata-rpc-refactor"><meta data-rh="true" property="og:locale" content="en_US"><meta data-rh="true" property="og:locale:alternate" content="zh_CN"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="The Refactoring Journey of Seata RPC Module | Apache Seata"><meta data-rh="true" name="description" content="RPC module is where I initially started to study Seata source code, so I have had some deep research on Seata&#x27;s RPC module. After I did some research, I found that the code in the RPC module needs to be optimised to make the code more elegant and the interaction logic more clear and easy to understand, and in line with the original intention of &quot;Let the world have no difficult to understand"><meta data-rh="true" property="og:description" content="RPC module is where I initially started to study Seata source code, so I have had some deep research on Seata&#x27;s RPC module. After I did some research, I found that the code in the RPC module needs to be optimised to make the code more elegant and the interaction logic more clear and easy to understand, and in line with the original intention of &quot;Let the world have no difficult to understand"><meta data-rh="true" name="keywords" content="Seata,RPC module,refactoring"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2020-07-13T00:00:00.000Z"><link data-rh="true" rel="icon" href="/img/seata_logo_small.jpeg"><link data-rh="true" rel="canonical" href="https://seata.apache.org/blog/seata-rpc-refactor"><link data-rh="true" rel="alternate" href="https://seata.apache.org/blog/seata-rpc-refactor" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://seata.apache.org/zh-cn/blog/seata-rpc-refactor" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://seata.apache.org/blog/seata-rpc-refactor" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://ICHFIJRDZF-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache Seata RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache Seata Atom Feed">


<link rel="search" type="application/opensearchdescription+xml" title="Apache Seata" href="/opensearch.xml">


<meta name="aes-config" content="pid=xux-opensource&amp;user_type=101&amp;uid=&amp;username=&amp;dim10=seata"><link rel="stylesheet" href="/assets/css/styles.9644caf2.css">
<script src="/assets/js/runtime~main.bf98ee01.js" defer="defer"></script>
<script src="/assets/js/main.88c554fd.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/seata_logo.png" alt="Seata Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/seata_logo.png" alt="Seata Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/">Home</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="/overview/what-is-seata" href="/docs/overview/what-is-seata">v2.2</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/overview/what-is-seata">Next Version</a></li><li><a class="dropdown__link" href="/docs/overview/what-is-seata">v2.2</a></li><li><a class="dropdown__link" href="/docs/v2.1/overview/what-is-seata">v2.1</a></li><li><a class="dropdown__link" href="/docs/v2.0/overview/what-is-seata">v2.0</a></li><li><a class="dropdown__link" href="/docs/v1.8/overview/what-is-seata">v1.8</a></li><li><a class="dropdown__link" href="/docs/v1.7/overview/what-is-seata">v1.7</a></li><li><a class="dropdown__link" href="/docs/v1.6/overview/what-is-seata">v1.6</a></li><li><a class="dropdown__link" href="/docs/v1.5/overview/what-is-seata">v1.5</a></li><li><a class="dropdown__link" href="/docs/v1.4/overview/what-is-seata">v1.4</a></li><li><a class="dropdown__link" href="/docs/v1.3/overview/what-is-seata">v1.3</a></li><li><a class="dropdown__link" href="/docs/v1.2/overview/what-is-seata">v1.2</a></li><li><a class="dropdown__link" href="/docs/v1.1/overview/what-is-seata">v1.1</a></li><li><a class="dropdown__link" href="/docs/v1.0/overview/what-is-seata">v1.0</a></li></ul></div><a class="navbar__item navbar__link" href="/docs/developers/contributor-guide/new-contributor-guide_dev">Developers</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/users">Users</a><a class="navbar__item navbar__link" href="/community">Community</a><a class="navbar__item navbar__link" href="/unversioned/download/seata-server">Download</a><a class="navbar__item navbar__link" href="/solution">Solution</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Designer</a><ul class="dropdown__menu"><li><a href="/saga-designer" class="dropdown__link" target="_blank">Saga Designer</a></li><li><a href="/saga-designer-legacy" class="dropdown__link" target="_blank">Saga Designer (Legacy)</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/security" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_DSK9"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>En</a><ul class="dropdown__menu"><li><a href="/blog/seata-rpc-refactor" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en-US">En</a></li><li><a href="/zh-cn/blog/seata-rpc-refactor" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-CN">ä¸­</a></li></ul></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All Posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-namingserver">seata-namingserver</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-raft-config-center">Seata Raft Configuration Center</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-rpc-multi-protocol01">Seata&#x27;s RPC Communication Source Code Analysis 01(Transport)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-rpc-multi-protocol02">Seata&#x27;s RPC Communication Source Code Analysis 02(Multi-Version Protocols)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/how-to-write-unit-tests">How to Write Test Cases in Seata</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/explore-seata-journey">Exploring the Journey of Open Source Development in Seata Project</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-raft-detailed-explanation">Seata-Raft Storage Mode in Depth and Getting Started</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-connect-data-and-application">Seata:Bridging Data and Applications</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-observable-practice">Observability Practices in Seata</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-go-1.2.0">seata-go 1.2.0 Ready for Production Environment!!!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/iscas2023">6 Major Topics Now Open for Selection | Welcome to Apply for Seata Open Source Summer</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-1.6.0">Seata 1.6.0 Released with Significant Performance Improvement</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-1.5.2">Seata 1.5.2 Released with XID Load Balancing Support</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-tcc-fence">Alibaba Seata Resolves Idempotence, Dangling, and Empty Rollback Issues in TCC Mode</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-tcc">In-Depth Analysis of Seata TCC Mode (1)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-lock">In-Depth Analysis of Seata AT Mode Transaction Isolation Levels and Global Lock Design</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-snowflake-explain">Q&amp;A on the New Version of Snowflake Algorithm</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-UUID-generator">Analysis of Seata&#x27;s Distributed UUID Generator Based on Improved Snowflake Algorithm</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-feature-undo-log-compress">Seata New Feature Support -- Undo_Log Compression</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-dsproxy-deadlock">Seata Deadlock Issue Caused by ConcurrentHashMap</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-client-start-analysis-02">Seata Application-Side Startup Process Analysis â Registry and Configuration Module</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-client-start-analysis-01">Analysis of Seata Application-Side Startup Process - How RM &amp; TM Establish Connections with TC</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/integrate-seata-tcc-mode-with-spring-cloud">Integration of Spring Cloud with Seata for Distributed Transaction - TCC Mode</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-config-manager">Analysis of Seata Configuration Management Principles</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-golang-communication-mode">Detailed Explanation of seata-golang Communication Model</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-datasource-proxy">Analysis of Seata Data Source Proxy</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-sourcecode-client-bootstrap">Seata Source Code - Client Startup Process in Distributed Transactions</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-demo-in-mac">Setting Up Seata Demo Environment on Mac (AT Mode)</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/seata-rpc-refactor">The Refactoring Journey of Seata RPC Module</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-sourcecode-server-bootstrap">Seata Source Code - Server Startup Process in Distributed Transactions</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-xa-introduce">How is distributed transaction realized? In-depth interpretation of Seata&#x27;s XA mode</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-quick-start">Seata Quick Start</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-ha-practice">Seata High Availability Deployment Practice</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-config-modular">Seata Config Module Source Code Analysis</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-dubbo-transmit-xid">Source Code Analysis of Seata-XID Propagation in Dubbo</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-tcc-modular">Seata TCC Module Source Code Analysis</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-community-meetup-hangzhou-ready">Seata Community MeetupÂ·Hangzhou Station</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-core-modular">Seata Core Module Source Code Analysis</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-spring-boot-aop-aspectj">Dynamically Creating/Closing Seata Distributed Transactions through AOP</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-dynamic-config-and-dynamic-disable">Seata Dynamic Configuration Subscription and Degradation Implementation Principles</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-config-center">Seata Configuration Center Implementation Principles</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-nacos-docker">Docker Deployment of Seata Integration with Nacos</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-nacos-analysis">Configuring Seata Distributed Transaction with Nacos as the Configuration Center</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-meetup-hangzhou">Seata Community MeetupÂ·Hangzhou Station</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-mybatisplus-analysis">Resolving the Issue of Losing Mybatis-Plus Features in Seata AT Mode Integration through Source Code</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/springboot-dubbo-mybatisplus-seata">Integrating Seata Distributed Transaction with SpringBoot+Dubbo+MybatisPlus</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-mode-start-rm-tm">Does Seata Client Need to Start RM and TM Simultaneously?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-mode-start">Seata AT Mode Startup Source Code Analysis</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/design-more-flexable-application-by-saga">Designing More Flexible Financial Applications with Seata Saga</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-tcc-saga">Comprehensive Explanation of Distributed Transaction Seata and Its Three Modes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-mode-design">Design Principles of Distributed Transaction Middleware Seata</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-go-server">Seata Distributed Go Server Officially Open Source - Introduction to TaaS Design</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/how-to-support-spring-cloud">Fescar Integration with Spring Cloud In-Depth Analysis of Source Code</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/integrate-seata-with-spring-cloud">Integrating Seata (formerly Fescar) Distributed Transaction with Spring Cloud</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-java-client">Detailed Explanation of Seata-Client Principles and Processes in Distributed Transactions</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-java-server">In-Depth Analysis of One-Stop Distributed Transaction Solution Seata-Server</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tcc-mode-applicable-scenario-analysis">Analysis of Applicable Models and Scenarios for TCC</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tcc-mode-design-principle">Introduction to TCC Theory and Design Implementation Guide</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/quick-start-use-seata-and-dubbo-services">How to use Seata to ensure consistency between Dubbo Microservices</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-simple">Unveiling the Principles of Fescar Distributed Transaction</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/manual-transaction-mode">MT mode</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="RPC module is where I initially started to study Seata source code, so I have had some deep research on Seata&#x27;s RPC module. After I did some research, I found that the code in the RPC module needs to be optimised to make the code more elegant and the interaction logic more clear and easy to understand, and in line with the original intention of &quot;Let the world have no difficult to understand"><meta itemprop="keywords" content="Seata,RPC module,refactoring"><header><h1 class="title_f1Hy" itemprop="headline">The Refactoring Journey of Seata RPC Module</h1><div class="container_mt6G margin-vert--md"><time datetime="2020-07-13T00:00:00.000Z" itemprop="datePublished">July 13, 2020</time> Â· <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">chenghui.zhang</span></div></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>RPC module is where I initially started to study Seata source code, so I have had some deep research on Seata&#x27;s RPC module. After I did some research, I found that the code in the RPC module needs to be optimised to make the code more elegant and the interaction logic more clear and easy to understand, and in line with the original intention of &quot;**Let the world have no difficult to understand
In the spirit of &quot;<strong>Let there be no difficult RPC communication code</strong>&quot;, I started the refactoring of the RPC module.</p>
<p>Here I suggest that if you want to know more about Seata interaction details, you may want to start from the source code of RPC module, RPC module is equivalent to Seata&#x27;s hub, Seata all the interaction logic in the RPC module to show the most.</p>
<p>This refactoring of the RPC module will make the Seata hub more robust and easier to interpret.</p>
<h1>Refactoring Inheritance</h1>
<p>In the old version of Seata, the overall structure of the RPC module was a bit confusing, especially in terms of the inheritance relationships between classes:</p>
<ol>
<li>directly inheriting Netty Handler in Remoting class, which makes Remoting class coupled with Netty Handler processing logic;</li>
<li>The inheritance relationship between the Reomting class on the client side and the Reomting class on the server side is not unified;</li>
<li>RemotingClient is implemented by RpcClientBootstrap, while RemotingServer is implemented by RpcServer without an independent ServerBootstrap, which seems to be a very confusing relationship. 4. Some interfaces are not necessary to be extracted;</li>
<li>Some interfaces are not necessary to extract, such as ClientMessageSender, ClientMessageListener, ServerMessageSender and so on, because these interfaces will increase the complexity of the overall structure of the inheritance relationship.</li>
</ol>
<p>In response to the problems identified above, I did the following during the refactoring process:</p>
<ol>
<li>Abstract Netty Handler as an inner class and put it in Remoting class. 2) Put RemotingClient as an inner class and put it in RemotingClass;</li>
</ol>
<ol start="2">
<li>put RemotingClient as the top-level client interface, define the basic methods of client-server interaction, abstract a layer of AbstractNettyRemotingClient, and the following are respectively
RmNettyRemotingClient, TmNettyRemotingClient; RemotingServer is the top-level interface of server, defining the basic methods of interaction between the server and the client, and the implementation of NettyRemotingServer;</li>
<li>At the same time, ClientMessageSender, ClientMessageListener, ServerMessageSender and other interface methods are grouped into RemotingClient, RemotingServer, and implemented by Reomting.
class to implement RemotingClient and RemotingServer and unify the inheritance relationship of Remoting class;</li>
<li>Create a new RemotingBootstrap interface and implement NettyClientBootstrap and NettyServerBootstrap on the client and server side respectively, so as to extract the bootstrap logic from the Reomting class.</li>
</ol>
<p>The inheritance relationship in the latest RPC module is simple and clear, represented by the following class relationship diagram:</p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20200711111637.png" alt="" class="img_ev3q"></p>
<ol>
<li>AbstractNettyRemoting: the top level abstraction of Remoting class, contains common member variables and common methods for both client and server, has common request methods (we will talk about it later in the article), and Processor processor invocation logic (we will talk about it later in the article);</li>
<li>RemotingClient: the client&#x27;s top-level interface, defining the basic methods of client-server interaction;</li>
<li>RemotingServer: the top-level interface of the server side, defining the basic methods of interaction between the server side and the client side;</li>
<li>AbstractNettyRemotingClient: client-side abstract class, inherits AbstractNettyRemoting class and implements RemotingClient interface;</li>
<li>NettyRemotingServer: server implementation class, inherits AbstractNettyRemoting class and implements RemotingServer interface;</li>
<li>RmNettyRemotingClient: Rm client implementation class, inherits AbstractNettyRemotingClient class;</li>
<li>TmNettyRemotingClient: Tm client implementation class, inherits AbstractNettyRemotingClient class.</li>
</ol>
<p>At the same time, the client-side and server-side bootstrap class logic is abstracted out, as shown in the following class relationship diagram:</p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20200510225359.png" alt="" class="img_ev3q"></p>
<ol>
<li>RemotingBootstrap: bootstrap class interface with two abstract methods: start and stop. 2;</li>
<li>NettyClientBootstrap: client-side bootstrap implementation class. 3;</li>
<li>NettyServerBootstrap: server-side bootstrap implementation class.</li>
</ol>
<h1>Decoupled processing logic</h1>
<p>Decoupled processing logic is the processing logic of RPC interactions from the Netty Handler abstracted out, and processing logic into a Processor abstraction, why do this? I&#x27;m going to talk about some of the problems that exist right now:</p>
<ol>
<li>Netty Handler and Processing Logic are blended together, since both client and server share a set of Processing Logic, in order to be compatible with more interactions, in the Processing Logic you can see a lot of difficult to understand judgement logic. 2. in Seata interactions, the Netty Handler is not a Processor;</li>
<li>In Seata&#x27;s interaction, some requests are processed asynchronously and some requests are processed synchronously, but the expression of synchronous and asynchronous processing in the old processing code logic is very obscure and difficult to understand;</li>
<li>It is not possible to clearly express the relationship between the type of request message and the corresponding processing logic in the code logic;</li>
<li>In the later iterations of Seata, it will be very difficult to add new interaction logic to this part of the code if the processing logic is not extracted from it.</li>
</ol>
<p>Before extracting the processing logic from the Netty Handler, let&#x27;s take a look at Seata&#x27;s existing interaction logic:</p>
<ul>
<li>RM client-server interaction logic:</li>
</ul>
<p>RM client request server interaction logic: <img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/Xnip2020-05-12_21-41-45.png" alt="" class="img_ev3q"></p>
<ul>
<li>TM client-server interaction logic:</li>
</ul>
<p>RM Client Request Server Interaction Logic: <img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/Xnip2020-05-12_21-44-04.png" alt="" class="img_ev3q"></p>
<ul>
<li>Interaction logic for a server requesting an RM client:</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20200513000620.png" alt="" class="img_ev3q"></p>
<p>The interaction logic of Seata can be clearly seen in the above interaction diagram.</p>
<p>The client receives messages from the server side in total:</p>
<ol>
<li>Server-side request messages</li>
</ol>
<ol>
<li>BranchCommitRequest, BranchRollbackRequest, UndoLogDeleteRequest</li>
</ol>
<ol start="2">
<li>Server-side response messages</li>
</ol>
<ol>
<li>RegisterRMResponse, BranchRegisterResponse, BranchReportResponse, GlobalLockQueryResponse</li>
<li></li>
</ol>
<p>RegisterTMResponse, GlobalBeginResponse, GlobalCommitResponse, GlobalRollbackResponse, GlobalStatusResponse, GlobalReportResponse
3. HeartbeatMessage(PONG)</p>
<p>The server receives messages from the client in total:</p>
<ol>
<li>Client request messages:</li>
</ol>
<ol>
<li>RegisterRMRequest, BranchRegisterRequest, BranchReportRequest, GlobalLockQueryRequest</li>
<li></li>
</ol>
<p>RegisterTMRequest, GlobalBeginRequest, GlobalCommitRequest, GlobalRollbackRequest, GlobalStatusRequest, GlobalReportRequest
3. HeartbeatMessage(PING)</p>
<ol start="2">
<li>Client response message:</li>
</ol>
<ol>
<li>BranchCommitResponse, BranchRollbackResponse</li>
</ol>
<p>Based on the above analysis of the interaction logic, we can abstract the logic of processing messages into a number of Processor, a Processor can handle one or more message types of messages, only in Seata startup registration will be registered to the message type ProcessorTable
A Processor can process messages of one or more message types, just register the message types into the ProcessorTable when Seata starts up, forming a mapping relationship, so that the corresponding Processor can be called to process the message according to the message type, as shown in the following diagram:</p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/Xnip2020-05-12_22-09-17.png" alt="" class="img_ev3q"></p>
<p>In the abstract Remoting class, there is a processMessage method, the logic of the method is to get the corresponding Processor from the ProcessorTable according to the message type.</p>
<p>In this way, the processing logic is completely removed from the Netty Handler, and the Handler#channelRead method only needs to call the processMessage method, and it can dynamically register Processors into the ProcessorTable according to the message type.
ProcessorTable, the scalability of the processing logic has been greatly improved.</p>
<p>The following is the invocation flow of Processor:</p>
<ol>
<li>Client</li>
</ol>
<p><img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20200510234047.png" alt="" class="img_ev3q"></p>
<ol>
<li>RmBranchCommitProcessor: process the server-side global commit request;</li>
<li>RmBranchRollbackProcessor: process server-side global rollback request;</li>
<li>RmUndoLogProcessor: handles server-side undo log deletion requests;</li>
<li>ClientOnResponseProcessor: client-side processing of server-side response requests, such as: BranchRegisterResponse, GlobalBeginResponse, GlobalCommitResponse and so on;</li>
<li>ClientHeartbeatProcessor: processing server-side heartbeat response.</li>
</ol>
<ol start="2">
<li>Server-side</li>
</ol>
<p><img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20200510234016.png" alt="" class="img_ev3q"></p>
<ol>
<li>RegRmProcessor: Handle RM client registration request. 2;</li>
<li>RegTmProcessor: handle TM client registration request;</li>
<li>ServerOnRequestProcessor: handle client related requests, such as: BranchRegisterRequest, GlobalBeginRequest, GlobalLockQueryRequest, etc. 4;</li>
<li>ServerOnResponseProcessor: handle client-related responses, such as: BranchCommitResponse, BranchRollbackResponse and so on;</li>
<li>ServerHeartbeatProcessor: handle client heartbeat response.</li>
</ol>
<p>Below is an example of a TM initiating a global transaction commit request to give you a sense of where the Processor sits in the entire interaction:</p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20200514191842.png" alt="" class="img_ev3q"></p>
<h1>Refactoring the request method</h1>
<p>In older versions of Seata, the request methods for RPC also lacked elegance:</p>
<ol>
<li>request methods are too cluttered and not hierarchical;</li>
<li>sendAsyncRequest method is coupled with too much code, the logic is too confusing, the client and server both share a set of request logic, the method to decide whether to send bulk is based on the parameter address is null or not to decide, to decide whether to synchronise the request is based on whether the timeout is greater than 0, it is extremely unreasonable, and it is not reasonable.
The method to decide whether to send bulk is based on whether the address is null, and to decide whether to make a synchronous request is based on whether the timeout is greater than 0, which is extremely unreasonable;</li>
<li>request method name style is not uniform, for example, the client sendMsgWithResponse, but the server is called sendSyncRequest;</li>
</ol>
<p>To address the above shortcomings of the old RPC request methods, I have made the following changes. 1:</p>
<ol>
<li>put the request method into the RemotingClient and RemotingServer interfaces as the top-level interface. 2. separate the client-side and server-side request methods;</li>
<li>Separate the client-side and server-side request logic, and separate the batch request logic into the client-side request method, so that the decision of whether or not to send a batch of requests is no longer based on whether or not the parameter address is null;</li>
<li>due to Seata&#x27;s
Due to Seata&#x27;s own logic characteristics, the parameters of client-server request methods cannot be unified, so we can extract common synchronous/asynchronous request methods, the client and server implement their own synchronous/asynchronous request logic according to their own request logic characteristics, and then finally call the common synchronous/asynchronous request methods, so that synchronous/asynchronous requests have a clear method, and are no longer decided according to whether or not the
timeout is greater than 0. 4;</li>
<li>Unify the request name style.</li>
</ol>
<p>Finally, Seata RPC request methods look more elegant and hierarchical.</p>
<p>Synchronous requests:</p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20200513103838.png" alt="" class="img_ev3q"></p>
<p>Asynchronous request:</p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20200513103904.png" alt="" class="img_ev3q"></p>
<h1>Other</h1>
<ol>
<li>Class Catalogue Adjustment: There is also a netty catalogue in the RPC module catalogue, and it can be found from the catalogue structure that Seata&#x27;s original intention is to be compatible with multiple RPC frameworks, and only netty is implemented at present, but it is found that some of the classes in the netty module are not &quot;netty&quot; and the classes in the RPC
classes in the netty module are not &quot;netty&quot;, and the RPC classes in the catalogue are not common, so the location of the relevant classes needs to be adjusted;</li>
<li>some classes are renamed, e.g. netty related classes contain &quot;netty&quot;;</li>
</ol>
<p>The final RPC module looks like this:</p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20200711213204.png" alt="" class="img_ev3q"></p>
<h1>Author Bio</h1>
<p>Zhang Chenghui, currently working in Ant Group, loves to share technology, author of WeChat public number &quot;Backend Advanced&quot;, technical blog (<a href="https://objcoding.com/" target="_blank" rel="noopener noreferrer">https://objcoding.com/</a>) blogger, Seata Contributor, GitHub
ID: objcoding.</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col margin-top--sm"><a href="https://github.com/apache/incubator-seata-website/blob/docusaurus/i18n/en/docusaurus-plugin-content-blog/seata-rpc-refactor.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/seata-at-demo-in-mac"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Setting Up Seata Demo Environment on Mac (AT Mode)</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/seata-sourcecode-server-bootstrap"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Seata Source Code - Server Startup Process in Distributed Transactions</div></a></nav></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://incubator.apache.org/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/img/apache/incubator.svg" alt="Apache Incubator Logo" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/apache/incubator.svg" alt="Apache Incubator Logo" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU"></a></div><div class="footer__copyright">
                  <div class="fs-12">
                    <div class="center-div">
                      <span>Apache Seata (incubating) is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</span>
                    </div>
                    <br>
                    <div class="center-div">
                      <span>Copyright Â© 2023-2024, The Apache Software Foundation Apache Seata, Seata, Apache, Apache Incubator, the Apache feather, the Apache Incubator logo and the Apache Seata project logo are either registered trademarks or trademarks of the Apache Software Foundation.</span>
                      <br>
                    </div>
                    <br>
                  </div>
                  </div></div></div></footer></div>
</body>
</html>