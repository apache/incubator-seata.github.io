"use strict";(self.webpackChunkseata_website=self.webpackChunkseata_website||[]).push([[56503],{87737:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>c,default:()=>u,frontMatter:()=>a,metadata:()=>r,toc:()=>l});var s=t(74848),o=t(28453);const a={title:"\u5982\u4f55\u4f7f\u7528Seata\u53d1\u9001Rocketmq\u6d88\u606f",keywords:["Seata","Rocketmq"],description:"\u8fd9\u7bc7\u6587\u7ae0\u4e3b\u8981\u4ecb\u7ecd\u4e86Seata\u5982\u4f55\u6574\u5408Rocketmq\u53d1\u9001\u6d88\u606f",author:"\u5f20\u5609\u4f1f - Seata PPMC",date:new Date("2024-10-15T00:00:00.000Z")},c=void 0,r={permalink:"/zh-cn/blog/how-to-send-message-with-rocketmq-in-seata",editUrl:"https://github.com/apache/incubator-seata-website/blob/docusaurus/i18n/zh-cn/docusaurus-plugin-content-blog/how-to-send-message-with-rocketmq-in-seata.md",source:"@site/i18n/zh-cn/docusaurus-plugin-content-blog/how-to-send-message-with-rocketmq-in-seata.md",title:"\u5982\u4f55\u4f7f\u7528Seata\u53d1\u9001Rocketmq\u6d88\u606f",description:"\u8fd9\u7bc7\u6587\u7ae0\u4e3b\u8981\u4ecb\u7ecd\u4e86Seata\u5982\u4f55\u6574\u5408Rocketmq\u53d1\u9001\u6d88\u606f",date:"2024-10-15T00:00:00.000Z",formattedDate:"2024\u5e7410\u670815\u65e5",tags:[],readingTime:5.485,hasTruncateMarker:!1,authors:[{name:"\u5f20\u5609\u4f1f - Seata PPMC"}],frontMatter:{title:"\u5982\u4f55\u4f7f\u7528Seata\u53d1\u9001Rocketmq\u6d88\u606f",keywords:["Seata","Rocketmq"],description:"\u8fd9\u7bc7\u6587\u7ae0\u4e3b\u8981\u4ecb\u7ecd\u4e86Seata\u5982\u4f55\u6574\u5408Rocketmq\u53d1\u9001\u6d88\u606f",author:"\u5f20\u5609\u4f1f - Seata PPMC",date:"2024-10-15T00:00:00.000Z"},unlisted:!1,prevItem:{title:"Go\u8bed\u8a00\u5ba2\u6237\u7aef\u4e0eSeata Server\u901a\u4fe1",permalink:"/zh-cn/blog/seata-grpc-client"},nextItem:{title:"Seata Namingserver",permalink:"/zh-cn/blog/seata-namingserver"}},i={authorsImageUrls:[void 0]},l=[{value:"\u9700\u6c42\u80cc\u666f",id:"\u9700\u6c42\u80cc\u666f",level:2},{value:"\u65b9\u6848\u8bbe\u8ba1",id:"\u65b9\u6848\u8bbe\u8ba1",level:2},{value:"\u5b9e\u73b0\u539f\u7406",id:"\u5b9e\u73b0\u539f\u7406",level:2},{value:"prepare \u65b9\u6cd5",id:"prepare-\u65b9\u6cd5",level:3},{value:"commit \u65b9\u6cd5",id:"commit-\u65b9\u6cd5",level:3},{value:"rollback \u65b9\u6cd5",id:"rollback-\u65b9\u6cd5",level:3}];function d(e){const n={code:"code",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"\u9700\u6c42\u80cc\u666f",children:"\u9700\u6c42\u80cc\u666f"}),"\n",(0,s.jsx)(n.p,{children:"\u5728\u5206\u5e03\u5f0f\u4e8b\u52a1\u4e2d\uff0c\u6211\u4eec\u7ecf\u5e38\u4f1a\u9047\u5230\u9700\u8981\u53d1\u9001\u6d88\u606f\u7684\u573a\u666f\uff0c\u6bd4\u5982\u5728\u8ba2\u5355\u652f\u4ed8\u6210\u529f\u540e\uff0c\u9700\u8981\u53d1\u9001\u6d88\u606f\u901a\u77e5\u5e93\u5b58\u670d\u52a1\u51cf\u5c11\u5e93\u5b58\u3002\n\u4f46\u662f\u5982\u4f55\u786e\u4fdd\u672c\u5730\u4e8b\u52a1\u548c\u6d88\u606f\u53d1\u9001\u7684\u4e00\u81f4\u6027\u5462\uff1f\u8fd9\u5c31\u9700\u8981\u4f7f\u7528\u5206\u5e03\u5f0f\u4e8b\u52a1\u89e3\u51b3\u65b9\u6848\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002\nSeata \u4f5c\u4e3a\u4e00\u6b3e\u5f00\u6e90\u7684\u5206\u5e03\u5f0f\u4e8b\u52a1\u89e3\u51b3\u65b9\u6848\uff0c\u63d0\u4f9b\u4e86\u5bf9 RocketMQ \u7684\u652f\u6301\uff0c\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u5728\u5206\u5e03\u5f0f\u4e8b\u52a1\u4e2d\u53d1\u9001\u6d88\u606f\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"\u65b9\u6848\u8bbe\u8ba1",children:"\u65b9\u6848\u8bbe\u8ba1"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"img.png",src:t(63545).A+"",width:"961",height:"601"})}),"\n",(0,s.jsx)(n.p,{children:"\u901a\u8fc7\u4e0a\u56fe\u6211\u4eec\u5148\u56de\u987e\u4e00\u4e0btcc\u7684\u6574\u4f53\u6d41\u7a0b"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"\u4e8b\u52a1\u7ba1\u7406\u5668\uff08TM\uff09\u53d1\u8d77\u5168\u5c40\u4e8b\u52a1"}),"\n",(0,s.jsx)(n.li,{children:"\u8d44\u6e90\u7ba1\u7406\u5668\uff08RM\uff09\u5c1d\u8bd5\u6267\u884cprepare\u65b9\u6cd5\u9884\u7559\u8d44\u6e90\u3002\u540c\u65f6\u5411\u4e8b\u52a1\u534f\u8c03\u8005(TC)\u6ce8\u518c\u5206\u652f\u4e8b\u52a1"}),"\n",(0,s.jsx)(n.li,{children:"\u82e5\u9884\u7559\u8d44\u6e90\u90fd\u6210\u529f\uff0c\u5219\u4e8b\u52a1\u7ba1\u7406\u5668\uff08TM\uff09\u8c03\u7528commit\u63d0\u4ea4\u5168\u5c40\u4e8b\u52a1\uff0c\u4e8b\u52a1\u534f\u8c03\u8005\uff08TC\uff09\u901a\u77e5\u8d44\u6e90\u7ba1\u7406\u5668\uff08RM\uff09\u63d0\u4ea4\u5206\u652f\u4e8b\u52a1"}),"\n",(0,s.jsx)(n.li,{children:"\u82e5\u9884\u7559\u8d44\u6e90\u5931\u8d25\uff0c\u5219\u4e8b\u52a1\u7ba1\u7406\u5668\uff08TM\uff09\u8c03\u7528rollback\u56de\u6eda\u5168\u5c40\u4e8b\u52a1\uff0c\u4e8b\u52a1\u534f\u8c03\u8005\uff08TC\uff09\u901a\u77e5\u8d44\u6e90\u7ba1\u7406\u5668\uff08RM\uff09\u56de\u6eda\u5206\u652f\u4e8b\u52a1"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"img.png",src:t(82968).A+"",width:"961",height:"970"})}),"\n",(0,s.jsx)(n.p,{children:"\u5728\u4e86\u89e3\u5b8ctcc\u6574\u4f53\u6d41\u7a0b\u4e4b\u540e\uff0c\u4e0a\u9762\u7684\u56fe\u5c31\u4e0d\u96be\u7406\u89e3\u4e86\uff0cSeata\u901a\u8fc7\u5bf9RocketMQ Producer\u8fdb\u884c\u4ee3\u7406\uff0c\u5b9e\u73b0\u4e86\u5f53\u4e1a\u52a1\u4ee3\u7801\u9700\u8981\u53d1\u9001\u6d88\u606f\u65f6\uff0c\n\u81ea\u52a8\u5c06\u666e\u901a\u6d88\u606f\uff0c\u8f6c\u6362\u4e3aRocketMQ\u7684\u4e8b\u52a1\u6d88\u606f\uff0c\u4ece\u800c\u4fdd\u8bc1\u4e86\u6d88\u606f\u53d1\u9001\u548c\u5206\u5e03\u5f0f\u4e8b\u52a1\u7684\u4e00\u81f4\u6027\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"\u5b9e\u73b0\u539f\u7406",children:"\u5b9e\u73b0\u539f\u7406"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"public class SeataMQProducerFactory {\n\n  public static SeataMQProducer createSingle(String nameServer, String producerGroup) throws MQClientException {\n    return createSingle(nameServer, null, producerGroup, null);\n  }\n\n  public static SeataMQProducer createSingle(String nameServer, String namespace,\n                                             String groupName, RPCHook rpcHook) throws MQClientException {\n      defaultProducer = new SeataMQProducer(namespace, groupName, rpcHook);\n      defaultProducer.start();\n      return defaultProducer;\n  }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u901a\u8fc7\u4e0a\u8ff0\u4ee3\u7801\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 SeataMQProducerFactory \u63d0\u4f9b\u4e86\u521b\u5efa SeataMQProducer \u7684\u65b9\u6cd5\uff0c\u901a\u8fc7\u8c03\u7528 createSingle \u65b9\u6cd5\uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a SeataMQProducer \u5b9e\u4f8b\u3002"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'@Override\npublic SendResult send(Message msg) throws MQClientException, MQBrokerException, RemotingException, InterruptedException {\n  return send(msg, this.getSendMsgTimeout());\n}\n\n@Override\npublic SendResult send(Message msg, long timeout) throws MQClientException, MQBrokerException, RemotingException, InterruptedException {\n  if (RootContext.inGlobalTransaction()) {\n    if (tccRocketMQ == null) {\n      throw new RuntimeException("TCCRocketMQ is not initialized");\n    }\n    return tccRocketMQ.prepare(msg, timeout);\n  } else {\n    return super.send(msg, timeout);\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u901a\u8fc7\u4e0a\u8ff0\u4ee3\u7801\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 SeataMQProducer \u91cd\u5199\u4e86 RocketMQ \u7684 send \u65b9\u6cd5\uff0c\u901a\u8fc7\u5224\u65ad\u5f53\u524d\u662f\u5426\u5904\u4e8e\u5168\u5c40\u4e8b\u52a1\u4e2d\uff0c\u6765\u51b3\u5b9a\u662f\u8c03\u7528 RocketMQ \u7684 send \u65b9\u6cd5\u8fd8\u662f\u8c03\u7528 TccRocketMQ \u7684 prepare \u65b9\u6cd5\u3002\n\u5982\u679c\u53d1\u9001\u6d88\u606f\u65f6\uff0c\u672a\u53c2\u4e0e\u5168\u5c40\u4e8b\u52a1\uff0c\u5219\u964d\u7ea7\u4e3a\u8c03\u7528 RocketMQ \u7684 send \u65b9\u6cd5\u53d1\u9001\u6d88\u606f\u3002"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'@LocalTCC\npublic class TCCRocketMQImpl implements TCCRocketMQ {\n\n  @Override\n  @TwoPhaseBusinessAction(name = SeataMQProducerFactory.ROCKET_TCC_NAME)\n  public SendResult prepare(Message message, long timeout) throws MQClientException {\n    BusinessActionContext context = BusinessActionContextUtil.getContext();\n    LOGGER.info("RocketMQ message send prepare, xid = {}", context.getXid());\n    Map<String, Object> params = new HashMap<>(8);\n    SendResult sendResult = producer.doSendMessageInTransaction(message, timeout, context.getXid(), context.getBranchId());\n    message.setDeliverTimeMs(0);\n    params.put(ROCKET_MSG_KEY, message);\n    params.put(ROCKET_SEND_RESULT_KEY, sendResult);\n    BusinessActionContextUtil.addContext(params);\n    return sendResult;\n  }\n\n  @Override\n  public boolean commit(BusinessActionContext context)\n    throws UnknownHostException, MQBrokerException, RemotingException, InterruptedException, TimeoutException, TransactionException {\n    Message message = context.getActionContext(ROCKET_MSG_KEY, Message.class);\n    SendResult sendResult = context.getActionContext(ROCKET_SEND_RESULT_KEY, SendResult.class);\n    if (message == null || sendResult == null) {\n      throw new TransactionException("TCCRocketMQ commit but cannot find message and sendResult");\n    }\n    this.producerImpl.endTransaction(message, sendResult, LocalTransactionState.COMMIT_MESSAGE, null);\n    LOGGER.info("RocketMQ message send commit, xid = {}, branchId = {}", context.getXid(), context.getBranchId());\n    return true;\n  }\n\n  @Override\n  public boolean rollback(BusinessActionContext context)\n    throws UnknownHostException, MQBrokerException, RemotingException, InterruptedException, TransactionException {\n    Message message = context.getActionContext(ROCKET_MSG_KEY, Message.class);\n    SendResult sendResult = context.getActionContext(ROCKET_SEND_RESULT_KEY, SendResult.class);\n    if (message == null || sendResult == null) {\n      LOGGER.error("TCCRocketMQ rollback but cannot find message and sendResult");\n    }\n    this.producerImpl.endTransaction(message, sendResult, LocalTransactionState.ROLLBACK_MESSAGE, null);\n    LOGGER.info("RocketMQ message send rollback, xid = {}, branchId = {}", context.getXid(), context.getBranchId());\n    return true;\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u53ef\u4ee5\u770b\u5230TCCRocketMQImpl\u5b9e\u73b0\u4e86TCCRocketMQ\u63a5\u53e3\uff0c\u540c\u65f6\u4f7f\u7528\u4e86@LocalTCC\u548c@TwoPhaseBusinessAction\u6ce8\u89e3\uff0c\n\u8fd9\u8868\u660e\u4e86TCCRocketMQImpl\u4e5f\u662f\u4e00\u4e2aTCC\u7684\u5206\u652f\u4e8b\u52a1\uff0c\u5e76\u901a\u8fc7prepare\u3001commit\u3001rollback\u65b9\u6cd5\u5b9e\u73b0\u4e86TCC\u4e8b\u52a1\u7684\u4e09\u4e2a\u573a\u666f\u3002"}),"\n",(0,s.jsx)(n.h3,{id:"prepare-\u65b9\u6cd5",children:"prepare \u65b9\u6cd5"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'@TwoPhaseBusinessAction(name = SeataMQProducerFactory.ROCKET_TCC_NAME)\npublic SendResult prepare(Message message, long timeout) throws MQClientException {\n  BusinessActionContext context = BusinessActionContextUtil.getContext();\n  LOGGER.info("RocketMQ message send prepare, xid = {}", context.getXid());\n  Map<String, Object> params = new HashMap<>(8);\n  SendResult sendResult = producer.doSendMessageInTransaction(message, timeout, context.getXid(), context.getBranchId());\n  message.setDeliverTimeMs(0);\n  params.put(ROCKET_MSG_KEY, message);\n  params.put(ROCKET_SEND_RESULT_KEY, sendResult);\n  BusinessActionContextUtil.addContext(params);\n  return sendResult;\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u5728 prepare \u65b9\u6cd5\u4e2d\uff0c\u6211\u4eec\u901a\u8fc7\u8c03\u7528 producer.doSendMessageInTransaction \u65b9\u6cd5\u53d1\u9001\u534a\u4e8b\u52a1\u6d88\u606f\uff0c\u5e76\u5c06\u6d88\u606f\u548c\u53d1\u9001\u7ed3\u679c\u4fdd\u5b58\u5230 BusinessActionContext \u4e2d\u3002"}),"\n",(0,s.jsx)(n.h3,{id:"commit-\u65b9\u6cd5",children:"commit \u65b9\u6cd5"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'@Override\npublic boolean commit(BusinessActionContext context)\n  throws UnknownHostException, MQBrokerException, RemotingException, InterruptedException, TimeoutException, TransactionException {\n  Message message = context.getActionContext(ROCKET_MSG_KEY, Message.class);\n  SendResult sendResult = context.getActionContext(ROCKET_SEND_RESULT_KEY, SendResult.class);\n  if (message == null || sendResult == null) {\n    throw new TransactionException("TCCRocketMQ commit but cannot find message and sendResult");\n  }\n  this.producerImpl.endTransaction(message, sendResult, LocalTransactionState.COMMIT_MESSAGE, null);\n  LOGGER.info("RocketMQ message send commit, xid = {}, branchId = {}", context.getXid(), context.getBranchId());\n  return true;\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u5728 commit \u65b9\u6cd5\u4e2d\uff0c\u6211\u4eec\u901a\u8fc7\u8c03\u7528 producerImpl.endTransaction \u65b9\u6cd5\u63d0\u4ea4\u4e8b\u52a1\u6d88\u606f\u3002"}),"\n",(0,s.jsx)(n.h3,{id:"rollback-\u65b9\u6cd5",children:"rollback \u65b9\u6cd5"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'@Override\npublic boolean rollback(BusinessActionContext context)\n  throws UnknownHostException, MQBrokerException, RemotingException, InterruptedException, TransactionException {\n  Message message = context.getActionContext(ROCKET_MSG_KEY, Message.class);\n  SendResult sendResult = context.getActionContext(ROCKET_SEND_RESULT_KEY, SendResult.class);\n  if (message == null || sendResult == null) {\n    LOGGER.error("TCCRocketMQ rollback but cannot find message and sendResult");\n  }\n  this.producerImpl.endTransaction(message, sendResult, LocalTransactionState.ROLLBACK_MESSAGE, null);\n  LOGGER.info("RocketMQ message send rollback, xid = {}, branchId = {}", context.getXid(), context.getBranchId());\n  return true;\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u5728 rollback \u65b9\u6cd5\u4e2d\uff0c\u6211\u4eec\u901a\u8fc7\u8c03\u7528 producerImpl.endTransaction \u65b9\u6cd5\u56de\u6eda\u4e8b\u52a1\u6d88\u606f\u3002"})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},82968:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/seata-rocketmq-25b9bb3596cd5dc85e31d59d4cee8cd4.png"},63545:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/tcc-mode-0fb5bbf99b58538d120d7d355ae0eee3.png"},28453:(e,n,t)=>{t.d(n,{R:()=>c,x:()=>r});var s=t(96540);const o={},a=s.createContext(o);function c(e){const n=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:c(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);